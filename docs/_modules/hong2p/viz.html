

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>hong2p.viz &mdash; hong2p 0.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> hong2p
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/modules.html">hong2p</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hong2p</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>hong2p.viz</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hong2p.viz</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions for visualizing movies / cells / extracted traces, some intended to</span>
<span class="sd">provide context specfically useful for certain types of olfaction experiments.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">linkage</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">hong2p</span> <span class="kn">import</span> <span class="n">util</span><span class="p">,</span> <span class="n">thor</span><span class="p">,</span> <span class="n">olf</span>
<span class="kn">from</span> <span class="nn">hong2p.types</span> <span class="kn">import</span> <span class="n">DataFrameOrDataArray</span>


<span class="c1"># TODO consider making a style sheet as in:</span>
<span class="c1"># https://matplotlib.org/stable/tutorials/introductory/customizing.html?highlight=style%20sheets</span>

<span class="c1"># TODO use this other places that redefine, now that it&#39;s module-level</span>
<span class="n">dff_latex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\Delta F/F$&#39;</span>

<span class="c1"># TODO machinery to register combinations of level names -&gt; how they should be formatted</span>
<span class="c1"># into str labels for matshow (e.g. (&#39;odor1&#39;,&#39;odor2&#39;) -&gt; olf.format_mix_from_strs)?</span>
<span class="c1"># TODO and like to set default cmap(s)?</span>


<span class="c1"># TODO change docstring to indicate rowlabel_fn should take a pd.Series, if that is</span>
<span class="c1"># always correct (for multiindex / not input, etc)</span>
<div class="viewcode-block" id="matlabels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.matlabels">[docs]</a><span class="k">def</span> <span class="nf">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rowlabel_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">):</span>
    <span class="c1"># TODO should i modify so it takes an Index/MultiIndex rather than a DataFrame row?</span>
    <span class="c1"># what would make these functions more natural to write?</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes DataFrame and function that takes one row of index to a label.</span>

<span class="sd">    `rowlabel_fn` should take a DataFrame row (w/ columns from index) to a str.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO move to something like util._validate_axis?</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;columns&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis must be either &#39;index&#39; or &#39;columns&#39;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rowlabel_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>


<span class="c1"># TODO should i thread delim kwarg to default fn thru here (e.g. just threading all</span>
<span class="c1"># kwargs through to label_fn)?</span>
<div class="viewcode-block" id="row_labels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.row_labels">[docs]</a><span class="k">def</span> <span class="nf">row_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="col_labels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.col_labels">[docs]</a><span class="k">def</span> <span class="nf">col_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="format_index_row"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.format_index_row">[docs]</a><span class="k">def</span> <span class="nf">format_index_row</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">delim</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; / &#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes Series to a str with the concatenated values, separated by `delim`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">])</span></div>


<span class="c1"># TODO rename to indicate xarray coersion (/ move that to a separate decorator called</span>
<span class="c1"># first?)?</span>
<span class="c1"># TODO specify plot_fn must take a df (maybe also numpy?) input (via type hinting)?</span>
<span class="c1"># TODO TODO add kwarg to wrapped fns that allows specifying axes that are supposed to</span>
<span class="c1"># include odor mixture metadata (or maybe more generally some minimum set of index</span>
<span class="c1"># levels, defined by matching some filtering fn?), to enforce (and maybe automatically</span>
<span class="c1"># convert for some types of input) that we have DataFrame / (especially) DataArray</span>
<span class="c1"># indices set correctly before calling the wrapped fn</span>
<span class="c1"># TODO also provide a means of specifying the dimension of input the fns expect (at</span>
<span class="c1"># least squeezed dimension, maybe w/ a squeeze=True kwarg added by wrapper?)</span>
<div class="viewcode-block" id="callable_ticklabels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.callable_ticklabels">[docs]</a><span class="k">def</span> <span class="nf">callable_ticklabels</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">):</span>
    <span class="c1"># TODO still true that fn must accept [x|y]ticklabels? change doc if not.</span>
    <span class="sd">&quot;&quot;&quot;Allows [x/y]ticklabel functions evaluated on indices of `df` (`plot_fn(df, ...)`)</span>

<span class="sd">    First parameter to `plot_fn` must be a `pandas.DataFrame` (or `xarray.DataArray`</span>
<span class="sd">    convertable to one) to compute the `str` ticklabels from. `plot_fn` must also accept</span>
<span class="sd">    the kwargs &#39;[x|y]ticklabels&#39;.</span>

<span class="sd">    If the input to the decorated function is a `xarray.DataArray`, the decorated</span>
<span class="sd">    function will receive a `DataFrame` (created via `arr.to_pandas()`) as input</span>
<span class="sd">    instead. Note that only &#39;dimension coordinates&#39; (see xarray terminology page) are</span>
<span class="sd">    preserved when converting from `DataArray` to `DataFrame`, so use</span>
<span class="sd">    `&lt;arr&gt;.set_index(&lt;dimension name&gt;=...)` appropriately before passing the array to a</span>
<span class="sd">    wrapped function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_check_bools</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes True equivalent to passing str, and False equivalent to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ticklabels</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># TODO TODO probably also default to this in case ticklabels=None</span>
            <span class="c1"># (might just need to modify some of the calling code)</span>
            <span class="k">return</span> <span class="n">format_index_row</span>

        <span class="k">elif</span> <span class="n">ticklabels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># TODO delete after checking code that could be affected to see if it trips.</span>
        <span class="c1">#</span>
        <span class="c1"># I.e. if it is specifically the callable `str`, which I had sometimes used for</span>
        <span class="c1"># single level indices in the past, but have encountered issues with and made</span>
        <span class="c1"># `format_index_row` to replace.</span>
        <span class="k">elif</span> <span class="n">ticklabels</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;replace usage of str with hong2p.viz.format_index_row&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ticklabels</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ticklabels</span>

    <span class="c1"># TODO should this also include numpy.ndarray subclasses in input types?</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped_plot_fn</span><span class="p">(</span><span class="n">df_or_arr</span><span class="p">:</span> <span class="n">DataFrameOrDataArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_or_arr</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="c1"># Requires df_or_arr to be &lt;=2d</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df_or_arr</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df_or_arr</span>

        <span class="k">if</span> <span class="s1">&#39;xticklabels&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">_check_bools</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xticklabels&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">xticklabels</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;yticklabels&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">_check_bools</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;yticklabels&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;yticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yticklabels</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapped_plot_fn</span></div>


<span class="c1"># Was originally wanting to make enable a kwarg, but it seems the code to do that would</span>
<span class="c1"># be excessively complicated. See norok2&#39;s answer here:</span>
<span class="c1"># https://stackoverflow.com/questions/5929107</span>
<span class="k">def</span> <span class="nf">_mpl_constrained_layout</span><span class="p">(</span><span class="n">enable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To make decorators for fns that create Figure(s) and need contrained layout on/off.</span>

<span class="sd">    Use `@constrained_layout` or `@no_constrained_layout` rather than this directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrap_plot_fn</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            plot_fn: must make figure from start to finish inside, so changing</span>
<span class="sd">                constrained layout setting works</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapped_plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s1">&#39;figure.constrained_layout.use&#39;</span><span class="p">:</span> <span class="n">enable</span><span class="p">}):</span>
                <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped_plot_fn</span>

    <span class="k">return</span> <span class="n">wrap_plot_fn</span>


<span class="n">constrained_layout</span> <span class="o">=</span> <span class="n">_mpl_constrained_layout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">no_constrained_layout</span> <span class="o">=</span> <span class="n">_mpl_constrained_layout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># TODO maybe combine w/ decorator to add title/xlabel/ylabel/etc kwargs + their</span>
<span class="c1"># reformatting (+ setting? some differences in how i do this, and would need Axes to</span>
<span class="c1"># call on...)</span>
<span class="k">def</span> <span class="nf">_ylabel_kwargs</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">ylabel_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Will no longer have same behavior as passing rotation=None explicitly to the</span>
    <span class="c1"># corresponding set_ylabel call, but would need another sentinel for unset</span>
    <span class="c1"># values than None to fix.</span>
    <span class="k">if</span> <span class="n">ylabel_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ylabel_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ylabel_rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ylabel_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;ylabel_rotation&#39;</span> <span class="ow">in</span> <span class="n">ylabel_kws</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;only specify either ylabel_rotation or &#39;</span>
                <span class="s2">&quot;ylabel_kws[&#39;rotation&#39;]&quot;</span>
            <span class="p">)</span>

        <span class="n">ylabel_kws</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ylabel_rotation</span>

    <span class="k">return</span> <span class="n">ylabel_kws</span>


<span class="n">_panel2order</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="set_panel2order"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.set_panel2order">[docs]</a><span class="k">def</span> <span class="nf">set_panel2order</span><span class="p">(</span><span class="n">panel2order</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Sets module-level dict mapping panels to order for plotting odors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_panel2order</span>
    <span class="n">_panel2order</span> <span class="o">=</span> <span class="n">panel2order</span></div>


<span class="n">_ax_id2order</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="c1"># TODO kwarg for specifying name of odor column?</span>
<div class="viewcode-block" id="with_panel_orders"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.with_panel_orders">[docs]</a><span class="k">def</span> <span class="nf">with_panel_orders</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">,</span> <span class="n">panel2order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">fn_kwargs</span><span class="p">):</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ordered_plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># If this fails, see code I adapted this from in</span>
        <span class="c1"># kc_natural_mixes/kc_mix_analysis.py</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;expected .map/.map_dataframe to pass all via **kwargs&#39;</span>

        <span class="k">nonlocal</span> <span class="n">panel2order</span>
        <span class="k">if</span> <span class="n">panel2order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">panel2order</span> <span class="o">=</span> <span class="n">_panel2order</span>

        <span class="k">if</span> <span class="n">panel2order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must either pass panel2order keyword argument, or call &#39;</span>
                <span class="s1">&#39;hong2p.viz.set_panel2order&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;use map_dataframe rather than map&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">fk</span><span class="p">,</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">fn_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">fk</span><span class="p">]</span> <span class="o">=</span> <span class="n">fv</span>

        <span class="c1"># TODO add unit test for this</span>
        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;when calling </span><span class="si">{</span><span class="n">plot_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> wrapped with &#39;</span>
                <span class="s1">&#39;with_panel_orders, pass panel2order to wrapper or use &#39;</span>
                <span class="s1">&#39;hong2p.viz.set_panel2order. do NOT pass order keyword argument &#39;</span>
                <span class="s1">&#39;to the wrapped function.&#39;</span>
            <span class="p">)</span>

        <span class="n">panels</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;panel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;each call to wrapped plot function must present data &#39;</span>
                <span class="s1">&#39;from a single panel&#39;</span>
            <span class="p">)</span>
        <span class="n">panel</span> <span class="o">=</span> <span class="n">panels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">panel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">panel2order</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">panel</span><span class="si">=}</span><span class="s1"> was not in </span><span class="si">{</span><span class="n">panel2order</span><span class="si">=}</span><span class="s1"> keys&#39;</span><span class="p">)</span>

        <span class="n">odor_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">data_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>

        <span class="n">odors</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">odor_col</span><span class="p">]</span>

        <span class="n">order</span> <span class="o">=</span> <span class="n">panel2order</span><span class="p">[</span><span class="n">panel</span><span class="p">]</span>

        <span class="c1"># It would be nice if I could just pass a panel2order dict in that worked if the</span>
        <span class="c1"># values were just the names of odors (sorting naturally on concentration), but</span>
        <span class="c1"># I don&#39;t see an easy way to do it, as `df` may contain different subsets of the</span>
        <span class="c1"># data across calls to wrapped plot functions.</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">o</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">odors</span><span class="p">])</span>

        <span class="c1"># TODO TODO TODO do i need to ensure that all the odors in the order are</span>
        <span class="c1"># present? data association getting broken yet?</span>

        <span class="c1"># TODO delete after some testing</span>
        <span class="c1"># TODO TODO TODO TODO confirm it is not a problem that this was failing</span>
        <span class="c1"># (i think there might be a containing axes object that is getting picked up?</span>
        <span class="c1"># not sure there is a mechanism to get most specific underlying one though...)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        ax_id = id(plt.gca())</span>
<span class="sd">        if ax_id in _ax_id2order:</span>
<span class="sd">            prev_order = _ax_id2order[ax_id]</span>
<span class="sd">            assert order == prev_order, \</span>
<span class="sd">                f&#39;previous order: {prev_order}\ncurrent order: {order}&#39;</span>
<span class="sd">        else:</span>
<span class="sd">            _ax_id2order[ax_id] = order</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>

        <span class="c1"># TODO TODO TODO do i need to deal with hues? (to keep consistent across</span>
        <span class="c1"># panels...) or does FacetGrid have me covered on that?</span>

        <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ordered_plot_fn</span></div>


<div class="viewcode-block" id="clustermap"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.clustermap">[docs]</a><span class="nd">@no_constrained_layout</span>
<span class="nd">@callable_ticklabels</span>
<span class="c1"># TODO TODO do [x|y]ticklabels now need to be extracted from kwargs? if seaborn doesn&#39;t</span>
<span class="c1"># handle that, then the @callable_ticklabels decorator is doing nothing here.</span>
<span class="k">def</span> <span class="nf">clustermap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">optimal_ordering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">row_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row_linkage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_linkage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">z_score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">standard_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Same as seaborn.clustermap but allows callable [x/y]ticklabels + adds opts.</span>

<span class="sd">    Adds `optimal_ordering` kwarg to `scipy.cluster.hierarchy.linkage` that is not</span>
<span class="sd">    exposed by seaborn version.</span>

<span class="sd">    Also turns off constrained layout for the duration of the seaborn function, to</span>
<span class="sd">    prevent warnings + disabling that would otherwise happen.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">row_linkage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># seaborn will just show a subset of the data if passed a linkage of a smaller</span>
        <span class="c1"># shape. Not sure what happens in reverse case. Either way, I think failing</span>
        <span class="c1"># is safer.</span>
        <span class="n">expected_row_linkage_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row_linkage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_row_linkage_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;row_linkage.shape must be </span><span class="si">{</span><span class="n">expected_row_linkage_shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">col_linkage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expected_col_linkage_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_linkage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_col_linkage_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;col_linkage.shape must be </span><span class="si">{</span><span class="n">expected_col_linkage_shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">valid_preproc_kw_values</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">z_score</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_preproc_kw_values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;z_score must be in </span><span class="si">{</span><span class="n">valid_preproc_kw_values</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">standard_scale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_preproc_kw_values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;standard_scale must be in </span><span class="si">{</span><span class="n">valid_preproc_kw_values</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cbar_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cbar_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cbar_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">cbar_kws</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbar_label</span>

    <span class="k">if</span> <span class="n">z_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">standard_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;disabling optimal_ordering since z_score or standard_scale&#39;</span><span class="p">)</span>
        <span class="n">optimal_ordering</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_score</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;standard_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standard_scale</span>

    <span class="c1"># TODO if z-scoring / standard-scaling requested, calculate before in this case</span>
    <span class="c1"># (so it actually affects linkage, as it would w/ seaborn version)</span>
    <span class="c1"># (currently just disabling optimal ordering in these cases)</span>
    <span class="k">if</span> <span class="n">optimal_ordering</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_linkage</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">linkage</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">optimal_ordering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="n">metric</span>
            <span class="p">)</span>

        <span class="c1"># This behavior of when to transpose for which linkage is consistent w/ seaborn</span>
        <span class="c1"># (I read clustermap implementation)</span>

        <span class="k">if</span> <span class="n">row_cluster</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row_linkage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;can not pass row_linkage if using &#39;</span>
                    <span class="s1">&#39;optimal_ordering=True&#39;</span>
                <span class="p">)</span>

            <span class="n">row_linkage</span> <span class="o">=</span> <span class="n">_linkage</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">col_cluster</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_linkage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;can not pass col_linkage if using &#39;</span>
                    <span class="s1">&#39;optimal_ordering=True&#39;</span>
                <span class="p">)</span>

            <span class="n">col_linkage</span> <span class="o">=</span> <span class="n">_linkage</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">clustergrid</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">row_cluster</span><span class="o">=</span><span class="n">row_cluster</span><span class="p">,</span> <span class="n">col_cluster</span><span class="o">=</span><span class="n">col_cluster</span><span class="p">,</span>
        <span class="n">row_linkage</span><span class="o">=</span><span class="n">row_linkage</span><span class="p">,</span> <span class="n">col_linkage</span><span class="o">=</span><span class="n">col_linkage</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
        <span class="n">cbar_kws</span><span class="o">=</span><span class="n">cbar_kws</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clustergrid</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This will overwrite whatever labels the seaborn call slaps on</span>
        <span class="n">clustergrid</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ylabel_kws</span> <span class="o">=</span> <span class="n">_ylabel_kwargs</span><span class="p">(</span>
            <span class="n">ylabel_rotation</span><span class="o">=</span><span class="n">ylabel_rotation</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="n">ylabel_kws</span>
        <span class="p">)</span>
        <span class="n">clustergrid</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="o">**</span><span class="n">ylabel_kws</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clustergrid</span></div>


<span class="c1"># TODO consider calling sns.heatmap internally? or replacing some uses of this w/ that?</span>
<span class="c1"># TODO may want to add xlabel / ylabel kwargs to be consistent w/ my clustermap wrapper,</span>
<span class="c1"># but then again i&#39;m currently using xlabel for a &quot;title&quot; here...</span>
<span class="c1"># TODO do any uses of this actually use the returned `im` (output of plt.matshow)?</span>
<span class="c1"># if not, maybe delete?</span>
<div class="viewcode-block" id="matshow"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.matshow">[docs]</a><span class="nd">@constrained_layout</span>
<span class="nd">@callable_ticklabels</span>
<span class="k">def</span> <span class="nf">matshow</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ticklabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xtickrotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_ticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fontweight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose_sort_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cbar_shrink</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        transpose_sort_key (None | function): takes df.index/df.columns and compares</span>
<span class="sd">            output to decide whether matrix should be transposed before plotting</span>

<span class="sd">        **kwargs: passed thru to `matplotlib.pyplot.matshow`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO shouldn&#39;t this get ticklabels from matrix if nothing else?</span>
    <span class="c1"># maybe at least in the case when both columns and row indices are all just</span>
    <span class="c1"># one level of strings?</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;figsize only allowed if ax not passed in&#39;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

    <span class="c1"># NOTE: if i&#39;d like to also sort on [x/y]ticklabels, would need to move this block</span>
    <span class="c1"># after possible ticklabel enumeration, and then assign correctly to index/cols and</span>
    <span class="c1"># use that as input to sort_key_val in appropriate instead</span>
    <span class="k">if</span> <span class="n">transpose_sort_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ticklabels</span><span class="p">,</span> <span class="n">xticklabels</span><span class="p">,</span> <span class="n">yticklabels</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;transpose_sort_key not supported if any &#39;</span>
                <span class="s1">&#39;ticklabels are explicitly passed&#39;</span>
            <span class="p">)</span>

        <span class="n">row_sort_key</span> <span class="o">=</span> <span class="n">transpose_sort_key</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">col_sort_key</span> <span class="o">=</span> <span class="n">transpose_sort_key</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">row_sort_key</span> <span class="o">&gt;</span> <span class="n">col_sort_key</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># TODO can probably delete this and replace w/ usage of format_index_row, maybe with</span>
    <span class="c1"># some slight modifications</span>
    <span class="k">def</span> <span class="nf">is_one_level_str_index</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">xticklabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yticklabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ticklabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO maybe default to joining str representations of values at each level,</span>
            <span class="c1"># joined on some kwarg delim like &#39;/&#39;?</span>
            <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">is_one_level_str_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">is_one_level_str_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO TODO assert indices are actually equal</span>
            <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">):</span>
                <span class="n">ticklabels</span> <span class="o">=</span> <span class="n">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ticklabels</span><span class="p">)</span>

            <span class="c1"># TODO should i check output is same on rows/cols in this case?</span>
            <span class="c1"># currently, matlabels seems to just operate on the row labels...</span>
            <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">ticklabels</span>
            <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">ticklabels</span>

    <span class="c1"># TODO update this formula to work w/ gui corrs (too big now)</span>
    <span class="c1"># TODO see whether default font actually is inappropriate in any cases where i&#39;m</span>
    <span class="c1"># currently calling this (particularly using constrained layout from</span>
    <span class="c1"># al_analysis.py)</span>
    <span class="k">if</span> <span class="n">fontsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">240.0</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cbar_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cbar_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># rotation=270?</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">add_colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="n">cbar_shrink</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">grouped_labels_info</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group_ticklabels</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">n_repeats</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>

        <span class="c1"># TODO TODO assert same # things from each unique element.</span>
        <span class="c1"># that&#39;s what this whole tickstep thing seems to assume.</span>

        <span class="c1"># Assumes order is preserved if labels are grouped at input.</span>
        <span class="c1"># May need to calculate some other way if not always true.</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">tick_step</span> <span class="o">=</span> <span class="n">n_repeats</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">n_repeats</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="n">tick_step</span><span class="p">,</span> <span class="n">offset</span>

    <span class="c1"># TODO automatically only group labels in case where all repeats are</span>
    <span class="c1"># adjacent?</span>
    <span class="c1"># TODO make fontsize / weight more in group_ticklabels case?</span>
    <span class="n">xticklabels</span><span class="p">,</span> <span class="n">xstep</span><span class="p">,</span> <span class="n">xoffset</span> <span class="o">=</span> <span class="n">grouped_labels_info</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">)</span>
    <span class="n">yticklabels</span><span class="p">,</span> <span class="n">ystep</span><span class="p">,</span> <span class="n">yoffset</span> <span class="o">=</span> <span class="n">grouped_labels_info</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xticklabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO nan / None value aren&#39;t supported in ticklabels are they?</span>
        <span class="c1"># (couldn&#39;t assume len is defined if so)</span>
        <span class="k">if</span> <span class="n">xtickrotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xticklabels</span><span class="p">]):</span>
                <span class="n">xtickrotation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xtickrotation</span> <span class="o">=</span> <span class="s1">&#39;vertical&#39;</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">xstep</span><span class="p">)</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span>
            <span class="n">xticklabels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="n">fontweight</span><span class="p">,</span>
            <span class="n">rotation</span><span class="o">=</span><span class="n">xtickrotation</span>
        <span class="c1">#    rotation=&#39;horizontal&#39; if group_ticklabels else &#39;vertical&#39;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">yticklabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">ystep</span><span class="p">)</span> <span class="o">+</span> <span class="n">yoffset</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
            <span class="n">yticklabels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="n">fontweight</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span>
        <span class="c1">#    rotation=&#39;vertical&#39; if group_ticklabels else &#39;horizontal&#39;</span>
        <span class="p">)</span>

    <span class="c1"># TODO test this doesn&#39;t change rotation if we just set rotation above</span>

    <span class="c1"># this doesn&#39;t seem like it will work, since it seems to clear the default</span>
    <span class="c1"># ticklabels that there actually were...</span>
    <span class="c1">#ax.set_yticklabels(ax.get_yticklabels(), fontsize=fontsize,</span>
    <span class="c1">#    fontweight=fontweight</span>
    <span class="c1">#)</span>

    <span class="c1"># didn&#39;t seem to do what i was expecting</span>
    <span class="c1">#ax.spines[&#39;bottom&#39;].set_visible(False)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">),</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ylabel_kws</span> <span class="o">=</span> <span class="n">_ylabel_kwargs</span><span class="p">(</span>
            <span class="n">ylabel_rotation</span><span class="o">=</span><span class="n">ylabel_rotation</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="n">ylabel_kws</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">),</span> <span class="o">**</span><span class="n">ylabel_kws</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">im</span></div>


<div class="viewcode-block" id="imshow"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.imshow">[docs]</a><span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="add_colorbar"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.add_colorbar">[docs]</a><span class="k">def</span> <span class="nf">add_colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        shrink: same default as matplotlib</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO check whether kwargs `label=label` to fig.colorbar can replace</span>
    <span class="c1"># cbar.ax.set_ylabel. i think so, but poorly documented.</span>

    <span class="c1"># I think this relies on use of Matplotlib&#39;s constrained layout</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="n">shrink</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cbar</span></div>


<div class="viewcode-block" id="image_grid"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.image_grid">[docs]</a><span class="k">def</span> <span class="nf">image_grid</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">**</span><span class="n">imshow_kwargs</span><span class="p">):</span>
    <span class="c1"># TODO see: https://stackoverflow.com/questions/42850225 or related to find a</span>
    <span class="c1"># good solution for reliably eliminating all unwanted whitespace between subplots</span>
    <span class="c1"># (honestly i think it will ultimately come down to figsize, potentially more so</span>
    <span class="c1"># when using constrained layout, as i&#39;d now generally like to)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">))))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">image_list</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">imshow_kwargs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="c1"># TODO should i actually compute correlations in here too? check input, and</span>
<span class="c1"># compute if input wasn&#39;t correlations (/ symmetric?)?</span>
<span class="c1"># if so, probably return them as well.</span>
<div class="viewcode-block" id="plot_odor_corrs"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_odor_corrs">[docs]</a><span class="k">def</span> <span class="nf">plot_odor_corrs</span><span class="p">(</span><span class="n">corr_df</span><span class="p">,</span> <span class="n">odor_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">odors_in_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">trial_stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">title_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a symmetric DataFrame with odor x odor correlations and plots it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO replace ordering stuff w/ new fns for that in olf.py (or maybe just delete</span>
    <span class="c1"># all of plot_odor_corrs if not using...)</span>

    <span class="c1"># TODO test this fn w/ possible missing data case.</span>
    <span class="c1"># bring guis support for that in here?</span>
    <span class="k">if</span> <span class="n">odors_in_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">odor_order</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">odor_order</span><span class="p">:</span>
        <span class="c1"># &#39;name2&#39; is just &#39;no_second_odor&#39; for a lot of my data</span>
        <span class="c1"># (the non-pair stuff)</span>
        <span class="n">name_prefix</span> <span class="o">=</span> <span class="s1">&#39;name1&#39;</span>

        <span class="c1"># TODO probably refactor the two duped things below</span>
        <span class="n">odor_name_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name_prefix</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">odor_name_rows</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;expected the name of exactly one index level to &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;start with </span><span class="si">{</span><span class="n">name_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="n">odor_name_row</span> <span class="o">=</span> <span class="n">odor_name_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">odor_name_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name_prefix</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">odor_name_cols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;expected the name of exactly one column level to &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;start with </span><span class="si">{</span><span class="n">name_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="n">odor_name_col</span> <span class="o">=</span> <span class="n">odor_name_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="c1"># Necessary to avoid this error:</span>
            <span class="c1"># KeyError: &#39;Requested level...does not match index name (None)&#39;</span>
            <span class="n">odor_name_row</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">odor_name_col</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">corr_df</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">odors_in_order</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">odor_name_row</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">odors_in_order</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">odor_name_col</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">odors_in_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO </span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="s1">&#39;group_ticklabels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;group_ticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">corr_df</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Odor&#39;</span> <span class="k">if</span> <span class="n">odor_order</span> <span class="k">else</span> <span class="s1">&#39;Presentation&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; order&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">title_suffix</span>

    <span class="k">if</span> <span class="s1">&#39;ticklabels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">format_mixture</span>

    <span class="k">if</span> <span class="s1">&#39;cbar_label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># TODO factor out latex for delta f / f stuff (+ maybe use in analysis that uses</span>
        <span class="c1"># this pkg: kc_natural_mixes, al_analysis)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cbar_label&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">trial_stat</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; response </span><span class="si">{</span><span class="n">dff_latex</span><span class="si">}</span><span class="s1"> correlation&#39;</span>

    <span class="k">return</span> <span class="n">matshow</span><span class="p">(</span><span class="n">corr_df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># TODO get x / y from whether they were declared share&lt;x/y&gt; in facetgrid</span>
<span class="c1"># creation?</span>
<div class="viewcode-block" id="fix_facetgrid_axis_labels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.fix_facetgrid_axis_labels">[docs]</a><span class="k">def</span> <span class="nf">fix_facetgrid_axis_labels</span><span class="p">(</span><span class="n">facet_grid</span><span class="p">,</span> <span class="n">shared_in_center</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Modifies a FacetGrid to not duplicate X and Y axis text labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># regarding the choice of shared_in_center: WWMDD?</span>
    <span class="k">if</span> <span class="n">shared_in_center</span><span class="p">:</span>
        <span class="c1"># TODO maybe add a axes over / under the FacetGrid axes, with the same</span>
        <span class="c1"># shape, and label that one (i think i did this in my gui or one of the</span>
        <span class="c1"># plotting fns. maybe plot_traces?)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">facet_grid</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">is_first_col</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_last_row</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">y</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_facetgrid_legend"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.set_facetgrid_legend">[docs]</a><span class="k">def</span> <span class="nf">set_facetgrid_legend</span><span class="p">(</span><span class="n">facet_grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In cases where different axes have different subsets of the hue levels,</span>
<span class="sd">    the legend may not contain the artists for the union of hue levels across</span>
<span class="sd">    all axes. This sets a legend from the hue artists across all axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#from matplotlib.collections import PathCollection</span>
    <span class="n">legend_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">facet_grid</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">):</span>
            <span class="c1">#if type(h) is PathCollection:</span>
            <span class="c1"># From inspecting facet_grid._legend_data in cases where some labels</span>
            <span class="c1"># pointed to empty lines (the phenotype in the case where things</span>
            <span class="c1"># weren&#39;t behaving as I wanted), the empty lines had this empty</span>
            <span class="c1"># facecolor.</span>
            <span class="n">facecolor</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">facecolor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1">#else:</span>
            <span class="c1">#    print(type(h))</span>
            <span class="c1">#    import ipdb; ipdb.set_trace()</span>

            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_data</span><span class="p">:</span>
                <span class="c1"># TODO maybe assert a wide variety of properties of the</span>
                <span class="c1"># matplotlib.collections.PathCollection objects are the same</span>
                <span class="c1"># (line width, dash, etc)</span>
                <span class="n">past_facecolor</span> <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">()</span>
                <span class="c1"># TODO TODO TODO fix! this is failing again 2020-08-25</span>
                <span class="c1"># (after re-installing requirements.txt, when running</span>
                <span class="c1"># kc_mix_analysis.py w/ no just -j arg)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">past_facecolor</span><span class="p">),</span> \
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">facecolor</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">past_facecolor</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">legend_data</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>

    <span class="n">facet_grid</span><span class="o">.</span><span class="n">add_legend</span><span class="p">(</span><span class="n">legend_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># TODO generalize / move to project specific repo</span>
<div class="viewcode-block" id="plot_traces"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_traces">[docs]</a><span class="k">def</span> <span class="nf">plot_traces</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">footprints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;odors&#39;</span><span class="p">,</span> <span class="n">scale_within</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_calls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">smoothed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_footprints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_footprints_alone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_cell_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_footprint_with_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gridspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># TODO TODO be clear on requirements of df and cell_ids in docstring</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    n (int): (default=20) Number of cells to plot traces for if cell_ids not</span>
<span class="sd">        passed as second positional argument.</span>
<span class="sd">    random (bool): (default=False) Whether the `n` cell ids should be selected</span>
<span class="sd">        randomly. If False, the first `n` cells are used.</span>
<span class="sd">    order_by (str): &#39;odors&#39; or &#39;presentation_order&#39;</span>
<span class="sd">    scale_within (str): &#39;none&#39;, &#39;cell&#39;, or &#39;trial&#39;</span>
<span class="sd">    gridspec (None or matplotlib.gridspec.*): region of a parent figure</span>
<span class="sd">        to draw this plot on.</span>
<span class="sd">    linewidth (float): 0.25 seemed ok on CNMF data, but too small w/ clean</span>
<span class="sd">    traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">tifffile</span>
    <span class="kn">import</span> <span class="nn">cv2</span>
    <span class="c1"># TODO maybe use cv2 and get rid of this dep?</span>
    <span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">color</span>

    <span class="c1"># TODO make text size and the spacing of everything more invariant to figure</span>
    <span class="c1"># size. i think the default size of this figure ended up being bigger when i</span>
    <span class="c1"># was using it in kc_analysis than it is now in the gui, so it isn&#39;t display</span>
    <span class="c1"># well in the gui, but fixing it here might break it in the kc_analysis case</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Entering plot_traces...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># TODO flag to also subset to responders first?</span>
        <span class="n">all_cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cells</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
            <span class="c1"># TODO maybe flag to disable seed?</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">all_cells</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">all_cells</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must call with either df or df and cells&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="c1"># or maybe just download (just the required!) footprints from sql?</span>
        <span class="k">if</span> <span class="n">footprints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must pass footprints kwarg if show_footprints&#39;</span><span class="p">)</span>
        <span class="c1"># decide whether this should be in the preconditions or just done here</span>
        <span class="c1"># (any harm to just do here anyway?)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    footprints = footprints.set_index(recording_cols + [&#39;cell&#39;])</span>

    <span class="c1"># TODO TODO TODO fix odor labels as in matrix (this already done?)</span>
    <span class="c1"># (either rotate or use abbreviations so they don&#39;t overlap!)</span>

    <span class="c1"># TODO check order_by and scale_within are correct</span>
    <span class="k">assert</span> <span class="n">raw</span> <span class="ow">or</span> <span class="n">smoothed</span>

    <span class="c1"># TODO maybe automatically show_cells if show_footprints is true,</span>
    <span class="c1"># otherwise don&#39;t?</span>
    <span class="c1"># TODO TODO maybe indicate somehow the multiple response criteria</span>
    <span class="c1"># when it is a list (add border &amp; color each half accordingly?)</span>

    <span class="n">extra_cols</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># TODO which of these cases do i want to support here?</span>
    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show_footprints_alone</span><span class="p">:</span>
            <span class="n">extra_cols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_cols</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">show_footprints_alone</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># TODO possibility of other column for avg + roi overlays</span>
    <span class="c1"># possible to make it larger, or should i use a layout other than</span>
    <span class="c1"># gridspec? just give it more grid elements?</span>
    <span class="c1"># TODO for combinatorial combinations of flags enabling cols on</span>
    <span class="c1"># right, maybe set index for each of those flags up here</span>

    <span class="c1"># TODO could also just could # trials w/ drop_duplicates, for more</span>
    <span class="c1"># generality</span>
    <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">n_expected_repeats</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_repeats</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;name1&#39;</span><span class="p">,</span><span class="s1">&#39;name2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">gridspec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This seems to hang... not sure if it&#39;s usable w/ some changes.</span>
        <span class="c1">#fig = plt.figure(constrained_layout=True)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">made_fig</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">get_topmost_subplotspec</span><span class="p">()</span><span class="o">.</span><span class="n">get_gridspec</span><span class="p">()</span><span class="o">.</span><span class="n">figure</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">made_fig</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="n">trace_gs_slice</span> <span class="o">=</span> <span class="n">gs</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trace_gs_slice</span> <span class="o">=</span> <span class="n">gs</span><span class="p">[:,:]</span>

    <span class="c1"># For common X/Y labels</span>
    <span class="n">bax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">trace_gs_slice</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># hide tick and tick label of the big axes</span>
    <span class="n">bax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">bax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">trace_gs</span> <span class="o">=</span> <span class="n">trace_gs_slice</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span>
        <span class="n">n_trials</span> <span class="o">+</span> <span class="n">extra_cols</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.06</span><span class="p">)</span>

    <span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trace_gs</span><span class="o">.</span><span class="n">_nrows</span><span class="p">):</span>
        <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">tj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trace_gs</span><span class="o">.</span><span class="n">_ncols</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">trace_gs</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span><span class="n">tj</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>

    <span class="c1"># TODO want all of these behind show_footprints?</span>
    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="c1"># TODO use 2/3 for widgets?</span>
        <span class="c1"># TODO or just text saying which keys to press? (if only</span>
        <span class="c1"># selection mechanism is going to be hover, mouse clicks</span>
        <span class="c1"># wouldn&#39;t make sense...)</span>

        <span class="n">avg_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
        <span class="c1"># TODO TODO maybe show trial movie beneath this?</span>
        <span class="c1"># (also on hover/click like (trial,cell) data)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#pad = 40</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="c1"># was also using default fontsize here in kc_analysis use case</span>
        <span class="c1"># increment pad by 5 for each newline in title?</span>
        <span class="n">bax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

    <span class="n">bax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cell&#39;</span><span class="p">)</span>

    <span class="c1"># This pad is to make it not overlap w/ time label on example plot.</span>
    <span class="c1"># Was left to default value for kc_analysis.</span>
    <span class="c1"># TODO negative labelpad work? might get drawn over by axes?</span>
    <span class="n">labelpad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
    <span class="k">if</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;odors&#39;</span><span class="p">:</span>
        <span class="n">bax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trials ordered by odor&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;presentation_order&#39;</span><span class="p">:</span>
        <span class="n">bax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trials in presentation order&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">)</span>

    <span class="n">ordering</span> <span class="o">=</span> <span class="n">pair_ordering</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    display_start_time = -3.0</span>
<span class="sd">    display_stop_time = 10</span>
<span class="sd">    display_window = df[</span>
<span class="sd">        (comparison_df.from_onset &gt;= display_start_time) &amp;</span>
<span class="sd">        (comparison_df.from_onset &lt;= display_stop_time)]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">display_window</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">smoothing_window_secs</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="n">thor</span><span class="o">.</span><span class="n">fps_from_thor</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">smoothing_window_secs</span> <span class="o">*</span> <span class="n">fps</span><span class="p">))</span>

    <span class="n">group_cols</span> <span class="o">=</span> <span class="n">trial_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>

    <span class="n">xmargin</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">display_window</span><span class="o">.</span><span class="n">from_onset</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">xmargin</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">display_window</span><span class="o">.</span><span class="n">from_onset</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">xmargin</span>

    <span class="n">response_rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">nonresponse_rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">response_call_alpha</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cell2contour</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">cell2rect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">cell2text_and_rect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">seen_ij</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plotting cell </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)))</span>

        <span class="n">cell_data</span> <span class="o">=</span> <span class="n">display_window</span><span class="p">[</span><span class="n">display_window</span><span class="o">.</span><span class="n">cell</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">]</span>
        <span class="n">cell_trials</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
            <span class="p">[</span><span class="s1">&#39;from_onset&#39;</span><span class="p">,</span><span class="s1">&#39;df_over_f&#39;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">prep_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">cell_data</span><span class="o">.</span><span class="n">prep_date</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">date_dir</span> <span class="o">=</span> <span class="n">prep_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_fmt_str</span><span class="p">)</span>
        <span class="n">fly_num</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">fly_num</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">thorimage_id</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">thorimage_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#assert len(cell_trials) == axs.shape[1]</span>

        <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">avg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># only uncomment to support dff images and other stuff like that</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                try:</span>
<span class="sd">                    # TODO either put in docstring that datetime.datetime is</span>
<span class="sd">                    # required, or cast input date as appropriate</span>
<span class="sd">                    # (does pandas date type support strftime?)</span>
<span class="sd">                    # or just pass date_dir?</span>
<span class="sd">                    # TODO TODO should not use nr if going to end up using the</span>
<span class="sd">                    # rig avg... but maybe lean towards computing the avg in</span>
<span class="sd">                    # that case rather than deferring to rigid?</span>
<span class="sd">                    tif = motion_corrected_tiff_filename(</span>
<span class="sd">                        prep_date, fly_num, thorimage_id</span>
<span class="sd">                    )</span>
<span class="sd">                except IOError as e:</span>
<span class="sd">                    if verbose:</span>
<span class="sd">                        print(e)</span>
<span class="sd">                    continue</span>

<span class="sd">                # TODO maybe show progress bar / notify on this step</span>
<span class="sd">                if verbose:</span>
<span class="sd">                    print(&#39;Loading full movie from {} ...&#39;.format(tif),</span>
<span class="sd">                        end=&#39;&#39;, flush=True</span>
<span class="sd">                    )</span>
<span class="sd">                movie = tifffile.imread(tif)</span>
<span class="sd">                if verbose:</span>
<span class="sd">                    print(&#39; done.&#39;)</span>
<span class="sd">                &#39;&#39;&#39;</span>

                <span class="c1"># TODO modify motion_corrected_tiff_filename to work in this</span>
                <span class="c1"># case too?</span>
                <span class="n">tif_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">analysis_output_root</span><span class="p">(),</span> <span class="n">date_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fly_num</span><span class="p">),</span>
                    <span class="s1">&#39;tif_stacks&#39;</span>
                <span class="p">)</span>
                <span class="n">avg_nr_tif</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">,</span> <span class="s1">&#39;AVG&#39;</span><span class="p">,</span> <span class="s1">&#39;nonrigid&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;AVG</span><span class="si">{}</span><span class="s1">_nr.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thorimage_id</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">avg_rig_tif</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">,</span> <span class="s1">&#39;AVG&#39;</span><span class="p">,</span> <span class="s1">&#39;rigid&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;AVG</span><span class="si">{}</span><span class="s1">_rig.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thorimage_id</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">avg_tif</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">avg_nr_tif</span><span class="p">):</span>
                    <span class="n">avg_tif</span> <span class="o">=</span> <span class="n">avg_nr_tif</span>
                <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">avg_rig_tif</span><span class="p">):</span>
                    <span class="n">avg_tif</span> <span class="o">=</span> <span class="n">avg_rig_tif</span>

                <span class="k">if</span> <span class="n">avg_tif</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">((</span><span class="s1">&#39;No average motion corrected TIFs &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;found in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">avg</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">avg_tif</span><span class="p">)</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                avg = cv2.normalize(avg, None, alpha=0, beta=1,</span>
<span class="sd">                    norm_type=cv2.NORM_MINMAX, dtype=cv2.CV_32F</span>
<span class="sd">                )</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="c1"># TODO find a way to histogram equalize w/o converting</span>
                <span class="c1"># to 8 bit?</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                    <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_8UC1</span>
                <span class="p">)</span>
                <span class="n">better_constrast</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>

                <span class="n">rgb_avg</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">gray2rgb</span><span class="p">(</span><span class="n">better_constrast</span><span class="p">)</span>

            <span class="n">cell_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">prep_date</span><span class="p">,</span> <span class="n">fly_num</span><span class="p">,</span> <span class="n">thorimage_id</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">)</span>
            <span class="n">footprint_row</span> <span class="o">=</span> <span class="n">footprints</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_row</span><span class="p">]</span>

            <span class="c1"># TODO TODO TODO probably need to transpose how footprint is handled</span>
            <span class="c1"># downstream (would prefer not to transpose footprint though)</span>
            <span class="c1"># (as i had to switch x_coords and y_coords in db as they were</span>
            <span class="c1"># initially entered swapped)</span>
            <span class="n">footprint</span> <span class="o">=</span> <span class="n">db_row2footprint</span><span class="p">(</span><span class="n">footprint_row</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">avg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="c1"># TODO maybe some percentile / fixed size about maximum</span>
            <span class="c1"># density?</span>
            <span class="n">cropped_footprint</span><span class="p">,</span> <span class="p">((</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">))</span> <span class="o">=</span> \
                <span class="n">crop_to_nonzero</span><span class="p">(</span><span class="n">footprint</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

            <span class="n">cell2rect</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

            <span class="n">cropped_avg</span> <span class="o">=</span> \
                <span class="n">better_constrast</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">show_footprint_with_mask</span><span class="p">:</span>
                <span class="c1"># TODO figure out how to suppress clipping warning in the case</span>
                <span class="c1"># when it&#39;s just because of float imprecision (e.g. 1.0000001</span>
                <span class="c1"># being clipped to 1) maybe just normalize to [0 + epsilon, 1 -</span>
                <span class="c1"># epsilon]?</span>
                <span class="c1"># TODO TODO or just set one channel to be this</span>
                <span class="c1"># footprint?  scale first?</span>
                <span class="n">cropped_footprint_rgb</span> <span class="o">=</span> \
                    <span class="n">color</span><span class="o">.</span><span class="n">gray2rgb</span><span class="p">(</span><span class="n">cropped_footprint</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">cropped_footprint_rgb</span><span class="p">[:,:,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># TODO plot w/ value == 1 to test?</span>

                <span class="n">cropped_footprint_hsv</span> <span class="o">=</span> \
                    <span class="n">color</span><span class="o">.</span><span class="n">rgb2hsv</span><span class="p">(</span><span class="n">cropped_footprint_rgb</span><span class="p">)</span>

                <span class="n">cropped_avg_hsv</span> <span class="o">=</span> \
                    <span class="n">color</span><span class="o">.</span><span class="n">rgb2hsv</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">gray2rgb</span><span class="p">(</span><span class="n">cropped_avg</span><span class="p">))</span>

                <span class="c1"># TODO hue already seems to be constant at 0.0 (red?)</span>
                <span class="c1"># so maybe just directly set to red to avoid confusion?</span>
                <span class="n">cropped_avg_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_footprint_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span>
                <span class="n">cropped_avg_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_footprint_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span>

                <span class="n">composite</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">hsv2rgb</span><span class="p">(</span><span class="n">cropped_avg_hsv</span><span class="p">)</span>

                <span class="c1"># TODO TODO not sure this is preserving hue/sat range to</span>
                <span class="c1"># indicate how strong part of filter is</span>
                <span class="c1"># TODO figure out / find some way that would</span>
                <span class="c1"># TODO TODO maybe don&#39;t normalize within each ROI? might</span>
                <span class="c1"># screw up stuff relative to histogram equalized</span>
                <span class="c1"># version...</span>
                <span class="c1"># TODO TODO TODO still normalize w/in crop in contour</span>
                <span class="c1"># case?</span>
                <span class="n">composite</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">composite</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">beta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_32F</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO could also use something more than this</span>
                <span class="c1"># TODO TODO fix bug here. see 20190402_bug1.txt</span>
                <span class="c1"># TODO TODO where are all zero footprints coming from?</span>
                <span class="n">cropped_footprint_nonzero</span> <span class="o">=</span> <span class="n">cropped_footprint</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cropped_footprint_nonzero</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">level</span> <span class="o">=</span> \
                    <span class="n">cropped_footprint</span><span class="p">[</span><span class="n">cropped_footprint_nonzero</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">show_footprints_alone</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">f_ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">f_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cropped_footprint</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                <span class="n">f_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">show_footprint_with_mask</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">composite</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cropped_avg</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                <span class="c1"># TODO TODO also show any other contours in this rectangular ROI</span>
                <span class="c1"># in a diff color! (copy how gui does this)</span>
                <span class="n">cell2contour</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">util</span><span class="o">.</span><span class="n">closed_mpl_contours</span><span class="p">(</span><span class="n">cropped_footprint</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">y_min</span><span class="p">,</span> <span class="n">x_min</span><span class="p">),</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">cell2text_and_rect</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">cell_trial</span> <span class="ow">in</span> <span class="n">cell_trials</span><span class="p">:</span>
            <span class="c1">#(prep_date, fly_num, thorimage_id,</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">repeat_num</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>

            <span class="c1"># TODO TODO also support a &#39;fixed&#39; order that B wanted</span>
            <span class="c1"># (which should also include missing stuff[, again in gray,]</span>
            <span class="c1"># ideally)</span>
            <span class="k">if</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;odors&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">n_repeats</span> <span class="o">*</span> <span class="n">ordering</span><span class="p">[(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">)]</span> <span class="o">+</span> <span class="n">repeat_num</span>

            <span class="k">elif</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;presentation_order&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">order</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;supported orderings are &#39;odors&#39; and &quot;</span><span class="o">+</span>
                    <span class="s2">&quot;&#39;presentation_order&#39;&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;trial&#39;</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">assert</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_ij</span>
            <span class="n">seen_ij</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># So that events that get the axes can translate to cell /</span>
            <span class="c1"># trial information.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">cell_id</span> <span class="o">=</span> <span class="n">cell_id</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">trial_info</span> <span class="o">=</span> <span class="n">n</span>

            <span class="c1"># X and Y axis major tick label fontsizes.</span>
            <span class="c1"># Was left to default for kc_analysis.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

            <span class="n">trial_times</span> <span class="o">=</span> <span class="n">cell_trial</span><span class="p">[</span><span class="s1">&#39;from_onset&#39;</span><span class="p">]</span>

            <span class="c1"># TODO TODO why is *first* ea trial the one not shown, and</span>
            <span class="c1"># apparently the middle pfo trial</span>
            <span class="c1"># (was it not actually ordered by &#39;order&#39;/frame_num outside of</span>
            <span class="c1"># odor order???)</span>
            <span class="c1"># TODO TODO TODO why did this not seem to work? (or only for</span>
            <span class="c1"># 1/3.  the middle one. iaa.)</span>
            <span class="c1"># (and actually title is still hidden for ea and pfo trials</span>
            <span class="c1"># mentioned above, but numbers / ticks / box still there)</span>
            <span class="c1"># (above notes only apply to odor order case. presentation order</span>
            <span class="c1"># worked)</span>
            <span class="c1"># TODO and why is gray title over correct axes in odor order case,</span>
            <span class="c1"># but axes not displaying data are in wrong place?</span>
            <span class="c1"># TODO is cell_trial messed up?</span>

            <span class="c1"># Supports at least the case when there are missing odor</span>
            <span class="c1"># presentations at the end of the ~block.</span>
            <span class="n">missing_this_presentation</span> <span class="o">=</span> \
                <span class="n">trial_times</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trial_times</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># TODO group in odors case as w/ matshow?</span>
                <span class="k">if</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;odors&#39;</span><span class="p">:</span>
                    <span class="n">trial_title</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">format_mixture</span><span class="p">({</span>
                        <span class="s1">&#39;name1&#39;</span><span class="p">:</span> <span class="n">o1</span><span class="p">,</span>
                        <span class="s1">&#39;name2&#39;</span><span class="p">:</span> <span class="n">o2</span><span class="p">,</span>
                    <span class="p">})</span>
                <span class="k">elif</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;presentation_order&#39;</span><span class="p">:</span>
                    <span class="n">trial_title</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">format_mixture</span><span class="p">({</span>
                        <span class="s1">&#39;name1&#39;</span><span class="p">:</span> <span class="n">o1</span><span class="p">,</span>
                        <span class="s1">&#39;name2&#39;</span><span class="p">:</span> <span class="n">o2</span>
                    <span class="p">})</span>

                <span class="k">if</span> <span class="n">missing_this_presentation</span><span class="p">:</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">trial_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">tc</span><span class="p">)</span>
                <span class="c1"># TODO may also need to do tight_layout here...</span>
                <span class="c1"># it apply to these kinds of titles?</span>

            <span class="k">if</span> <span class="n">missing_this_presentation</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">trial_dff</span> <span class="o">=</span> <span class="n">cell_trial</span><span class="p">[</span><span class="s1">&#39;df_over_f&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trial_times</span><span class="p">,</span> <span class="n">trial_dff</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">smoothed</span><span class="p">:</span>
                <span class="c1"># TODO kwarg(s) to control smoothing?</span>
                <span class="n">sdff</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">trial_dff</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">sdff</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">sdff</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sdff</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sdff</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

                <span class="c1"># TODO TODO have plot_traces take kwargs to be passed to</span>
                <span class="c1"># plotting fn + delete separate linewidth</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trial_times</span><span class="p">,</span> <span class="n">sdff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

            <span class="c1"># TODO also / separately subsample?</span>

            <span class="k">if</span> <span class="n">response_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">was_a_response</span> <span class="o">=</span> \
                    <span class="n">response_calls</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">repeat_num</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">was_a_response</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">response_rgb</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">response_call_alpha</span><span class="p">,))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">nonresponse_rgb</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">response_call_alpha</span><span class="p">,))</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># want these centered on example plot or across all?</span>

                <span class="c1"># I had not specified fontsize for kc_analysis case, so whatever</span>
                <span class="c1"># the default value was probably worked OK there.</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Seconds from odor onset&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                    <span class="n">scaletext</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
                    <span class="n">scaletext</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Scaled within each cell&#39;</span>
                <span class="k">elif</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;trial&#39;</span><span class="p">:</span>
                    <span class="n">scaletext</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Scaled within each trial&#39;</span>

                <span class="c1"># TODO just change to &quot;% maximum w/in &lt;x&gt;&quot; or something?</span>
                <span class="c1"># Was 70 for kc_analysis case. That&#39;s much too high here.</span>
                <span class="c1">#labelpad = 70</span>
                <span class="n">labelpad</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="c1"># TODO factor out latex for delta f / f stuff</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\frac{\Delta F}</span><span class="si">{F}</span><span class="s1">$&#39;</span> <span class="o">+</span> <span class="n">scaletext</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span>
                <span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">show_cell_ids</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Indexes as they would be from one. For comparison</span>
                    <span class="c1"># w/ Remy&#39;s MATLAB analysis.</span>
                    <span class="c1"># This and default fontsize worked for kc_analysis case,</span>
                    <span class="c1"># not for GUI.</span>
                    <span class="c1">#labelpad = 18</span>
                    <span class="n">labelpad</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                    <span class="c1"># TODO put a label somewhere on the plot indicating</span>
                    <span class="c1"># these are cell IDs</span>

                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

        <span class="c1"># TODO change units in this case on ylabel?</span>
        <span class="c1"># (to reflect how it was scaled)</span>
        <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">r</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="n">fly_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, fly </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">date_dir</span><span class="p">,</span> <span class="n">fly_num</span><span class="p">,</span> <span class="n">thorimage_id</span><span class="p">)</span>

        <span class="c1"># title like &#39;Recording average fluorescence&#39;?</span>
        <span class="c1">#avg_ax.set_title(fly_title)</span>
        <span class="n">avg_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb_avg</span><span class="p">)</span>
        <span class="n">avg_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="n">cell2rect_artists</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="c1"># TODO TODO fix bug that required this (zero nonzero pixel</span>
            <span class="c1"># in cropped footprint thing...)</span>
            <span class="k">if</span> <span class="n">cell_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cell2text_and_rect</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span> <span class="o">=</span> <span class="n">cell2text_and_rect</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span>

            <span class="n">box</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_bbox</span><span class="p">()</span>
            <span class="c1"># TODO appropriate font properties? placement still good?</span>
            <span class="c1"># This seemed to work be for (larger?) figures in kc_analysis,</span>
            <span class="c1"># too large + too close to boxes in gui (w/ ~8&quot;x5&quot; gridspec,dpi 100)</span>
            <span class="c1"># TODO set in relation to actual fig size (+ dpi?)</span>
            <span class="c1">#boxlabel_fontsize = 9</span>
            <span class="n">boxlabel_fontsize</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">text_artist</span> <span class="o">=</span> <span class="n">avg_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">ymin</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">boxlabel_fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="c1"># TODO jitter somehow (w/ arrow pointing to box?) to ensure no</span>
            <span class="c1"># overlap? (this would be ideal, but probably hard to implement)</span>
            <span class="n">avg_ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

            <span class="n">cell2rect_artists</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">text_artist</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">made_fig</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="showsync"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.showsync">[docs]</a><span class="k">def</span> <span class="nf">showsync</span><span class="p">(</span><span class="n">thorsync_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shows ThorSync .h5 data interactively, using `pyqtgraph`.</span>

<span class="sd">    Args:</span>
<span class="sd">        thorsync_dir: path to a directory created by ThorSync</span>
<span class="sd">        kwargs: passed through to `thor.load_thorsync_hdf5`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span>

    <span class="c1"># TODO TODO make it possible to click to toggle display of lines like in thorsync</span>
    <span class="c1"># itself</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">mkQApp</span><span class="p">()</span>

    <span class="n">before</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading HDF5...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">thor</span><span class="o">.</span><span class="n">load_thorsync_hdf5</span><span class="p">(</span><span class="n">thorsync_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">took_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">before</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;done (</span><span class="si">{</span><span class="n">took_s</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s)&#39;</span><span class="p">)</span>

    <span class="c1"># TODO set title to last 3 parts of path if parent two directories can be parsed as</span>
    <span class="c1"># (date, fly_num) (or if just under raw_data_root maybe?)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">thorsync_dir</span>

    <span class="c1"># plot_widget if of type pyqtgraph.widgets.PlotWidget.PlotWidget</span>
    <span class="c1"># not really sure how &#39;all&#39; and &#39;pairs&#39; differ... (&#39;pairs&#39; skip some?)</span>
    <span class="c1"># TODO wanted to set clipToView=True and some other stuff here, but downsampling=100</span>
    <span class="c1"># didn&#39;t seem to work at all (unlike call below), so i&#39;m not sure anythere here</span>
    <span class="c1"># will.</span>
    <span class="n">plot_widget</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setLabels</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="s1">&#39;Seconds&#39;</span><span class="p">)</span>

    <span class="c1"># Passing `autoDownsample=True` to either the `plot` call above or those in the loop</span>
    <span class="c1"># below caused the startup time to increase beyond what is acceptable. Was also slow</span>
    <span class="c1"># after loading. Not sure why it only seems to work here.</span>
    <span class="c1">#plot_widget.setDownsampling(100)</span>
    <span class="c1"># TODO TODO could downsampling cause problems? how? maybe add cli flag to disable</span>
    <span class="c1"># it?</span>
    <span class="c1"># TODO TODO in `auto` case, is automatically selected factor changed when zooming?</span>
    <span class="c1"># (or would i (could i even?) need to link settting it to change in scale or</span>
    <span class="c1"># something?)</span>
    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setDownsampling</span><span class="p">(</span><span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Much snappier with this. Doesn&#39;t try to draw data out of bounds of view box.</span>
    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setClipToView</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># TODO set initial view box and / or build in margin such that legend is out of way</span>
    <span class="c1"># of traces immediately</span>

    <span class="n">plot_widget</span><span class="o">.</span><span class="n">addLegend</span><span class="p">()</span>

    <span class="n">time_col</span> <span class="o">=</span> <span class="n">thor</span><span class="o">.</span><span class="n">time_col</span>

    <span class="n">x_min</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">time_col</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="c1"># TODO maybe add a margin around this, but only if it can be made clear where the</span>
    <span class="c1"># region the data actually exists in is (not just black everywhere...)</span>
    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setLimits</span><span class="p">(</span><span class="n">xMin</span><span class="o">=</span><span class="n">x_min</span><span class="p">,</span> <span class="n">xMax</span><span class="o">=</span><span class="n">x_max</span><span class="p">,</span> <span class="n">yMin</span><span class="o">=</span><span class="n">y_min</span><span class="p">,</span> <span class="n">yMax</span><span class="o">=</span><span class="n">y_max</span><span class="p">)</span>

    <span class="n">plot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">time_col</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;frame_counter&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not plotting frame_counter&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="c1"># Otherwise this produces an in error in pyqtgraph internals</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">))</span>

        <span class="c1"># TODO maybe store hardcoded map for colors for these?</span>
        <span class="c1"># not sure how consistent column order is as loaded from hdf5...</span>
        <span class="n">plot_widget</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">time_col</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">)))</span>

    <span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>


<span class="c1"># TODO maybe one fn that puts in matrix format and another in table</span>
<span class="c1"># (since matrix may be sparse...)</span>
<span class="c1"># TODO delete / move to project specific repo / generalize</span>
<span class="c1"># (currently only used in no-longer-used natural_odors/kc_analysis.py)</span>
<div class="viewcode-block" id="plot_pair_n"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_pair_n">[docs]</a><span class="k">def</span> <span class="nf">plot_pair_n</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots a matrix of odor1 X odor2 w/ counts of flies as entries.</span>

<span class="sd">    Args:</span>
<span class="sd">    df (pd.DataFrame): DataFrame with columns:</span>
<span class="sd">        - prep_date</span>
<span class="sd">        - fly_num</span>
<span class="sd">        - thorimage_id</span>
<span class="sd">        - name1</span>
<span class="sd">        - name2</span>
<span class="sd">        Data already collected w/ odor pairs.</span>

<span class="sd">    odor_panel (pd.DataFrame): (optional) DataFrame with columns:</span>
<span class="sd">        - odor_1</span>
<span class="sd">        - odor_2</span>
<span class="sd">        - reason (maybe make this optional?)</span>
<span class="sd">        The odor pairs experiments are supposed to collect data for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">imgkit</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

    <span class="n">odor_panel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">odor_panel</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incorrect number of arguments&#39;</span><span class="p">)</span>
    <span class="c1"># TODO maybe make df optional and read from database if it&#39;s not passed?</span>
    <span class="c1"># TODO a flag to show all stuff marked attempt analysis in gsheet?</span>

    <span class="c1"># TODO borrow more of this / call this in part of kc_analysis that made that</span>
    <span class="c1"># table w/ these counts for repeats?</span>

    <span class="c1"># TODO also handle no_second_odor</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">name1</span> <span class="o">==</span> <span class="s1">&#39;paraffin&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">name2</span> <span class="o">==</span> <span class="s1">&#39;paraffin&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># TODO possible to do at least a partial check w/ n_accepted_blocks sum?</span>
    <span class="c1"># (would have to do outside of this fn. presentations here doesn&#39;t have it.</span>
    <span class="c1"># whatever latest_analysis returns might.)</span>

    <span class="n">replicates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;prep_date&#39;</span><span class="p">,</span><span class="s1">&#39;fly_num&#39;</span><span class="p">,</span><span class="s1">&#39;recording_from&#39;</span><span class="p">,</span><span class="s1">&#39;name1&#39;</span><span class="p">,</span><span class="s1">&#39;name2&#39;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># TODO do i actually want margins? (would currently count single odors twice</span>
    <span class="c1"># if in multiple comparison... may at least not want that?)</span>
    <span class="c1"># hide margins for now.</span>
    <span class="n">pair_n</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">replicates</span><span class="o">.</span><span class="n">name1</span><span class="p">,</span> <span class="n">replicates</span><span class="o">.</span><span class="n">name2</span><span class="p">)</span> <span class="c1">#, margins=True)</span>

    <span class="c1"># Making the rectangular matrix pair_n square</span>
    <span class="c1"># (same indexes on row and column axes)</span>

    <span class="k">if</span> <span class="n">odor_panel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This is basically equivalent to the logic in the branch below,</span>
        <span class="c1"># although the index is not defined separately here.</span>
        <span class="n">full_pair_n</span> <span class="o">=</span> <span class="n">pair_n</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">pair_n</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO [change odor&lt;n&gt; to / handle] name&lt;n&gt;, to be consistent w/ above</span>
        <span class="c1"># TODO TODO TODO also make this triangular / symmetric</span>
        <span class="n">odor_panel</span> <span class="o">=</span> <span class="n">odor_panel</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;odor_1&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;odor_2&#39;</span><span class="p">,</span>
            <span class="n">aggfunc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;reason&#39;</span><span class="p">)</span>

        <span class="n">full_panel_index</span> <span class="o">=</span> <span class="n">odor_panel</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">odor_panel</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">full_data_index</span> <span class="o">=</span> <span class="n">pair_n</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">pair_n</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">full_data_index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">full_panel_index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="c1"># TODO also check no pairs occur in data that are not in panel</span>
        <span class="c1"># TODO isin-like check for tuples (or other combinations of rows)?</span>
        <span class="c1"># just iterate over both after drop_duplicates?</span>

        <span class="n">full_pair_n</span> <span class="o">=</span> <span class="n">pair_n</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">full_panel_index</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">full_panel_index</span><span class="p">)</span>
        <span class="c1"># TODO maybe making symmetric is a matter of setting 0 to nan here?</span>
        <span class="c1"># and maybe setting back to nan at the end if still 0?</span>
        <span class="n">full_pair_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1"># TODO full_pair_n.fillna(0, inplace=True)?</span>

    <span class="c1"># TODO TODO delete this hack once i find a nicer way to make the</span>
    <span class="c1"># output of crosstab symmetric</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">elif</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
    <span class="c1"># TODO also delete this hack. this assumes that anything set to 0</span>
    <span class="c1"># is not actually a pair in the panel (which should be true right now</span>
    <span class="c1"># but will not always be)</span>
    <span class="n">full_pair_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#</span>

    <span class="c1"># TODO TODO TODO make crosstab output actually symmetric, not just square</span>
    <span class="c1"># (or is it always one diagonal that&#39;s filled in? if so, really just need</span>
    <span class="c1"># that)</span>
    <span class="k">assert</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># TODO TODO TODO how to indicate which of the pairs we are actually</span>
    <span class="c1"># interested in? grey out the others? white the others? (just set to nan?)</span>
    <span class="c1"># (maybe only use to grey / white out if passed in?)</span>
    <span class="c1"># (+ margins for now)</span>

    <span class="c1"># TODO TODO TODO color code text labels by pair selection reason + key</span>
    <span class="c1"># TODO what to do when one thing falls under two reasons though...?</span>
    <span class="c1"># just like a key (or things alongside ticklabels) that has each color</span>
    <span class="c1"># separately? just symbols in text, if that&#39;s easier?</span>

    <span class="c1"># TODO TODO display actual counts in squares in matshow</span>
    <span class="c1"># maybe make colorbar have discrete steps?</span>

    <span class="n">full_pair_n</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">light_palette</span><span class="p">(</span><span class="s1">&#39;seagreen&#39;</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># TODO TODO if i&#39;m going to continue using styler + imgkit</span>
    <span class="c1"># at least figure out how to get the cmap to actually work</span>
    <span class="c1"># need some css or something?</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">background_gradient</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">imgkit</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;natural_odors_pair_n.png&#39;</span><span class="p">)</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Tom O&#39;Connell.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>