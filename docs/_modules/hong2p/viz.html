

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>hong2p.viz &mdash; hong2p 0.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> hong2p
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/modules.html">hong2p</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hong2p</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>hong2p.viz</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hong2p.viz</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions for visualizing movies / cells / extracted traces, some intended to</span>
<span class="sd">provide context specfically useful for certain types of olfaction experiments.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Callable</span>
<span class="c1"># TODO delete pprint import</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span><span class="p">,</span> <span class="n">pprint</span>
<span class="c1"># TODO replace w/ logging.warning?</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">colorsys</span> <span class="kn">import</span> <span class="n">rgb_to_hsv</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">Random</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">linkage</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">CenteredNorm</span><span class="p">,</span> <span class="n">TwoSlopeNorm</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="k">as</span> <span class="nn">PathEffects</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">ImageGrid</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="c1"># Only for type hinting</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.axes</span> <span class="kn">import</span> <span class="n">Axes</span>
<span class="kn">from</span> <span class="nn">matplotlib.colorbar</span> <span class="kn">import</span> <span class="n">Colorbar</span>
<span class="kn">from</span> <span class="nn">matplotlib_scalebar.scalebar</span> <span class="kn">import</span> <span class="n">ScaleBar</span>

<span class="kn">from</span> <span class="nn">hong2p</span> <span class="kn">import</span> <span class="n">util</span><span class="p">,</span> <span class="n">thor</span>
<span class="kn">from</span> <span class="nn">hong2p</span> <span class="kn">import</span> <span class="n">roi</span> <span class="k">as</span> <span class="n">hong_roi</span>
<span class="c1"># TODO replace w/ select_certain_rois (after adapting it to work w/ DataArray input)</span>
<span class="c1"># TODO possible to fix circular import error this seemed to cause? maybe via changing</span>
<span class="c1"># hong2p.roi (only/too)?</span>
<span class="c1">#from hong2p.roi import is_ijroi_certain</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">hong2p.olf</span> <span class="kn">import</span> <span class="n">remove_consecutive_repeats</span>
<span class="kn">from</span> <span class="nn">hong2p.types</span> <span class="kn">import</span> <span class="n">DataFrameOrDataArray</span>


<span class="c1"># TODO consider making a style sheet as in:</span>
<span class="c1"># https://matplotlib.org/stable/tutorials/introductory/customizing.html?highlight=style%20sheets</span>

<span class="n">DEFAULT_ANATOMICAL_CMAP</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>

<span class="c1"># TODO use this other places that redefine, now that it&#39;s module-level</span>
<span class="n">dff_latex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\Delta F/F$&#39;</span>

<span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># TODO machinery to register combinations of level names -&gt; how they should be formatted</span>
<span class="c1"># into str labels for matshow (e.g. (&#39;odor1&#39;,&#39;odor2&#39;) -&gt; olf.format_mix_from_strs)?</span>
<span class="c1"># TODO and like to set default cmap(s)?</span>

<div class="viewcode-block" id="remove_axes_ticks"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.remove_axes_ticks">[docs]</a><span class="k">def</span> <span class="nf">remove_axes_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># (was) trying to recreate ax.axis(&#39;off&#39;), but in a way where i can still see</span>
    <span class="c1"># the ylabels (so micrometer_depth_title&#39;s as_ylabel kwarg can work)</span>
    <span class="c1">#</span>
    <span class="c1"># i feel like at some point i felt ax.axis(&#39;off&#39;) did more, but seems OK for now</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span></div>


<span class="c1"># TODO change docstring to indicate rowlabel_fn should take a pd.Series, if that is</span>
<span class="c1"># always correct (for multiindex / not input, etc)</span>
<div class="viewcode-block" id="matlabels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.matlabels">[docs]</a><span class="k">def</span> <span class="nf">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rowlabel_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">):</span>
    <span class="c1"># TODO should i modify so it takes an Index/MultiIndex rather than a DataFrame row?</span>
    <span class="c1"># what would make these functions more natural to write?</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes DataFrame and function that takes one row of index to a label.</span>

<span class="sd">    `rowlabel_fn` should take a DataFrame row (w/ columns from index) to a str.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO move to something like util._validate_axis?</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;columns&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis must be either &#39;index&#39; or &#39;columns&#39;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rowlabel_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>


<span class="c1"># TODO should i thread delim kwarg to default fn thru here (e.g. just threading all</span>
<span class="c1"># kwargs through to label_fn)?</span>
<div class="viewcode-block" id="row_labels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.row_labels">[docs]</a><span class="k">def</span> <span class="nf">row_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="col_labels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.col_labels">[docs]</a><span class="k">def</span> <span class="nf">col_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span></div>


<span class="c1"># TODO take dict of level -&gt; formatting str/fn (name `formatters` as</span>
<span class="c1"># DataFrame.to_string())?</span>
<div class="viewcode-block" id="format_index_row"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.format_index_row">[docs]</a><span class="k">def</span> <span class="nf">format_index_row</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">delim</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; / &#39;</span><span class="p">,</span>
    <span class="n">float_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes Series to a str with the concatenated values, separated by `delim`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_format_value</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO handle NaN separately (defaulting to not showing?) like na_rep in</span>
        <span class="c1"># DataFrame.to_string()?</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">float_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># assuming float_format is a valid float formatting string (e.g. &#39;.2f&#39;)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:{</span><span class="n">float_format</span><span class="si">}}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_format_value</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">])</span></div>


<span class="c1"># TODO rename to indicate xarray coersion (/ move that to a separate decorator called</span>
<span class="c1"># first?)?</span>
<span class="c1"># TODO specify plot_fn must take a df (maybe also numpy?) input (via type hinting)?</span>
<span class="c1"># TODO TODO add kwarg to wrapped fns that allows specifying axes that are supposed to</span>
<span class="c1"># include odor mixture metadata (or maybe more generally some minimum set of index</span>
<span class="c1"># levels, defined by matching some filtering fn?), to enforce (and maybe automatically</span>
<span class="c1"># convert for some types of input) that we have DataFrame / (especially) DataArray</span>
<span class="c1"># indices set correctly before calling the wrapped fn</span>
<span class="c1"># TODO also provide a means of specifying the dimension of input the fns expect (at</span>
<span class="c1"># least squeezed dimension, maybe w/ a squeeze=True kwarg added by wrapper?)</span>
<div class="viewcode-block" id="callable_ticklabels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.callable_ticklabels">[docs]</a><span class="k">def</span> <span class="nf">callable_ticklabels</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">):</span>
    <span class="c1"># TODO still true that fn must accept [x|y]ticklabels? change doc if not.</span>
    <span class="sd">&quot;&quot;&quot;Allows [x/y]ticklabel functions evaluated on indices of `df` (`plot_fn(df, ...)`)</span>

<span class="sd">    First parameter to `plot_fn` must be a `pandas.DataFrame` (or `xarray.DataArray`</span>
<span class="sd">    convertable to one) to compute the `str` ticklabels from. `plot_fn` must also accept</span>
<span class="sd">    the kwargs &#39;[x|y]ticklabels&#39;.</span>

<span class="sd">    If the input to the decorated function is a `xarray.DataArray`, the decorated</span>
<span class="sd">    function will receive a `DataFrame` (created via `arr.to_pandas()`) as input</span>
<span class="sd">    instead. Note that only &#39;dimension coordinates&#39; (see xarray terminology page) are</span>
<span class="sd">    preserved when converting from `DataArray` to `DataFrame`, so use</span>
<span class="sd">    `&lt;arr&gt;.set_index(&lt;dimension name&gt;=...)` appropriately before passing the array to a</span>
<span class="sd">    wrapped function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_check_bools</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># TODO rewrite doc. don&#39;t know what i was even doing passing (a single?) str</span>
        <span class="c1"># before...</span>
        <span class="sd">&quot;&quot;&quot;Makes True equivalent to passing str, and False equivalent to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ticklabels</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># TODO TODO probably also default to this in case ticklabels=None</span>
            <span class="c1"># (might just need to modify some of the calling code)</span>
            <span class="n">format_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">format_index_row</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">format_fn</span>

        <span class="c1"># NOTE: this broke ticklabel=False support sns.clustermap has (from</span>
        <span class="c1"># sns.heatmap). currently moved this processing into matshow, which had come to</span>
        <span class="c1"># expect this behavior (but maybe revert the matshow changes alongside when this</span>
        <span class="c1"># code was added?)</span>
        <span class="c1">#elif ticklabels == False:</span>
        <span class="c1">#    return None</span>

        <span class="c1"># TODO delete after checking code that could be affected to see if it trips.</span>
        <span class="c1">#</span>
        <span class="c1"># I.e. if it is specifically the callable `str`, which I had sometimes used for</span>
        <span class="c1"># single level indices in the past, but have encountered issues with and made</span>
        <span class="c1"># `format_index_row` to replace.</span>
        <span class="k">elif</span> <span class="n">ticklabels</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;replace usage of str with hong2p.viz.format_index_row&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ticklabels</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ticklabels</span>

    <span class="c1"># TODO should this also include numpy.ndarray subclasses in input types?</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped_plot_fn</span><span class="p">(</span><span class="n">df_or_arr</span><span class="p">:</span> <span class="n">DataFrameOrDataArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># TODO use inspect to get any kwargs to format_index_row, then pass that subset</span>
        <span class="c1"># of kwargs thru to _check_bools (so i don&#39;t have to keep manually including in</span>
        <span class="c1"># this list?)?</span>
        <span class="n">default_format_fn_kwarg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;delim&#39;</span><span class="p">,</span> <span class="s1">&#39;float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;_debug&#39;</span><span class="p">]</span>
        <span class="n">_pass_thru_to_plot_fn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_debug&#39;</span><span class="p">]</span>
        <span class="n">default_format_fn_kws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_format_fn_kwarg_names</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_format_fn_kws</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_pass_thru_to_plot_fn</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_or_arr</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="c1"># Requires df_or_arr to be &lt;=2d</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df_or_arr</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df_or_arr</span>

        <span class="k">if</span> <span class="s1">&#39;xticklabels&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">_check_bools</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xticklabels&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">default_format_fn_kws</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">):</span>
                <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">col_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">xticklabels</span><span class="p">)</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xticklabels</span>

        <span class="k">if</span> <span class="s1">&#39;yticklabels&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">_check_bools</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;yticklabels&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">default_format_fn_kws</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">):</span>
                <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">row_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yticklabels</span><span class="p">)</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;yticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yticklabels</span>

        <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapped_plot_fn</span></div>


<span class="c1"># TODO delete (or add to test_viz.test_is_cmap_diverging)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def _palettable_diverging_cmaps():</span>
<span class="sd">    # TODO move up if i end up using</span>
<span class="sd">    from importlib import import_module</span>

<span class="sd">    from palettable.palette import Palette</span>
<span class="sd">    #</span>

<span class="sd">    # TODO TODO where is &#39;vlag&#39;? in here? doesn&#39;t seem to be in palettable. fuck.</span>
<span class="sd">    # (not in &#39;matplotlib&#39;, it seems)</span>

<span class="sd">    # copied from doc</span>
<span class="sd">    modules_with_palettes = [</span>
<span class="sd">        &#39;cartocolors.diverging&#39;,</span>
<span class="sd">        #&#39;cartocolors.qualitative&#39;,</span>
<span class="sd">        #&#39;cartocolors.sequential&#39;,</span>
<span class="sd">        &#39;cmocean.diverging&#39;,</span>
<span class="sd">        #&#39;cmocean.sequential&#39;,</span>
<span class="sd">        &#39;colorbrewer.diverging&#39;,</span>
<span class="sd">        #&#39;colorbrewer.qualitative&#39;,</span>
<span class="sd">        #&#39;colorbrewer.sequential&#39;,</span>
<span class="sd">        &#39;lightbartlein.diverging&#39;,</span>
<span class="sd">        #&#39;lightbartlein.sequential&#39;,</span>

<span class="sd">        # TODO do these also have cmaps labelled as divering?</span>
<span class="sd">        &#39;matplotlib&#39;,</span>
<span class="sd">        &#39;mycarta&#39;,</span>

<span class="sd">        &#39;scientific.diverging&#39;,</span>
<span class="sd">        #&#39;scientific.sequential&#39;,</span>

<span class="sd">        # TODO do these also have cmaps labelled as divering?</span>
<span class="sd">        &#39;tableau&#39;,</span>
<span class="sd">        &#39;wesanderson&#39;,</span>
<span class="sd">    ]</span>

<span class="sd">    all_diverging_palettes = []</span>
<span class="sd">    for mod_name in modules_with_palettes:</span>
<span class="sd">        mod = import_module(f&#39;.{mod_name}&#39;, &#39;palettable&#39;)</span>
<span class="sd">        print(mod_name)</span>

<span class="sd">        # TODO delete</span>
<span class="sd">        #mod.print_maps()</span>

<span class="sd">        # (at least for cartocolors.diverging)</span>
<span class="sd">        # this seems to include stuff with &#39;_r&#39; at end, where mod.print_maps() does not.</span>
<span class="sd">        # each there has a &#39;_r&#39; variant. otherwise, palette lists look the same as in</span>
<span class="sd">        # mod.print_maps.</span>
<span class="sd">        palettes = [</span>
<span class="sd">            x for x in dir(mod) if isinstance(getattr(mod, x), Palette)</span>
<span class="sd">        ]</span>
<span class="sd">        # TODO check against internal variable listing palettes? can we rely on such a</span>
<span class="sd">        # variable? what name?</span>

<span class="sd">        diverging_palettes = [</span>
<span class="sd">            f&#39;{mod_name}.{x}&#39; for x in palettes if getattr(mod, x).type == &#39;diverging&#39;</span>
<span class="sd">        ]</span>
<span class="sd">        # TODO check if plt.get_cmap(x) works for each?</span>
<span class="sd">        # TODO TODO maybe only return ones where that is true?</span>

<span class="sd">        all_diverging_palettes.extend(diverging_palettes)</span>

<span class="sd">        # TODO delete</span>
<span class="sd">        #pprint(diverging_palettes)</span>
<span class="sd">        #print()</span>

<span class="sd">    # TODO TODO check whether just last component of names are unique across modules</span>
<span class="sd">    # (hopefully all could be provided to plt.get_cmap?, so we can check cmap.name</span>
<span class="sd">    # against a set from these names)</span>
<span class="sd">    pprint(all_diverging_palettes)</span>
<span class="sd">    import ipdb; ipdb.set_trace()</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="is_cmap_diverging"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.is_cmap_diverging">[docs]</a><span class="k">def</span> <span class="nf">is_cmap_diverging</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns guess as to whether input colormap is a diverging colormap.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmap: anything that could be passed to `plt.get_cmap`, such as str colormap name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: does not support &#39;RdGy&#39;, or other diverging cmaps where one side is not</span>
    <span class="c1"># saturated</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

    <span class="c1"># TODO delete</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # TODO just iterate over list of entries in cmap (many already enumerated, right?)</span>
<span class="sd">    # do they interpolate between (lut? is that what lut is?) entries?</span>
<span class="sd">    # TODO or at least change num=50 to default # of entries in lut (/cmap)?</span>
<span class="sd">    xs = np.linspace(0, 1, 50)</span>
<span class="sd">    cs = np.array([cmap(x) for x in xs])</span>
<span class="sd">    # shape: (n_colors, 3)</span>
<span class="sd">    cs_hsv = np.array([rgb_to_hsv(*c[:3]) for c in cs])</span>
<span class="sd">    saturations = cs_hsv[:, 1]</span>
<span class="sd">    plt.close(&#39;all&#39;)</span>
<span class="sd">    print(f&#39;{cmap.name=}&#39;)</span>
<span class="sd">    plt.plot(xs, saturations)</span>
<span class="sd">    plt.title(cmap.name)</span>
<span class="sd">    plt.show()</span>
<span class="sd">    import ipdb; ipdb.set_trace()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_get_hsv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mf">0.</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">rgb_to_hsv</span><span class="p">(</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">x</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_get_sat</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_get_hsv</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># TODO also fn to check value (as in V from HSV) at middle, to determine whether to</span>
    <span class="c1"># draw using white / black over it?</span>

    <span class="c1"># TODO check minimum saturation is ~middle. anything else?</span>

    <span class="n">mid</span> <span class="o">=</span> <span class="n">_get_sat</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">low</span> <span class="o">=</span> <span class="n">_get_sat</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">_get_sat</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># mid should be pretty much either black or white. adding this check allows us to</span>
    <span class="c1"># support stuff like &#39;icefire&#39; w/o false positive of &#39;cividis&#39; (which I also use)</span>
    <span class="n">mid_val</span> <span class="o">=</span> <span class="n">_get_hsv</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># TODO delete</span>
    <span class="c1">#print(f&#39;{cmap.name}: {mid=}, {low=}, {high=}&#39;)</span>
    <span class="c1">#print(f&#39;mid val: {mid_val}&#39;)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="mf">0.15</span> <span class="o">&lt;</span> <span class="n">mid_val</span> <span class="o">&lt;</span> <span class="mf">0.85</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">mid</span> <span class="o">&lt;</span> <span class="mf">0.28</span> <span class="ow">and</span> <span class="p">(</span><span class="n">low</span> <span class="o">&gt;</span> <span class="n">mid</span> <span class="o">*</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="n">mid</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_norm_options"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.add_norm_options">[docs]</a><span class="k">def</span> <span class="nf">add_norm_options</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">):</span>
    <span class="c1"># TODO edit doc. copied from back before this was a decorator</span>
    <span class="c1"># TODO prob rewrite doc + fn to use str &#39;centered&#39; / &#39;two-slope&#39; instead of (more</span>
    <span class="c1"># complicated for user) classes</span>
    <span class="sd">&quot;&quot;&quot;Processes kwargs to allow passing non-instantiated `Normalize` subclasses.</span>

<span class="sd">    Args:</span>
<span class="sd">        norm: matplotlib expects str (e.g. &#39;linear&#39;, &#39;log&#39;, &#39;symlog&#39;, &#39;logit&#39;) or</span>
<span class="sd">            an instantiated `Normalize` subclass (or `None`), but passing a normalize</span>
<span class="sd">            subclass like this conflicts with non-`None` `vmin`|`vmax`. this function</span>
<span class="sd">            adds the option to pass a non-instantiated `Normalize` class, which will</span>
<span class="sd">            receive `vmin`|`vmax`, removing those from kwargs. this will let plotting</span>
<span class="sd">            functions determine the range of data to plot, while still allowing use of</span>
<span class="sd">            norms not able to be passed a str.</span>

<span class="sd">    Returns **kwargs, with vmin,vmax,norm modified when necessary.</span>
<span class="sd">        kwargs[&#39;norm&#39;] (if not str or None) will always be an instantiated `Normalize`</span>
<span class="sd">        subclass (unlike input, where it&#39;s allowed to also be non-instantiated).</span>

<span class="sd">    See https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.imshow.html</span>
<span class="sd">    for descriptions of `vmin`/`vmax`/`norm` kwargs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO possible to inspect whether wrapped fn already has defaults for vmin/vmax,</span>
    <span class="c1"># and use those if so (for dff_imshow in al_analysis)?</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped_plot_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;two-slope&#39;</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">TwoSlopeNorm</span>

        <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;centered&#39;</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">CenteredNorm</span>

        <span class="c1"># NOTE: TwoSlopeNorm/CenteredNorm (as defined in conditionals above) are classes</span>
        <span class="c1"># and not instances of them, and so the isinstance call will be False</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">vcenter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;explicit vcenter not supported in this case&#39;</span>
            <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">)</span>

        <span class="c1"># using None should give us consistent default behavior w/ plt.get_cmap</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_cmap_diverging</span><span class="p">(</span><span class="n">cmap</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;using seemingly non-diverging cmap (</span><span class="si">{</span><span class="n">cmap</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">) with &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">norm</span><span class="si">=}</span><span class="s1">, where center has special meaning. probably a mistake!&#39;</span>
            <span class="p">)</span>

        <span class="c1"># TODO also support discrete colormap here (instantiating from just str cmap</span>
        <span class="c1"># name)? would be to replace stuff like in al_analysis.plot_n_per_odor_and_glom</span>

        <span class="n">dmin</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">dmin</span>
            <span class="k">if</span> <span class="n">vcenter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">vmin</span> <span class="o">&gt;</span> <span class="n">vcenter</span>

        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">dmax</span>
            <span class="k">if</span> <span class="n">vcenter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">vcenter</span> <span class="o">&lt;</span> <span class="n">vmax</span>

        <span class="c1"># TODO could also try to instead check if norm takes vcenter kwarg?</span>
        <span class="c1"># are there actually any (builtin to matplotlib, at least) norms that take</span>
        <span class="c1"># vcenter besides these two?</span>
        <span class="n">centered_norm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">TwoSlopeNorm</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">CenteredNorm</span><span class="p">):</span>
            <span class="n">centered_norm</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">centered_norm</span> <span class="ow">and</span> <span class="n">vcenter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vcenter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">vmin</span> <span class="o">&gt;</span> <span class="n">vcenter</span><span class="p">:</span>
                <span class="c1"># TODO maybe warn in this case?</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># modifying vmin=0 for convenience when calling (when vcenter would also be 0),</span>
        <span class="c1"># rather than hardcoding vmin=-epsilon a bunch of places</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">vcenter</span><span class="p">:</span>
            <span class="c1"># NOTE: this would break CenteredNorm stuff below, but might want to</span>
            <span class="c1"># delete that option anyway...</span>
            <span class="c1">#</span>
            <span class="c1"># needs to actually be slightly less than 0, as vmin=vcenter triggers</span>
            <span class="c1"># same ValueError about vmin, vcenter, vmax not being in ascending order</span>
            <span class="n">old_vmin</span> <span class="o">=</span> <span class="n">vmin</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">vcenter</span> <span class="o">-</span> <span class="n">epsilon</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;setting </span><span class="si">{</span><span class="n">vmin</span><span class="si">=}</span><span class="s1"> (was </span><span class="si">{</span><span class="n">old_vmin</span><span class="si">}</span><span class="s1">) to make vmin &lt; </span><span class="si">{</span><span class="n">vcenter</span><span class="si">=}</span><span class="s1"> True&#39;</span>
            <span class="p">)</span>
            <span class="k">del</span> <span class="n">old_vmin</span>

        <span class="k">assert</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># could pop(&#39;vcenter&#39;, 0) from kwargs, as both Centered/TwoSlope take it, but i</span>
        <span class="c1"># think i prob always want it at 0 (the default for these)</span>
        <span class="c1"># TODO actually, probably do want to pop it (why?)</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">TwoSlopeNorm</span><span class="p">):</span>
            <span class="c1"># NOTE: if (vmin &lt; vcenter &lt; vmax) is not strictly True</span>
            <span class="c1"># (e.g. if vmin == vcenter), the following line would raise:</span>
            <span class="c1"># ValueError: vmin, vcenter, and vmax must be in ascending order</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">TwoSlopeNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="n">vcenter</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

            <span class="c1"># TODO test + doc clip behavior of TwoSlopeNorm (same as clip=False? True?)</span>

        <span class="c1"># TODO delete? even care about dynamically instantiated CenteredNorm in plotting</span>
        <span class="c1"># fns (maybe if i warn, but allow+process vmin/vmax not symmetric about 0?)?</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">CenteredNorm</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">vcenter</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">vmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># TODO TODO may need to take difference from vcenter first -&gt; add back?</span>
                <span class="nb">print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finish supporting vcenter in CenteredNorm case&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vmin</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vcenter</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

            <span class="c1"># TODO require/accept a halfrange kwarg? (mutex w/ vmin/vmax)</span>
            <span class="k">assert</span> <span class="n">vmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;halfrange calculation below assumes vmin &gt; 0 (center=0)&#39;</span>

            <span class="n">halfrange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
            <span class="c1"># NOTE: this has clip=False by default (UNLIKE two slope, which doesn&#39;t</span>
            <span class="c1"># support clip kwarg)</span>
            <span class="c1">#</span>
            <span class="c1"># regarding halfrange &quot;Defaults to the largest absolute difference to</span>
            <span class="c1"># vcenter for the values in the dataset.&quot;</span>
            <span class="c1"># TODO how does it do that? via what imshow does w/ norm input?</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">CenteredNorm</span><span class="p">(</span><span class="n">vcenter</span><span class="o">=</span><span class="n">vcenter</span><span class="p">,</span> <span class="n">halfrange</span><span class="o">=</span><span class="n">halfrange</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="c1"># TODO threshold fraction before warning?</span>
        <span class="c1"># TODO TODO only warn here if we can&#39;t show clipping in plot</span>
        <span class="c1"># (like w/ default TwoSlopeNorm [right?]) (and/or not configured to)</span>

        <span class="c1"># .&lt;op&gt;().&lt;op&gt;() should work w/ at least ndarrays and DataFrames</span>
        <span class="c1"># (e.g. for min/max/sum ops)</span>
        <span class="n">vmin_n_clipped</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">vmin_clipped_frac</span> <span class="o">=</span> <span class="n">vmin_n_clipped</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>
        <span class="n">clip_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">vmin_clipped_frac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">clip_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vmin_clipped_frac</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> of data (</span><span class="si">{</span><span class="n">vmin_n_clipped</span><span class="si">}</span><span class="s1"> points) &lt; </span><span class="si">{</span><span class="n">vmin</span><span class="si">=}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="n">vmax_n_clipped</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">vmax_clipped_frac</span> <span class="o">=</span> <span class="n">vmax_n_clipped</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">vmax_clipped_frac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">clip_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vmax_clipped_frac</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> of data (</span><span class="si">{</span><span class="n">vmax_n_clipped</span><span class="si">}</span><span class="s1"> points) &gt; </span><span class="si">{</span><span class="n">vmax</span><span class="si">=}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clip_msgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># TODO have this be an error by default, allowing decorator (/decorated</span>
            <span class="c1"># fn) to be run w/ warning instead, so that it can err if any of matshow</span>
            <span class="c1"># data is over/under (but more OK/expected to have imshow data over/under)</span>
            <span class="c1"># (just watch for plot_fn.__name__ == &#39;matshow&#39; in output...)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (add_norm_options wrapper): &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clip_msgs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># TODO delete</span>
        <span class="c1"># see notes in add_colorbar TwoSlopeNorm section for some hints about plots that</span>
        <span class="c1"># might be affected by this (maybe more plots affected by this fn than that</span>
        <span class="c1"># one?)</span>
        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plot_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: end of add_norm_options: </span><span class="si">{</span><span class="n">vmin</span><span class="si">=}</span><span class="s1">, </span><span class="si">{</span><span class="n">vmax</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#</span>

        <span class="c1"># not passing vmin/vmax, as matplotlib would raise ValueError since norm also</span>
        <span class="c1"># passed</span>
        <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapped_plot_fn</span></div>


<span class="c1"># Was originally wanting to make enable a kwarg, but it seems the code to do that would</span>
<span class="c1"># be excessively complicated. See norok2&#39;s answer here:</span>
<span class="c1"># https://stackoverflow.com/questions/5929107</span>
<span class="k">def</span> <span class="nf">_mpl_constrained_layout</span><span class="p">(</span><span class="n">enable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To make decorators for fns that create Figure(s) and need contrained layout on/off.</span>

<span class="sd">    Use `@constrained_layout` or `@no_constrained_layout` rather than this directly.</span>

<span class="sd">    NOTE: savefig call will often also have to happen inside the same kind of context</span>
<span class="sd">    manager, at least for calls like `seaborn.ClusterGrid.savefig`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrap_plot_fn</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            plot_fn: must make figure from start to finish inside, so changing</span>
<span class="sd">                constrained layout setting works</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapped_plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># TODO TODO doc how this interacts w/ ax passed in already having particular</span>
            <span class="c1"># layout. probably want to be able to override (e.g. to deal with matshow&#39;s</span>
            <span class="c1"># issue where once i start adding text (for group labels), constrained</span>
            <span class="c1"># layout can cut them off)</span>
            <span class="k">with</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s1">&#39;figure.constrained_layout.use&#39;</span><span class="p">:</span> <span class="n">enable</span><span class="p">}):</span>
                <span class="c1"># TODO maybe monkeypatch any .savefig methods on returned object to warn</span>
                <span class="c1"># about need to add context manager around that call too? or just</span>
                <span class="c1"># monkeypatch to have constrained layout forced to be consistent in any</span>
                <span class="c1"># savefig methods?</span>
                <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped_plot_fn</span>

    <span class="k">return</span> <span class="n">wrap_plot_fn</span>


<span class="c1"># TODO how to give these docstrings?</span>
<span class="n">constrained_layout</span> <span class="o">=</span> <span class="n">_mpl_constrained_layout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">no_constrained_layout</span> <span class="o">=</span> <span class="n">_mpl_constrained_layout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># TODO maybe combine w/ decorator to add title/xlabel/ylabel/etc kwargs + their</span>
<span class="c1"># reformatting (+ setting? some differences in how i do this, and would need Axes to</span>
<span class="c1"># call on...)</span>
<span class="k">def</span> <span class="nf">_ylabel_kwargs</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">ylabel_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Will no longer have same behavior as passing rotation=None explicitly to the</span>
    <span class="c1"># corresponding set_ylabel call, but would need another sentinel for unset</span>
    <span class="c1"># values than None to fix.</span>
    <span class="k">if</span> <span class="n">ylabel_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ylabel_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ylabel_rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ylabel_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;ylabel_rotation&#39;</span> <span class="ow">in</span> <span class="n">ylabel_kws</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;only specify either ylabel_rotation or &#39;</span>
                <span class="s2">&quot;ylabel_kws[&#39;rotation&#39;]&quot;</span>
            <span class="p">)</span>

        <span class="n">ylabel_kws</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ylabel_rotation</span>

    <span class="k">return</span> <span class="n">ylabel_kws</span>


<span class="n">_panel2order</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="set_panel2order"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.set_panel2order">[docs]</a><span class="k">def</span> <span class="nf">set_panel2order</span><span class="p">(</span><span class="n">panel2order</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Sets module-level dict mapping panels to order for plotting odors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_panel2order</span>
    <span class="n">_panel2order</span> <span class="o">=</span> <span class="n">panel2order</span></div>


<span class="n">_ax_id2order</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="c1"># TODO kwarg for specifying name of odor column?</span>
<div class="viewcode-block" id="with_panel_orders"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.with_panel_orders">[docs]</a><span class="k">def</span> <span class="nf">with_panel_orders</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">,</span> <span class="n">panel2order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">fn_kwargs</span><span class="p">):</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">plot_fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ordered_plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># If this fails, see code I adapted this from in</span>
        <span class="c1"># kc_natural_mixes/kc_mix_analysis.py</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;expected .map/.map_dataframe to pass all via **kwargs&#39;</span>

        <span class="k">nonlocal</span> <span class="n">panel2order</span>
        <span class="k">if</span> <span class="n">panel2order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">panel2order</span> <span class="o">=</span> <span class="n">_panel2order</span>

        <span class="k">if</span> <span class="n">panel2order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must either pass panel2order keyword argument, or call &#39;</span>
                <span class="s1">&#39;hong2p.viz.set_panel2order&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;use map_dataframe rather than map&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">fk</span><span class="p">,</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">fn_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">fk</span><span class="p">]</span> <span class="o">=</span> <span class="n">fv</span>

        <span class="c1"># TODO add unit test for this</span>
        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;when calling </span><span class="si">{</span><span class="n">plot_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> wrapped with &#39;</span>
                <span class="s1">&#39;with_panel_orders, pass panel2order to wrapper or use &#39;</span>
                <span class="s1">&#39;hong2p.viz.set_panel2order. do NOT pass order keyword argument &#39;</span>
                <span class="s1">&#39;to the wrapped function.&#39;</span>
            <span class="p">)</span>

        <span class="n">panels</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;panel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;each call to wrapped plot function must present data &#39;</span>
                <span class="s1">&#39;from a single panel&#39;</span>
            <span class="p">)</span>
        <span class="n">panel</span> <span class="o">=</span> <span class="n">panels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">panel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">panel2order</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">panel</span><span class="si">=}</span><span class="s1"> was not in </span><span class="si">{</span><span class="n">panel2order</span><span class="si">=}</span><span class="s1"> keys&#39;</span><span class="p">)</span>

        <span class="n">odor_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">data_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>

        <span class="n">odors</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">odor_col</span><span class="p">]</span>

        <span class="n">order</span> <span class="o">=</span> <span class="n">panel2order</span><span class="p">[</span><span class="n">panel</span><span class="p">]</span>

        <span class="c1"># It would be nice if I could just pass a panel2order dict in that worked if the</span>
        <span class="c1"># values were just the names of odors (sorting naturally on concentration), but</span>
        <span class="c1"># I don&#39;t see an easy way to do it, as `df` may contain different subsets of the</span>
        <span class="c1"># data across calls to wrapped plot functions.</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">o</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">odors</span><span class="p">])</span>

        <span class="c1"># TODO TODO TODO do i need to ensure that all the odors in the order are</span>
        <span class="c1"># present? data association getting broken yet?</span>

        <span class="c1"># TODO delete after some testing</span>
        <span class="c1"># TODO TODO TODO TODO confirm it is not a problem that this was failing</span>
        <span class="c1"># (i think there might be a containing axes object that is getting picked up?</span>
        <span class="c1"># not sure there is a mechanism to get most specific underlying one though...)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        ax_id = id(plt.gca())</span>
<span class="sd">        if ax_id in _ax_id2order:</span>
<span class="sd">            prev_order = _ax_id2order[ax_id]</span>
<span class="sd">            assert order == prev_order, \</span>
<span class="sd">                f&#39;previous order: {prev_order}\ncurrent order: {order}&#39;</span>
<span class="sd">        else:</span>
<span class="sd">            _ax_id2order[ax_id] = order</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>

        <span class="c1"># TODO TODO TODO do i need to deal with hues? (to keep consistent across</span>
        <span class="c1"># panels...) or does FacetGrid have me covered on that?</span>

        <span class="k">return</span> <span class="n">plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ordered_plot_fn</span></div>


<div class="viewcode-block" id="clustermap"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.clustermap">[docs]</a><span class="nd">@add_norm_options</span>
<span class="nd">@no_constrained_layout</span>
<span class="nd">@callable_ticklabels</span>
<span class="c1"># TODO TODO do [x|y]ticklabels now need to be extracted from kwargs? if seaborn doesn&#39;t</span>
<span class="c1"># handle that, then the @callable_ticklabels decorator is doing nothing here.</span>
<span class="c1"># TODO modify to call matshow internally, rather than relying on seaborn much/at all?</span>
<span class="c1"># (to get the convenience features i added to matshow...) (or at least make another</span>
<span class="c1"># decorator like callable_ticklabels to deal w/ [h|v]line_level_fn matshow kwargs)</span>
<span class="k">def</span> <span class="nf">clustermap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">optimal_ordering</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">row_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row_linkage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_linkage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">z_score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">standard_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_linkages</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Same as seaborn.clustermap but allows callable [x/y]ticklabels + adds opts.</span>

<span class="sd">    Adds `optimal_ordering` kwarg to `scipy.cluster.hierarchy.linkage` that is not</span>
<span class="sd">    exposed by seaborn version.</span>

<span class="sd">    Also turns off constrained layout for the duration of the seaborn function, to</span>
<span class="sd">    prevent warnings + disabling that would otherwise happen.</span>

<span class="sd">    Args:</span>
<span class="sd">        method: default &#39;average&#39; is same as `sns.clustermap`</span>
<span class="sd">        metric: default &#39;euclidean&#39; is same as `sns.clustermap`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">row_linkage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO or does seaborn already have passed row_linkage imply row_cluster=True?</span>
        <span class="n">row_cluster</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># seaborn will just show a subset of the data if passed a linkage of a smaller</span>
        <span class="c1"># shape. Not sure what happens in reverse case. Either way, I think failing</span>
        <span class="c1"># is safer.</span>
        <span class="n">expected_row_linkage_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row_linkage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_row_linkage_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;row_linkage.shape must be </span><span class="si">{</span><span class="n">expected_row_linkage_shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">col_linkage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">col_cluster</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">expected_col_linkage_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_linkage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_col_linkage_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;col_linkage.shape must be </span><span class="si">{</span><span class="n">expected_col_linkage_shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">valid_preproc_kw_values</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">z_score</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_preproc_kw_values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;z_score must be in </span><span class="si">{</span><span class="n">valid_preproc_kw_values</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">standard_scale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_preproc_kw_values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;standard_scale must be in </span><span class="si">{</span><span class="n">valid_preproc_kw_values</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cbar_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cbar_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cbar_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">cbar_kws</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbar_label</span>

    <span class="n">let_seaborn_compute_linkages</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">z_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">standard_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">row_linkage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">col_linkage</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">return_linkages</span><span class="p">:</span>
            <span class="c1"># TODO unless it&#39;s available in the seaborn object, or i want to</span>
            <span class="c1"># re-implement this preprocessing before my own linkage computations?</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;can not return linkages while z_score or &#39;</span>
                <span class="s1">&#39;standard_scale is True&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">optimal_ordering</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;disabling optimal_ordering since z_score or standard_scale&#39;</span><span class="p">)</span>
            <span class="n">optimal_ordering</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">let_seaborn_compute_linkages</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_score</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;standard_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standard_scale</span>

    <span class="c1"># TODO if z-scoring / standard-scaling requested, calculate before in this case</span>
    <span class="c1"># (so it actually affects linkage, as it would w/ seaborn version)</span>
    <span class="c1"># (currently just disabling optimal ordering in these cases)</span>
    <span class="k">def</span> <span class="nf">_linkage</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="c1"># TODO way to get this to work w/ some NaNs? worth it?</span>
        <span class="k">return</span> <span class="n">linkage</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">optimal_ordering</span><span class="o">=</span><span class="n">optimal_ordering</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">let_seaborn_compute_linkages</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row_cluster</span> <span class="ow">and</span> <span class="n">row_linkage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row_linkage</span> <span class="o">=</span> <span class="n">_linkage</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># This behavior of when to transpose for which linkage is consistent w/ seaborn</span>
        <span class="c1"># (I read clustermap implementation)</span>
        <span class="k">if</span> <span class="n">col_cluster</span> <span class="ow">and</span> <span class="n">col_linkage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">col_linkage</span> <span class="o">=</span> <span class="n">_linkage</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># TODO assert len(df) &gt; 0 (both dims?) early on / raise ValueError</span>
    <span class="c1"># clustermap call will fail in this case, w/ somewhat confusing error message:</span>
    <span class="c1"># ValueError: zero-size array to reduction operation fmin which has no identity</span>

    <span class="n">clustergrid</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">row_cluster</span><span class="o">=</span><span class="n">row_cluster</span><span class="p">,</span> <span class="n">col_cluster</span><span class="o">=</span><span class="n">col_cluster</span><span class="p">,</span>
        <span class="n">row_linkage</span><span class="o">=</span><span class="n">row_linkage</span><span class="p">,</span> <span class="n">col_linkage</span><span class="o">=</span><span class="n">col_linkage</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
        <span class="n">cbar_kws</span><span class="o">=</span><span class="n">cbar_kws</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clustergrid</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This will overwrite whatever labels the seaborn call slaps on</span>
        <span class="n">clustergrid</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ylabel_kws</span> <span class="o">=</span> <span class="n">_ylabel_kwargs</span><span class="p">(</span>
            <span class="n">ylabel_rotation</span><span class="o">=</span><span class="n">ylabel_rotation</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="n">ylabel_kws</span>
        <span class="p">)</span>
        <span class="n">clustergrid</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="o">**</span><span class="n">ylabel_kws</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_linkages</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">clustergrid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># can use scipy.cluster.hierarchy.leaves_list to get order of input data from</span>
        <span class="c1"># these linkages</span>
        <span class="k">return</span> <span class="n">clustergrid</span><span class="p">,</span> <span class="n">row_linkage</span><span class="p">,</span> <span class="n">col_linkage</span></div>


<span class="c1"># TODO appropriate type hints for x and y? Sequence[str]?</span>
<div class="viewcode-block" id="add_group_labels_and_lines"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.add_group_labels_and_lines">[docs]</a><span class="k">def</span> <span class="nf">add_group_labels_and_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">formatter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">label_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_name_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        **kwargs: passed thru to `ax.text` calls for group text labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO validation on length of x/y? what to check against? doc, if i come up</span>
    <span class="c1"># with something (check against [x|y]ticklabels, from Axes [assuming already set]?)</span>

    <span class="c1"># TODO maybe allow specifying both in one call?</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must only specify x OR y&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">line_fn</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span>
        <span class="c1"># TODO modify so it&#39;s above axes, not below (2024-06-05: still relevant?)</span>
        <span class="n">group_text_coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_offset</span> <span class="o">=</span> <span class="mf">0.08</span>

    <span class="k">elif</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">line_fn</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span>
        <span class="n">group_text_coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_offset</span> <span class="o">=</span> <span class="mf">0.12</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must specify either x/y&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lines</span> <span class="ow">or</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;at least one of lines/labels must be True&#39;</span><span class="p">)</span>

    <span class="c1"># TODO lines showing extent that each text label applies to?</span>
    <span class="c1"># (e.g. parallel to labelled axis, with breaks between levels? might crowd fly</span>
    <span class="c1"># labels less than separator lines perpendicular to axis)</span>
    <span class="c1"># TODO make linewidth a constant fration of cell width/height (whichever is</span>
    <span class="c1"># appropriate) (at least by default) ~(figsize[i] / df.shape[i])?</span>
    <span class="c1"># TODO what is default linewidth here anyway? unclear. 1?</span>
    <span class="c1"># TODO default to only formatting together index levels not used by</span>
    <span class="c1"># [h|v]line_level_fn (possible?), when ?</span>

    <span class="c1"># TODO modify const_ranges to have include_val=True behavior be default?</span>
    <span class="c1"># (+ delete switching flag, if so)</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">const_ranges</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">include_val</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If all the ranges have the same start and stop, all groups are length 1, and</span>
    <span class="c1"># the lines would just add visual noise, rather than helping clarify boundaries</span>
    <span class="c1"># between groups.</span>
    <span class="k">if</span> <span class="n">lines</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">]):</span>
        <span class="n">line_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># TODO if we have a lot of matrix elements, may want to decrease size of</span>
        <span class="c1"># line a bit to not approach size of matrix elements...</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line_positions</span><span class="p">:</span>
            <span class="c1"># TODO delete try/except. not sure i can repro this error...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># &#39;w&#39;=white. https://matplotlib.org/stable/tutorials/colors/colors.html</span>
                <span class="n">line_fn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">linecolor</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

    <span class="c1"># TODO allow separating group text from levels? accept yet another fn mapping</span>
    <span class="c1"># from [v|h]line_levels (dict level name -&gt; value form?) to formatted strs?</span>
    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span><span class="o">*</span><span class="n">group_text_coords</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">text_fn</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)),</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">label_offset</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">text_fn</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
                <span class="c1"># TODO compute group_label_offset? way to place the text using</span>
                <span class="c1"># constrained layout?</span>
                <span class="c1"># TODO possible to get this work w/ constrained layout /</span>
                <span class="c1"># bbox_inches=&#39;tight&#39; (work w/ either as-is?)?</span>
                <span class="c1"># TODO what happens is label is not str? does nothing? why not erring?</span>
                <span class="c1"># or is it not displaying for another reason? (converting via str didn&#39;t</span>
                <span class="c1"># seem to change anything...)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="n">label_offset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)),</span> <span class="n">label</span><span class="p">,</span>
                    <span class="c1"># Right might make consistent spacing wrt line indicating extent of</span>
                    <span class="c1"># group easier to see.</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                    <span class="c1"># for 9x9 input at least, va=&#39;center&#39; was better than without</span>
                    <span class="c1"># (though still seemed *slightly* above corresponding ticklabel)</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="c1"># TODO TODO how is above text seemingly not clipped and in layout, but</span>
                <span class="c1"># not showing up after constrained layout, and getting that warning:</span>
                <span class="c1"># ./test_matshow.py:41: UserWarning: constrained_layout not applied</span>
                <span class="c1"># because axes sizes collapsed to zero.  Try making figure larger or</span>
                <span class="c1"># axes decorations smaller.</span>
                <span class="c1"># ipdb&gt; text.get_in_layout()</span>
                <span class="c1"># True</span>
                <span class="c1"># ipdb&gt; text.get_clip_on()</span>
                <span class="c1"># False</span>
                <span class="c1"># TODO TODO can i register (some restricted version of?)</span>
                <span class="c1"># warnings.filterwarnings(&#39;error&#39;,</span>
                <span class="c1">#     message=&#39;constrained_layout not applied.*&#39;</span>
                <span class="c1"># )</span>
                <span class="c1"># here? (to ensure text is either fully shown or there is an error)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="c1"># NOTE: may need to tweak this offset if current value is causing</span>
            <span class="c1"># constrained layout warning for a given call</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label_offset</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;group labels:&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="c1"># assuming const_ranges index output wouldn&#39;t change by formatting</span>
            <span class="k">if</span> <span class="n">formatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">text_fn</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">=}</span><span class="s1"> (</span><span class="si">{</span><span class="n">start</span><span class="si">=}</span><span class="s1">, </span><span class="si">{</span><span class="n">stop</span><span class="si">=}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO ideally allow configuring such that it could also be centered on</span>
            <span class="c1"># relevant axis (rather than off to one side), but then would have to place</span>
            <span class="c1"># in a way not relying on text_fn... (or would at least need to modify</span>
            <span class="c1"># text_fns)</span>
            <span class="n">text_fn</span><span class="p">(</span><span class="n">label_name</span><span class="p">,</span> <span class="o">-</span><span class="n">label_name_offset</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">label_name_offset</span><span class="p">)</span></div>


<span class="c1"># TODO consider calling sns.heatmap internally? or replacing some uses of this w/ that?</span>
<span class="c1"># TODO may want to add xlabel / ylabel kwargs to be consistent w/ my clustermap wrapper,</span>
<span class="c1"># but then again i&#39;m currently using xlabel for a &quot;title&quot; here...</span>
<span class="c1"># TODO do any uses of this actually use the returned `im` (output of plt.matshow)?</span>
<span class="c1"># if not, maybe delete?</span>
<span class="c1"># TODO modify group_ticklabels / add option to support contiguous, but varying-length,</span>
<span class="c1"># groups (bar along edge of plot indicating extent of group label + group label placed</span>
<span class="c1"># by center of that bar)</span>
<span class="c1"># TODO try to delete levels_from_labels (transitioning to only the == False case)</span>
<span class="c1"># TODO TODO try options to specify figsize in terms of inches per row/col in dataframe</span>
<span class="c1"># (maybe plus some offset for legends, etc) (might wanna move to a constant fontsize in</span>
<span class="c1"># that case)</span>
<span class="c1"># TODO also allow specifying just index levels for [h|v]line_levels, rather than needing</span>
<span class="c1"># functions?</span>
<span class="c1"># TODO TODO make default behavior show all ticklabels (of any multiindices), and only if</span>
<span class="c1"># [x|y]ticklabels=False don&#39;t. might be a bit of work to have defaults look reasonable</span>
<span class="c1"># in a wide variety of cases tho... (mostly b/c fontsize issues?)?</span>
<div class="viewcode-block" id="matshow"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.matshow">[docs]</a><span class="nd">@add_norm_options</span>
<span class="c1"># TODO TODO should i move off of constrained layout, now that it&#39;s giving me issues</span>
<span class="c1"># placing group labels via ax.text (may just need to manually tweak an offset for each</span>
<span class="c1"># plot, without changing implementation substantially...)</span>
<span class="nd">@constrained_layout</span>
<span class="nd">@callable_ticklabels</span>
<span class="c1"># TODO TODO should be raising a warning by default if [h|v]line_level_fn not producing</span>
<span class="c1"># any divisions</span>
<span class="k">def</span> <span class="nf">matshow</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ticklabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">xtickrotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_ticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vline_level_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hline_level_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vline_group_text</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">hline_group_text</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># TODO combine [h|v]line_group_text into these, using True for no formatting?</span>
    <span class="c1"># (or these into former...)</span>
    <span class="n">vgroup_formatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hgroup_formatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="c1"># TODO TODO can maybe specify in axes coords w/ new blended transform approach i&#39;m</span>
    <span class="c1"># trying</span>
    <span class="c1"># TODO move fontsize default out too. too big for small matrices (e.g. 9x9)</span>
    <span class="c1"># TODO what value to use for axes-coords offets? still need these kwargs to vary?</span>
    <span class="c1"># TODO rename label-&gt;text to be consistent (or vice versa)</span>
    <span class="c1"># TODO rename h/v -&gt; x/y for easier understanding?</span>
    <span class="c1"># these values seemed ok for 9x9 sensitivity analysis input</span>
    <span class="c1"># (but causing issues w/ plot_n_per_odor_and_glom plot, and probably also similar</span>
    <span class="c1"># old top-level al_analysis ijroi plots)</span>
    <span class="n">vgroup_label_offset</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">hgroup_label_offset</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span>
    <span class="n">vgroup_label_rotation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span>
    <span class="n">hgroup_label_rotation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span>
    <span class="n">group_fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">group_fontweight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bigtext_fontsize_scaler</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">inches_per_cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose_sort_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cbar_shrink</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">levels_from_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_duplicate_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">xticks_also_on_bottom</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">overlay_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">overlay_fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span>
    <span class="n">overlay_kws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># TODO doc [v|h]line_group_text</span>
    <span class="c1"># TODO check that levels_from_labels means *_level_fn get a single dict as input,</span>
    <span class="c1"># not an iterable of dicts (or update doc)</span>
    <span class="c1"># TODO in levels_from_labels doc, specify what would be doing the formatting of</span>
    <span class="c1"># ticklabels (presumably it&#39;s just the callable passed in for [x|y]ticklabels, which</span>
    <span class="c1"># is expected to map to str (from what again?)?, or nothing if input is single level</span>
    <span class="c1"># str index? what happens if [x|y]ticklabels input is not callable and input data</span>
    <span class="c1"># does not have a single level str index?)</span>
    <span class="c1"># TODO switch levels_from_labels default to False? would prob need to change a fair</span>
    <span class="c1"># bit of al_analysis code...</span>
    <span class="c1"># TODO accept str level names for specifying [v|h]line_levels (maybe rename</span>
    <span class="c1"># [v|h]line_level_fn to include this type of input?)</span>
    <span class="c1"># TODO + support labelling level names off to side in that case?</span>
    <span class="c1"># TODO am i supporting False for [x|y]ticklabels? how else to hide default</span>
    <span class="c1"># regularly-spaced int ones?</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        transpose_sort_key (None | function): takes df.index/df.columns and compares</span>
<span class="sd">            output to decide whether matrix should be transposed before plotting</span>

<span class="sd">        vline_level_fn: callable whose output varies along axis labels/index (see</span>
<span class="sd">            `levels_from_labels` for details). vertical lines will be drawn between</span>
<span class="sd">            changes in the output of this function.</span>

<span class="sd">        hline_level_fn: as `vline_level_fn`, but for horizontal lines.</span>

<span class="sd">        [h|v]group_formatter: optional function to map group values to str</span>

<span class="sd">        [h|v]group_label_offset: in axes (not data) coordinates. should probably be in</span>
<span class="sd">            [0, 1] and pretty close to 0. increase if constrained layout warning emitted</span>
<span class="sd">            when showing / saving plot.</span>

<span class="sd">        [h|v]group_label_rotation: passed to `rotation` of corresponding `Axes.text`</span>
<span class="sd">            call</span>

<span class="sd">        levels_from_labels: if True, `[h|v]line_level_fn` functions use formatted</span>
<span class="sd">            `[x|y]ticklabels` as input. Otherwise, a dict mapping index level names to</span>
<span class="sd">            values are used. Currently only support drawing labels for each group if</span>
<span class="sd">            this is False (still true?).</span>

<span class="sd">        xticks_also_on_bottom: if True, show same xticks on bottom as will be shown on</span>
<span class="sd">            top. for very tall plots where we can sometimes more easily reference the</span>
<span class="sd">            bottom than the top, when scrolling through.</span>

<span class="sd">        overlay_values: if True, overlays text with numerical value for each cell</span>

<span class="sd">        overlay_fmt: float format str, used to format `overlay_values` text</span>

<span class="sd">        overlay_kws: optional dict of kwargs to pass to overlay `ax.text` calls</span>

<span class="sd">        **kwargs: passed thru to `matplotlib.pyplot.matshow`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># added after reverting callable_ticklabels code that would do the same,</span>
    <span class="c1"># which was needed to continue using w/ sns.clustermap</span>
    <span class="k">if</span> <span class="n">xticklabels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">xticklabels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">yticklabels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">yticklabels</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># NOTE: if i&#39;d like to also sort on [x/y]ticklabels, would need to move this block</span>
    <span class="c1"># after possible ticklabel enumeration, and then assign correctly to index/cols and</span>
    <span class="c1"># use that as input to sort_key_val in appropriate instead</span>
    <span class="k">if</span> <span class="n">transpose_sort_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ticklabels</span><span class="p">,</span> <span class="n">xticklabels</span><span class="p">,</span> <span class="n">yticklabels</span><span class="p">]]):</span>
            <span class="c1"># TODO maybe update just to only allowing `ticklabels` (since then x,y</span>
            <span class="c1"># should be the same, which i think is the only case where we do want</span>
            <span class="c1"># transpose_sort_key anyway)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;transpose_sort_key not supported if any &#39;</span>
                <span class="s1">&#39;ticklabels are explicitly passed&#39;</span>
            <span class="p">)</span>

        <span class="n">row_sort_key</span> <span class="o">=</span> <span class="n">transpose_sort_key</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">col_sort_key</span> <span class="o">=</span> <span class="n">transpose_sort_key</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">row_sort_key</span> <span class="o">&gt;</span> <span class="n">col_sort_key</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># TODO shouldn&#39;t this get ticklabels from matrix if nothing else?</span>
    <span class="c1"># maybe at least in the case when both columns and row indices are all just</span>
    <span class="c1"># one level of strings?</span>
    <span class="k">if</span> <span class="n">inches_per_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;only specify one of inches_per_cell or figsize&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extra_figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">extra_width</span><span class="p">,</span> <span class="n">extra_height</span> <span class="o">=</span> <span class="n">extra_figsize</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">inches_per_cell</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra_width</span><span class="p">,</span>
            <span class="n">inches_per_cell</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra_height</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">extra_figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;extra_figsize must be specified with inches_per_cell&#39;</span><span class="p">)</span>

    <span class="c1"># TODO warn if ax not set? or at least in the case where plt.gca() returns</span>
    <span class="c1"># something? (to make sure we aren&#39;t making figures that don&#39;t get populated/closed)</span>
    <span class="c1"># (factor this check into wrapper shared w/ imshow?)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;figsize only allowed if ax not passed in&#39;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

    <span class="c1"># TODO can probably delete this and replace w/ usage of format_index_row, maybe with</span>
    <span class="c1"># some slight modifications</span>
    <span class="k">def</span> <span class="nf">is_one_level_str_index</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">xticklabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yticklabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ticklabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO maybe default to joining str representations of values at each level,</span>
            <span class="c1"># joined on some kwarg delim like &#39;/&#39;?</span>
            <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">is_one_level_str_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">is_one_level_str_index</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO TODO assert indices are actually equal</span>
            <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># TODO is this even possible at this point? if so, why not handled by</span>
            <span class="c1"># callable_ticklabels wrapper?</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">):</span>
                <span class="n">ticklabels</span> <span class="o">=</span> <span class="n">matlabels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ticklabels</span><span class="p">)</span>

            <span class="c1"># TODO should i check output is same on rows/cols in this case?</span>
            <span class="c1"># currently, matlabels seems to just operate on the row labels...</span>
            <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">ticklabels</span>
            <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">ticklabels</span>

    <span class="c1"># TODO update this formula to work w/ gui corrs (too big now)</span>
    <span class="c1"># TODO see whether default font actually is inappropriate in any cases where i&#39;m</span>
    <span class="c1"># currently calling this (particularly using constrained layout from</span>
    <span class="c1"># al_analysis.py)</span>
    <span class="k">if</span> <span class="n">fontsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO delete this... more trouble than it&#39;s worth these days</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">240.0</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">bigtext_fontsize</span> <span class="o">=</span> <span class="n">bigtext_fontsize_scaler</span> <span class="o">*</span> <span class="n">fontsize</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cbar_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cbar_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># TODO TODO automatically set default extend=&#39;both&#39;|&#39;min&#39;|&#39;max&#39;|&#39;neither&#39; based</span>
        <span class="c1"># on which limits actually exceeded by data?</span>

        <span class="c1"># TODO TODO use same extend= kwarg logic as i settle on for image_grid? refactor</span>
        <span class="c1"># to share? (want to be able to show clipped data in both cases)</span>
        <span class="c1">#</span>
        <span class="c1"># rotation=270?</span>
        <span class="c1"># TODO thread fontsize thru this?</span>
        <span class="c1"># TODO TODO add option to fix size to that of axes we are stealing from</span>
        <span class="c1"># (or maybe to set size relative to those?)?</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">add_colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="n">cbar_shrink</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">bigtext_fontsize</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_kws</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">group_fontsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">group_fontsize</span> <span class="o">=</span> <span class="n">bigtext_fontsize</span>

    <span class="c1"># TODO delete?</span>
    <span class="k">def</span> <span class="nf">grouped_labels_info</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group_ticklabels</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># TODO TODO delete remove_consecutive_repeats stuff (replacing w/</span>
        <span class="c1"># util.const_ranges based code, which i&#39;m already using below, and which [unlike</span>
        <span class="c1"># this] supports variable numbers of repeats)?</span>
        <span class="n">without_consecutive_repeats</span><span class="p">,</span> <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">remove_consecutive_repeats</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">tick_step</span> <span class="o">=</span> <span class="n">n_repeats</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">n_repeats</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">without_consecutive_repeats</span><span class="p">,</span> <span class="n">tick_step</span><span class="p">,</span> <span class="n">offset</span>

    <span class="c1"># TODO skip if either is None?</span>
    <span class="c1"># TODO make fontsize / weight more in group_ticklabels case?</span>
    <span class="n">xticklabels</span><span class="p">,</span> <span class="n">xstep</span><span class="p">,</span> <span class="n">xoffset</span> <span class="o">=</span> <span class="n">grouped_labels_info</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">)</span>
    <span class="n">yticklabels</span><span class="p">,</span> <span class="n">ystep</span><span class="p">,</span> <span class="n">yoffset</span> <span class="o">=</span> <span class="n">grouped_labels_info</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">)</span>
    <span class="c1">#</span>

    <span class="k">if</span> <span class="n">_debug</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hline_level_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">vline_level_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">levels_from_labels</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">hline_levels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">hline_level_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hline_level_fn</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">levels_from_labels</span><span class="p">:</span>
            <span class="c1"># TODO need to handle case where we might transpose (e.g. via</span>
            <span class="c1"># transpose_sort_key?) (or maybe delete support for transpose_sort_key?)</span>
            <span class="n">hline_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">hline_level_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">index2dict_list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hline_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">hline_level_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">yticklabels</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hline_levels:&#39;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">hline_levels</span><span class="p">)</span>

    <span class="n">vline_levels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">vline_level_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vline_level_fn</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">levels_from_labels</span><span class="p">:</span>
            <span class="n">vline_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vline_level_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">index2dict_list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vline_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vline_level_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xticklabels</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;vline_levels:&#39;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">vline_levels</span><span class="p">)</span>

    <span class="c1"># TODO TODO factor out? what all do i actually want tho...</span>
    <span class="c1"># TODO TODO need to combine into one fn that also adds group labels (so we have</span>
    <span class="c1"># access to group labels for allow_duplicate_labels=False checks)</span>
    <span class="c1">#</span>
    <span class="c1"># TODO allow specifying `x=labels` (in kwargs) instead of `x_or_y=&#39;x&#39;, labels`</span>
    <span class="c1"># (and same for y, if so)?</span>
    <span class="c1"># TODO type hint for labels? Sequence[str]?</span>
    <span class="k">def</span> <span class="nf">set_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span><span class="p">,</span> <span class="n">x_or_y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="c1"># TODO delete allow_duplicate_labels here if i don&#39;t end up factoring this inner</span>
        <span class="c1"># fn out of matshow</span>
        <span class="n">allow_duplicate_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">assert</span> <span class="n">x_or_y</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

        <span class="c1"># TODO allow_duplicate_labels=&#39;warn&#39; option, and make that default?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_duplicate_labels</span><span class="p">:</span>
            <span class="c1"># TODO refactor?</span>
            <span class="k">if</span> <span class="n">x_or_y</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vline_group_text</span> <span class="ow">and</span> <span class="n">vline_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">to_check</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vline_levels</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;duplicate (vline_level, xticklabel) combinations&#39;</span>

            <span class="k">elif</span> <span class="n">x_or_y</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hline_group_text</span> <span class="ow">and</span> <span class="n">hline_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">to_check</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">hline_levels</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;duplicate (hline_level, yticklabel) combinations&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_check</span> <span class="o">=</span> <span class="n">labels</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;duplicate </span><span class="si">{</span><span class="n">x_or_y</span><span class="si">}</span><span class="s1">ticklabels&#39;</span>

                <span class="c1"># TODO TODO only print something like this if doing so would actually</span>
                <span class="c1"># remove duplicates?</span>
                <span class="c1"># TODO just make [v|h]line_group_text=True the default in these cases,</span>
                <span class="c1"># rather than erring, no? there aren&#39;t even duplicates here are there?</span>
                <span class="c1"># TODO at least dont include these parts of the err msg if</span>
                <span class="c1"># [v|h]line_group_text are already True...</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">x_or_y</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">and</span> <span class="n">vline_level_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">vline_group_text</span><span class="p">):</span>

                    <span class="n">err_msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;. specifying vline_group_text=True may resolve &#39;</span>
                        <span class="s1">&#39;duplicates.&#39;</span>
                    <span class="p">)</span>

                <span class="k">elif</span> <span class="p">(</span><span class="n">x_or_y</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="ow">and</span> <span class="n">hline_level_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">hline_group_text</span><span class="p">):</span>

                    <span class="n">err_msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;. specifying hline_group_text=True may resolve &#39;</span>
                        <span class="s1">&#39;duplicates.&#39;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_check</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">to_check</span><span class="p">)):</span>

                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s1">&#39; duplicated entries, with counts:</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">to_check</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">err_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>

                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s1">&#39;you may also set allow_duplicate_labels=True&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">x_or_y</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="n">set_fn</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span>
        <span class="k">elif</span> <span class="n">x_or_y</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">set_fn</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">set_fn</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Intended to catch stuff like:</span>
        <span class="c1"># &quot;ValueError: The number of FixedLocator locations (19), usually from a call to</span>
        <span class="c1"># set_ticks, does not match the number of ticklabels (16).&quot;</span>
        <span class="c1"># ...so we can provide more additional debug info.</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Debug info for following matplotlib error:</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_or_y</span><span class="si">}</span><span class="s1">ticklabels=</span><span class="si">{</span><span class="n">pformat</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="p">)</span>
            <span class="k">raise</span>


    <span class="k">if</span> <span class="n">xticklabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO nan / None value aren&#39;t supported in ticklabels are they?</span>
        <span class="c1"># (couldn&#39;t assume len is defined if so)</span>
        <span class="k">if</span> <span class="n">xtickrotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO delete this guesswork and just back a default probably...</span>
            <span class="c1"># (yea, it&#39;s causing TypeErrors w/o clear explanation)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xticklabels</span><span class="p">]):</span>
                <span class="n">xtickrotation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xtickrotation</span> <span class="o">=</span> <span class="s1">&#39;vertical&#39;</span>

        <span class="c1"># TODO what was the purpose of this? to ensure each is shown?</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">xstep</span><span class="p">)</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span>

        <span class="n">set_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="p">,</span>
            <span class="n">allow_duplicate_labels</span><span class="o">=</span><span class="n">allow_duplicate_labels</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="n">fontweight</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">xtickrotation</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">yticklabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">ystep</span><span class="p">)</span> <span class="o">+</span> <span class="n">yoffset</span><span class="p">)</span>

        <span class="n">set_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">yticklabels</span><span class="p">,</span>
            <span class="n">allow_duplicate_labels</span><span class="o">=</span><span class="n">allow_duplicate_labels</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="n">fontweight</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">hline_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">add_group_labels_and_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">hline_levels</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">hline_group_text</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="n">hgroup_formatter</span><span class="p">,</span> <span class="n">label_offset</span><span class="o">=</span><span class="n">hgroup_label_offset</span><span class="p">,</span>
            <span class="n">rotation</span><span class="o">=</span><span class="n">hgroup_label_rotation</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">linecolor</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">group_fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="n">group_fontweight</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">vline_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">add_group_labels_and_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vline_levels</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">vline_group_text</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="n">vgroup_formatter</span><span class="p">,</span> <span class="n">label_offset</span><span class="o">=</span><span class="n">vgroup_label_offset</span><span class="p">,</span>
            <span class="n">rotation</span><span class="o">=</span><span class="n">vgroup_label_rotation</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">linecolor</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">group_fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="n">group_fontweight</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span>
        <span class="p">)</span>

    <span class="c1"># TODO precompute constrained layout here, and check that no group / xticklabel text</span>
    <span class="c1"># overlaps (or that group text doesn&#39;t go out of bounds?). and/or provide fn for</span>
    <span class="c1"># this (layout might change if stuff added later...). all this is just for lack of a</span>
    <span class="c1"># good way to layout text and ensure it doesn&#39;t overlap / is seen, as i understand</span>
    <span class="c1"># it...</span>

    <span class="c1"># TODO change xlabel/ylabel defaults from None-&gt;True?</span>
    <span class="c1"># (at least if only one level for each?)</span>
    <span class="k">def</span> <span class="nf">_names_to_label</span><span class="p">(</span><span class="n">curr_label</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">curr_label</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">curr_label</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="k">return</span> <span class="n">curr_label</span>


    <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;currently title also uses xlabel in this fn&#39;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">xlabel</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">_names_to_label</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">bigtext_fontsize</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">_names_to_label</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ylabel_kws</span> <span class="o">=</span> <span class="n">_ylabel_kwargs</span><span class="p">(</span>
            <span class="n">ylabel_rotation</span><span class="o">=</span><span class="n">ylabel_rotation</span><span class="p">,</span> <span class="n">ylabel_kws</span><span class="o">=</span><span class="n">ylabel_kws</span>
        <span class="p">)</span>
        <span class="c1"># TODO allow ylabel_kws to override bigtext_fontsize (w/ &#39;fontsize&#39; key)?</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">bigtext_fontsize</span><span class="p">,</span> <span class="o">**</span><span class="n">ylabel_kws</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">xticks_also_on_bottom</span><span class="p">:</span>
        <span class="c1"># didn&#39;t seem to do what i was expecting</span>
        <span class="c1">#ax.spines[&#39;bottom&#39;].set_visible(False)</span>
        <span class="c1"># TODO this implicitly make them shown at top?</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO difference between top and labeltop? former always required for latter?</span>
        <span class="c1"># https://stackoverflow.com/questions/55289921</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labeltop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># TODO test w/ input that is not symmetric</span>
    <span class="c1"># (thought this same code caused issues in one of the al_analysis N-plotting fns.</span>
    <span class="c1"># seemed to work in al_analysis.plot_corr tho)</span>
    <span class="k">if</span> <span class="n">overlay_values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">overlay_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">overlay_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># https://stackoverflow.com/questions/20998083</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="c1"># TODO color visible enough? way to put white behind?</span>
            <span class="c1"># or just use some color distinguishable from whole colormap?</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">:{</span><span class="n">overlay_fmt</span><span class="si">}}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">overlay_kws</span><span class="p">)</span>

    <span class="c1"># TODO also return ax?</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">im</span></div>


<span class="c1"># TODO TODO keep making/returning figure (none of current uses seem to. delete!)?</span>
<span class="c1"># (actually they all do, as none pass in ax, but also none use returned fig)</span>
<span class="c1">#</span>
<span class="c1"># TODO TODO want to keep title/cmap handling? replace cmap w/ **kwargs?</span>
<span class="c1"># (only hong2p/scripts/extract_template.py and hong2p/roi.py currently seem to use</span>
<span class="c1"># this. al_analysis dff_imshow could maybe be replaced by this (or image_grid?))</span>
<span class="c1"># TODO type hint img (arraylike?)</span>
<div class="viewcode-block" id="imshow"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.imshow">[docs]</a><span class="nd">@add_norm_options</span>
<span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">DEFAULT_ANATOMICAL_CMAP</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># TODO warn if ax not set? or at least in the case where plt.gca() (/gcf?) returns</span>
    <span class="c1"># something? (to make sure we aren&#39;t making figures that don&#39;t get populated/closed)</span>
    <span class="c1"># (factor this check into wrapper shared w/ matshow?)</span>
    <span class="c1"># (could test by removing the ax=ax from the imshow call inside image_grid, where i</span>
    <span class="c1"># originally noticed issues as a result of this)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># none of the cases i was calling this actually used returned figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="c1"># TODO better name for output (indicating type, ideally)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="c1"># TODO option to disable this?</span>
    <span class="c1"># NOTE: this used to be ax.axis(&#39;off&#39;), may have broken some code expecting its</span>
    <span class="c1"># behavior (also hiding labels, other things?)</span>
    <span class="n">remove_axes_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">im</span></div>


<span class="c1"># TODO type hint matplotlib.cm.ScalarMappable for im (as in mpl docs)?</span>
<span class="c1"># TODO possible to get it to work reasonably w/o explicit im passed in?</span>
<span class="c1"># (maybe use a generic ScalarMappable as</span>
<span class="c1"># https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.colorbar.html talks about</span>
<span class="c1"># in this case?) or behave as `plt.colorbar` does in that case (also mentioned in link)</span>
<span class="c1">#</span>
<span class="c1"># TODO TODO TODO even when im is passed in, should i check all axes have the same</span>
<span class="c1"># vmin/vmax as im? (or if im not passed, check they are all the same? there should be</span>
<span class="c1"># multiple colorbars otherwise, right? what happens currently?)</span>
<span class="c1"># TODO TODO TODO warn (unless flag set False) if any values would be clipped? especially</span>
<span class="c1"># if extend=&#39;both&#39; not passed.</span>
<span class="c1"># TODO TODO or automatically set_[over|under] if needed (to show which things are</span>
<span class="c1"># clipped)? test it actually shows correctly in all cases (rather than pre-clipping or</span>
<span class="c1"># something)</span>
<span class="c1"># TODO TODO maybe search any AxesImages in fig and do same for all of them (if sharing a</span>
<span class="c1"># colorbar... can i tell that in here tho?)</span>
<div class="viewcode-block" id="add_colorbar"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.add_colorbar">[docs]</a><span class="k">def</span> <span class="nf">add_colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">:</span> <span class="n">Figure</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">match_axes_size</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">axes_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="c1"># TODO delete if not useful. trying to add support for ImageGrid cax&#39;s</span>
    <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Colorbar</span><span class="p">:</span>
    <span class="c1"># TODO TODO does size= steal that size from specified ax tho? answer change</span>
    <span class="c1"># depending on whether we are using constrained layout or not?</span>
    <span class="c1">#</span>
    <span class="c1"># TODO TODO TODO support matching single axes when input has one col + many rows</span>
    <span class="c1"># TODO TODO support putting colorbar at bottom (with text horizontal then)</span>
    <span class="c1"># (and also matching axes width there)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        fig: figure to add colorbar to</span>

<span class="sd">        im: typically output of a `ax.imshow`/similar call</span>
<span class="sd">            see `Figure.colorbar` docs for more details:</span>
<span class="sd">            https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.colorbar</span>

<span class="sd">        match_axes_size: if True, colorbar will be made same size (for now, just height)</span>
<span class="sd">            as Axes. assumed that all Axes are same height and in one row (if multiple).</span>

<span class="sd">        axes_index: if `match_axes_size=True`, use `fig.axes[axes_index]` to match</span>

<span class="sd">        location: {&#39;left&#39;, &#39;right&#39;, &#39;bottom&#39;, &#39;top&#39;}. where new colorbar axes is placed</span>
<span class="sd">            relative to axes it&#39;s created from. if `match_axes_size=True`, passed as 1st</span>
<span class="sd">            arg to `AxesDivider.append_axes`, otherwise passed as `location` kwarg to</span>
<span class="sd">            `fig.colorbar`.</span>

<span class="sd">        size: passed to `AxesDivider.append_axes` (default: &#39;7%&#39;), if</span>
<span class="sd">            `match_axes_size=True`. unused otherwise. &#39;&lt;x&gt;%&#39; means the size of the</span>
<span class="sd">            created colorbar axes will be x% of matched `Axes` size (width, if appending</span>
<span class="sd">            on right).</span>

<span class="sd">            see matplotlib docs and examples listed there:</span>
<span class="sd">            https://matplotlib.org/stable/api/_as_gen/mpl_toolkits.axes_grid1.axes_divider.AxesDivider.html</span>
<span class="sd">            https://matplotlib.org/stable/gallery/axes_grid1/demo_colorbar_with_axes_divider.html</span>

<span class="sd">        pad: passed to `AxesDivider.append_axes` (default: &#39;2%&#39;), if</span>
<span class="sd">            `match_axes_size=True`. passed to `fig.colorbar` otherwise. spacing between</span>
<span class="sd">            created colorbar (vs matched) `Axes`.</span>

<span class="sd">        cax: passed to `fig.colorbar`. use for more control of size/shape of colorbar,</span>
<span class="sd">            e.g. to make colorbar same height as `Axes`, as in</span>
<span class="sd">            https://stackoverflow.com/a/18195921</span>

<span class="sd">        label: label for colorbar</span>

<span class="sd">        fontsize: passed to `Axes.set_ylabel`</span>

<span class="sd">        **kwargs: passed to `Figure.colorbar`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO check whether kwargs `label=label` to fig.colorbar can replace</span>
    <span class="c1"># cbar.ax.set_ylabel. i think so, but poorly documented.</span>
    <span class="c1"># (i.e. does it handle None the same way [/ close enough])</span>
    <span class="c1"># (would also need to check fontsize works as fig.colorbar kwarg now tho, and not</span>
    <span class="c1"># sure it does...)</span>

    <span class="c1"># TODO does this decrease size of current axes (YES!)? if so, another solution that</span>
    <span class="c1"># makes new axes (to accomplish similar thing)</span>
    <span class="c1"># https://matplotlib.org/stable/gallery/axes_grid1/demo_colorbar_with_inset_locator.html</span>
    <span class="c1"># https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.inset_axes.html</span>
    <span class="c1"># https://matplotlib.org/stable/users/explain/axes/colorbar_placement.html</span>
    <span class="c1"># last resort, the manual method: https://stackoverflow.com/questions/18195758</span>
    <span class="c1">#</span>
    <span class="c1"># bit tricky w/ constrained layout tho... all approaches might make main axes differ</span>
    <span class="c1"># in size between versions of plots with and without colorbars... might just need to</span>
    <span class="c1"># add colorbars for all, and manually remove after. maybe one or both of these</span>
    <span class="c1"># solutions [described in this comment or implemented below] can work as long as i</span>
    <span class="c1"># have excess space in axis colorbars will be added along?</span>
    <span class="c1">#</span>
    <span class="c1"># TODO delete? currently unused... some code might benefit from it tho</span>
    <span class="k">if</span> <span class="n">match_axes_size</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">cax</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="s1">&#39;shrink&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;shrink&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span>

        <span class="c1"># TODO need to handle / err in case Axes are not all taking up same vertical</span>
        <span class="c1"># extent? what if one is larger? what if there&#39;s more than one row?</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_index</span><span class="p">]</span>

        <span class="c1"># TODO update doc w/ default change (or just use normal kwarg... why not?)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;5%&#39;</span> <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">size</span>

        <span class="c1"># TODO TODO find args for placing on bottom too</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span>
            <span class="c1"># TODO expose width/height (+ update doc for &#39;size&#39;, if deleting</span>
            <span class="c1"># axes_divider method)</span>
            <span class="c1"># width: % of parent_bbox width</span>
            <span class="n">width</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>

             <span class="c1"># height % of parent axes</span>
            <span class="n">height</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span>

            <span class="c1"># TODO what is this even doing? why is it on the right of the image then?</span>
            <span class="c1"># (it [or something] is required, as commenting it out seems to remove the</span>
            <span class="c1"># colorbar)</span>
            <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span>
            <span class="c1"># also didn&#39;t work (couldn&#39;t see cbar). why?</span>
            <span class="c1">#loc=&quot;lower right&quot;,</span>
            <span class="c1"># puts flush w/ top of axes (also on RIGHT)</span>
            <span class="c1">#loc=&quot;upper left&quot;,</span>

            <span class="c1"># (0, 0, 1, 1) used if None</span>
            <span class="c1"># this anchor will place cax to right of ax (spaced by 0.05)</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>

            <span class="c1"># why use borderpad vs whatever epsilon is added to bbox_to_anchor[0]?</span>
            <span class="c1">#</span>
            <span class="c1"># was not flush w/ bottom unless this was set. bbox_to_anchor[0] set l/r</span>
            <span class="c1"># distances, not up/down.</span>
            <span class="n">borderpad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># TODO fix so cbar label / ticks not cut off (was w/ one row at least, when</span>
        <span class="c1"># called from plot_roi_util.py, where i actually didn&#39;t want to end up using it)</span>

    <span class="k">if</span> <span class="n">cax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>

        <span class="c1"># TODO TODO this causing problems in natmix_data/analysis.py usage? (when cax</span>
        <span class="c1"># defined from inset_axes) (moving into `if cax is None` conditional to see)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match_axes_size</span><span class="p">:</span>
            <span class="c1"># TODO TODO may not want in case cax is passed in (e.g. from ImageGrid</span>
            <span class="c1"># output)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

            <span class="k">if</span> <span class="n">pad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># in match_axes_size case, we already used pad above in this case, and</span>
                <span class="c1"># shouldn&#39;t try using it again in call below. pad=None does not work in</span>
                <span class="c1"># fig.colorbar</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pad</span>

    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">norm</span> <span class="ow">is</span> <span class="n">cbar</span><span class="o">.</span><span class="n">norm</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cbar</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="n">cbar</span><span class="o">.</span><span class="n">vmin</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cbar</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cbar</span><span class="o">.</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">cbar_min</span> <span class="o">=</span> <span class="n">cbar</span><span class="o">.</span><span class="n">vmin</span>
    <span class="n">cbar_max</span> <span class="o">=</span> <span class="n">cbar</span><span class="o">.</span><span class="n">vmax</span>

    <span class="c1"># TODO comment explaining why we are doing this. seems there is often not a tick</span>
    <span class="c1"># shown on lower end by default, but a bit confused about that b/c i was getting:</span>
    <span class="c1"># ipdb&gt; cbar.get_ticks()</span>
    <span class="c1"># array([-0.4, -0.2,  0. ,  0.2,  0.4,  0.6,  0.8,  1. ])</span>
    <span class="c1"># ...and if the -0.25 set manually below works, then why doesn&#39;t the -0.2 display?</span>
    <span class="c1">#</span>
    <span class="c1"># TODO TODO should i do something else to clarify scales are diff on two sides?</span>
    <span class="c1"># break in middle (could add in illustrator / inkscape tho)?</span>
    <span class="c1"># maybe https://stackoverflow.com/questions/53642861 ?</span>
    <span class="c1"># see also:</span>
    <span class="c1"># https://matplotlib.org/stable/gallery/subplots_axes_and_figures/broken_axis.html</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbar</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">TwoSlopeNorm</span><span class="p">):</span>
        <span class="c1"># this seems to change the cbar ticks, so we need to re-set them after</span>
        <span class="c1">#</span>
        <span class="c1"># i think it would just make size of each side of TwoSlopeNorm cbar seem</span>
        <span class="c1"># proportionate, w/o changing colors in image plotted.</span>
        <span class="c1"># https://github.com/matplotlib/matplotlib/issues/22197</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

        <span class="c1"># TODO delete</span>
        <span class="k">if</span> <span class="s1">&#39;ticks&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># NOTE: some of the plots mentioned below probably currently have their cbar</span>
            <span class="c1"># ticks hardcoded (via cbar_kws=dict(ticks=&lt;x&gt;), e.g. [-0.3, 2.5] set for</span>
            <span class="c1"># some in al_analysis.response_matrix_plots), in which case this branch</span>
            <span class="c1"># should not be hit (if below, outside conditional on norm type, should be)</span>
            <span class="c1">#</span>
            <span class="c1"># some plots i care about that this probably applies to:</span>
            <span class="c1"># - ijroi/certain[_mean|_stddev].pdf</span>
            <span class="c1">#   (stddev using same norm, but starts from midpoint=0)</span>
            <span class="c1">#   - and ijroi/by_panel/&lt;panel&gt;/*certain[_mean|_stddev].pdf</span>
            <span class="c1">#</span>
            <span class="c1"># - ijroi/by_panel/glomeruli_diagnostics/</span>
            <span class="c1">#   - each_fly/</span>
            <span class="c1">#     - *_certain.pdf</span>
            <span class="c1">#     - diag-highlight_certain.pdf</span>
            <span class="c1">#</span>
            <span class="c1"># - 2023-05-10_1_diagnostics1/ijroi/with_rois/*</span>
            <span class="c1">#</span>
            <span class="c1"># other plots with this norm that i&#39;m not using/generating as actively:</span>
            <span class="c1"># - 2023-05-10_1_diagnostics1/ijroi/timeseries/*</span>
            <span class="c1"># - 2023-05-10_1_diagnostics1/ijroi/*_rois_on_max_triamean_dff.pdf</span>
            <span class="c1">#</span>
            <span class="c1"># 2023-05-10/1 is the fly i was using for diagnostic examples, so often only</span>
            <span class="c1"># generated some &lt;fly_dir&gt;/ijroi/* plots for that one</span>
            <span class="c1">#</span>
            <span class="c1"># main thing we are missing, is no ticks on lower end of scale</span>
            <span class="c1"># (after set_yscale(&#39;linear&#39;) call above)</span>
            <span class="c1"># TODO at least also print existing ticks if i still wanna find a better</span>
            <span class="c1"># solution for this?</span>
            <span class="c1"># TODO delete? OK w/ ticks not set, as-is?</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;add_colorbar: not setting cbar ticks for twoslopenorm&#39;</span><span class="p">)</span>
            <span class="c1">#</span>

            <span class="c1"># TODO cbar doesn&#39;t have a vcenter does it? (to use instead of 0)</span>

            <span class="c1"># wouldn&#39;t work w/ cmap i set up for correlation-distance viz.matshow plots</span>
            <span class="c1"># (from al_analysis.plot_corrs)</span>
            <span class="c1"># TODO keep? (no, replace w/ only adding 0 tick if this is true)</span>
            <span class="c1">#assert cbar.vmin &lt; 0</span>

            <span class="c1"># TODO TODO only show stuff at nice even numbers</span>
            <span class="c1"># (or at least force formatter to not show 5 sigfigs?)</span>
            <span class="c1"># TODO TODO find |smallest| nearby multiple of 0.1, 0.25, 1.0, etc that is</span>
            <span class="c1"># under vmin/vmax? (how does mpl do it by default? can i use some of their</span>
            <span class="c1"># code?)</span>
            <span class="c1">#cbar.set_ticks([cbar.vmin, 0., cbar.vmax / 2, cbar.vmax])</span>

            <span class="c1"># TODO this work OK?</span>
            <span class="c1">#cbar.set_ticks([cbar.vmin, 0., cbar.vmax])</span>

            <span class="c1"># TODO TODO just prepend cbar.vmin to ticks?</span>

            <span class="c1"># TODO delete</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            if cbar.vmin &lt; -0.2:</span>
<span class="sd">                print(f&#39;{cbar.vmin=}&#39;)</span>
<span class="sd">                old_ticks = cbar.get_ticks()</span>
<span class="sd">                print(f&#39;{cbar.get_ticks()=}&#39;)</span>
<span class="sd">                import ipdb; ipdb.set_trace()</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="c1">#</span>
        <span class="c1">#</span>

        <span class="c1"># TODO TODO draw axes break or something (hline at least?) to indicate diff</span>
        <span class="c1"># scales on two sides of cbar?</span>

    <span class="k">if</span> <span class="s1">&#39;ticks&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># TODO TODO maybe also default to setting ticks to include these limits by</span>
        <span class="c1"># default?</span>

        <span class="c1"># TODO TODO can i change how ticks are formatted to have a diff number of</span>
        <span class="c1"># sigfigs per tick (only as many as needed for each)?</span>

        <span class="c1"># TODO delete. redundant w/ warnings in add_norm_options.</span>
        <span class="c1"># (could be used to set default ticks tho...?)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        # NOTE: this is a MaskedArray (at least, as I&#39;m looking at it now), but not sure</span>
<span class="sd">        # if it will ever actually be masked (maybe some cmap&#39;s use that for things like</span>
<span class="sd">        # set_bad/etc?)</span>
<span class="sd">        # TODO some way to ensure i&#39;m getting min/max of full data, not masked portion?</span>
<span class="sd">        #</span>
<span class="sd">        # get_array() seemed to be only way to access data from `im`. limits matched w/</span>
<span class="sd">        # what I expected in my first test.</span>
<span class="sd">        data = im.get_array()</span>
<span class="sd">        dmin = data.min()</span>
<span class="sd">        dmax = data.max()</span>
<span class="sd">        # these are both scalars after single min|max operation (unlike pandas where i&#39;d</span>
<span class="sd">        # need 2 generally, for 2d input)</span>
<span class="sd">        assert dmin.shape == tuple() and dmax.shape == tuple()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>

        <span class="n">ticks</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ticks&#39;</span><span class="p">]</span>
        <span class="c1"># TODO delete. ticks can be off cbar and that&#39;s fine. (still in shared kwargs</span>
        <span class="c1"># for some plots that set vmin to -1e-6, and seems to not cause bad output)</span>
        <span class="c1">#assert cbar_min &lt;= min(ticks), f&#39;{cbar_min} &gt; {min(ticks)=}&#39;</span>
        <span class="c1">#assert cbar_max &gt;= max(ticks), f&#39;{cbar_max} &gt; {max(ticks)=}&#39;</span>

        <span class="c1"># NOTE: important that this happens after possible set_yscale(&#39;linear&#39;) call</span>
        <span class="c1"># above, as that seems to reset the cbar ticks</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO test fontsize=None doesn&#39;t change default behavior</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cbar</span></div>


<span class="k">def</span> <span class="nf">_check_contour_array</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
    <span class="c1"># just takes normal array input (not the QuadContourSet directly returned by</span>
    <span class="c1"># matplotlib&#39;s contour fns)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="c1"># x,y</span>
    <span class="k">assert</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>


<div class="viewcode-block" id="contour_bbox"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.contour_bbox">[docs]</a><span class="k">def</span> <span class="nf">contour_bbox</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
    <span class="n">_check_contour_array</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># TODO maybe return as NamedTuple or something instead?</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">)</span></div>


<div class="viewcode-block" id="contour_center_of_mass"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.contour_center_of_mass">[docs]</a><span class="k">def</span> <span class="nf">contour_center_of_mass</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
    <span class="n">_check_contour_array</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>

    <span class="c1"># Taken from ImportanceOfBeingErnests&#39;s answer here:</span>
    <span class="c1"># https://stackoverflow.com/questions/48168880</span>
    <span class="c1"># calculate center of mass of a closed polygon</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">])</span></div>


<span class="c1"># TODO change default _pad=False? plot_rois and al_analysis both effectively change this</span>
<span class="c1"># default to False, and i&#39;m not sure i&#39;m using this code from anywhere else now...</span>
<span class="c1"># TODO delete label_to_bbox_dy? seems ok w/ just verticalalignment=&#39;bottom&#39; w/ dy=0</span>
<div class="viewcode-block" id="plot_closed_contours"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_closed_contours">[docs]</a><span class="k">def</span> <span class="nf">plot_closed_contours</span><span class="p">(</span><span class="n">footprint</span><span class="p">,</span> <span class="n">if_multiple</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;err&#39;</span><span class="p">,</span> <span class="n">_pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_over_contour</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">label_to_bbox_dy</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">text_kws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label_outline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="n">label_outline_linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label_outline_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
    <span class="c1">#label_outline_linewidth=0.9, label_outline_color=&#39;white&#39;,</span>

    <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># TODO doc / delete</span>
    <span class="c1"># TODO doc footprint type, to start</span>
    <span class="c1"># TODO specify if label_to_bbox_dy is in data/axes coords (former, i think?)</span>
    <span class="sd">&quot;&quot;&quot;Plots line around the contiguous positive region(s) in footprint.</span>

<span class="sd">    Args:</span>
<span class="sd">        ax: Axes to plot onto. will use current Axes otherwise.</span>

<span class="sd">        if_multiple: &#39;take_largest&#39;|&#39;join&#39;|&#39;err&#39;|&#39;ignore&#39;. what to do if there are</span>
<span class="sd">            multiple closed contours within footprint. contour will be plotted</span>
<span class="sd">            regardless, but error will happen before a contour is returned for use in</span>
<span class="sd">            other analysis.</span>

<span class="sd">        label: name of ROI. drawn in center of ROI contour by default.</span>

<span class="sd">        label_over_contour: if True, will draw `label` above ROI contour (rather than on</span>
<span class="sd">            center of mass). see also `label_to_bbox_dy`.</span>

<span class="sd">        label_to_bbox_dy: how many pixels above ROI bounding box to draw ROI label.</span>
<span class="sd">            ignored if `label_over_contour=False`.</span>

<span class="sd">        label_outline: if True, adds a `PathEffects` to `text_kws` to add an outline</span>
<span class="sd">            around drawn label.</span>

<span class="sd">        label_outline_color: color for outline from `label_outline=True`</span>

<span class="sd">        label_outline_linewidth: linewidth for outline from `label_outline=True`</span>

<span class="sd">        **kwargs: passed through to matplotlib `ax.contour` call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="c1"># So we don&#39;t need to define default in multiple places.</span>
    <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">color</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>

    <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="c1"># TODO delete</span>
        <span class="c1"># TODO TODO TODO is this not triggering?</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if label == &#39;DM3&#39;:</span>
<span class="sd">            plt.close(&#39;all&#39;)</span>
<span class="sd">            plt.figure()</span>
<span class="sd">            plt.imshow(footprint)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>

        <span class="c1"># does not work with my data (interior of each ROI gets filled with jagged</span>
        <span class="c1"># things), and image is in top left corner (still at original size, w/ ax and</span>
        <span class="c1"># contours scaled by factor here)</span>
        <span class="c1">#</span>
        <span class="c1"># TODO TODO this even work w/ binary data i&#39;m using? alternative?</span>
        <span class="c1">#</span>
        <span class="c1"># https://stackoverflow.com/questions/12274529</span>
        <span class="c1"># &quot;Resample your data grid by a factor of 3 using cubic spline interpolation.&quot;</span>
        <span class="c1"># TODO TODO probably need to rescale coordinates / other things by same</span>
        <span class="c1"># factor (e.g. for text placement)</span>
        <span class="c1">#footprint = scipy.ndimage.zoom(footprint, 3)</span>

        <span class="c1"># TODO delete</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if label == &#39;DM3&#39;:</span>
<span class="sd">            plt.figure()</span>
<span class="sd">            plt.imshow(footprint)</span>
<span class="sd">            plt.show()</span>
<span class="sd">            # TODO TODO TODO does zoom keep size same?</span>
<span class="sd">            # need to fix if not...</span>
<span class="sd">            import ipdb; ipdb.set_trace()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>

    <span class="c1"># TODO TODO fix what seems to be a (1, 1) pixel offset of contour wrt footprint</span>
    <span class="c1"># passed in (when plotted on same axes). (still?)</span>
    <span class="c1"># TODO TODO does extent= kwarg to contour call just change the plotted range, or</span>
    <span class="c1"># would it prevent my padding code from fixing footprint-touching-border cases, if</span>
    <span class="c1"># i were to find values for extent= that would invert plotting offset?</span>
    <span class="k">if</span> <span class="n">_pad</span><span class="p">:</span>
        <span class="c1"># I needed to pad so that footprints touching the edge of the image would still</span>
        <span class="c1"># get contours correctly (I believe). Not sure how to fix the 1 pixel offset in</span>
        <span class="c1"># plotting without changing contour that is returned.</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">footprint</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">padded_footprint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">))</span>
        <span class="n">padded_footprint</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">)]</span> <span class="o">=</span> <span class="n">footprint</span>

        <span class="n">mpl_contour</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">padded_footprint</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="n">linestyles</span><span class="p">,</span>

            <span class="c1"># TODO also try line font props similar to solo stuff</span>

            <span class="c1">#extent=(0, dims[0] - 1, 0, dims[1] - 1),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1">#mpl_contour_nopad = ax.contour(footprint &gt; 0, [0.5], colors=colors,</span>
        <span class="c1">#    linewidths=linewidths, linestyles=linestyles, **kwargs</span>
        <span class="c1">#)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Checking for what I believe was the reason we needed padding, though it might</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">footprint</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># TODO TODO better error message (and print label if available)</span>
        <span class="c1"># (this will be triggered by stuff touching the edge, even at a single point)</span>
        <span class="c1"># (maybe i should just always be padding tho? i.e. above branch?)</span>
        <span class="c1"># TODO TODO and catch in plot_rois and print plane / other info if there</span>
        <span class="c1"># (so people can actually fix the ROI that has an issue)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positive</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positive</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positive</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positive</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span>
        <span class="p">])</span>
        <span class="n">mpl_contour</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="n">linestyles</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="c1"># TODO really want conditional on linestyles?</span>
    <span class="c1"># TODO just flag / path_effects kwarg to disable for some calls?</span>
    <span class="c1"># (the &#39;dotted&#39; one was the whole AL plane outline)</span>
    <span class="k">if</span> <span class="n">linestyles</span> <span class="o">!=</span> <span class="s1">&#39;dotted&#39;</span><span class="p">:</span>
        <span class="c1"># TODO delete</span>
        <span class="c1"># TODO define default color dynamically based on cmap (like elsewhere)</span>
        <span class="c1">#&#39;&#39;&#39;</span>
        <span class="c1"># TODO TODO was ~one call not using black + a diff lw? maybe thru defaults?</span>
        <span class="k">if</span> <span class="n">_debug</span> <span class="ow">and</span> <span class="n">label_outline_color</span> <span class="o">!=</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label_outline_linewidth</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">label_outline_color</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#import ipdb; ipdb.set_trace()</span>
        <span class="c1">#&#39;&#39;&#39;</span>

        <span class="c1"># TODO possible to make it go all the way around the dash (not just the 2 long</span>
        <span class="c1"># edges of the line)</span>
        <span class="n">path_effects</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="n">label_outline_linewidth</span><span class="p">,</span>
                <span class="n">foreground</span><span class="o">=</span><span class="n">label_outline_color</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># TODO delete</span>
        <span class="c1">#print(f&#39;{type(mpl_contour)=}&#39;)</span>

        <span class="c1"># TODO TODO why do docs make it seem like .set should be availaible directly on what</span>
        <span class="c1"># ax.contour returns? version thing?</span>
        <span class="c1">#mpl_contour.set(path_effects=path_effects)</span>
        <span class="c1"># https://matplotlib.org/stable/gallery/misc/tickedstroke_demo.html</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mpl_contour</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">path_effects</span><span class="o">=</span><span class="n">path_effects</span><span class="p">)</span>

    <span class="c1"># TODO delete</span>
    <span class="c1"># (assuming i can set dash params via linestyles=[offset, (dash on, dash off)]`</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # https://stackoverflow.com/questions/12434426</span>
<span class="sd">    for c in mpl_contour.collections:</span>
<span class="sd">        c.set_dashes([(0, (2.0, 2.0))])</span>
<span class="sd">    import ipdb; ipdb.set_trace()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">text_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">text_kws</span><span class="p">)</span>

        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpl_contour</span><span class="o">.</span><span class="n">allsegs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># TODO warn? might need to use a particular segment / combination in other cases</span>
        <span class="c1">#assert len(mpl_contour.allsegs[-1]) == 1</span>
        <span class="c1"># TODO what does it mean if this is &gt;1? haven&#39;t checked this in a while, but in</span>
        <span class="c1"># first check in a while, it was 1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpl_contour</span><span class="o">.</span><span class="n">allsegs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span>

        <span class="c1"># (n, 2) array w/ x,y data for contour</span>
        <span class="n">contour_array</span> <span class="o">=</span> <span class="n">mpl_contour</span><span class="o">.</span><span class="n">allsegs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">default_text_kws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>

            <span class="s1">&#39;horizontalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>

            <span class="s1">&#39;fontweight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="c1"># Default should be 10.</span>
            <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="c1"># TODO move plot_rois PathEffects in here (to simplify text_kws passthru</span>
            <span class="c1"># from plot_rois, maybe as a new roi_text_kws arg to plot_rois)?</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">label_over_contour</span><span class="p">:</span>
            <span class="c1"># Also partially taken from https://stackoverflow.com/questions/48168880</span>
            <span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span> <span class="o">=</span> <span class="n">contour_center_of_mass</span><span class="p">(</span><span class="n">contour_array</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO if default va=&#39;top&#39;, then how come center of mass approach worked ok</span>
            <span class="c1"># so far in !label_over_contour case (without being offset along Y axis)?</span>
            <span class="c1">#</span>
            <span class="c1"># hopefully should make parameter for space between label and top of contour</span>
            <span class="c1"># bbox simpler (default va=&#39;top&#39;) (seems to)</span>
            <span class="n">default_text_kws</span><span class="p">[</span><span class="s1">&#39;verticalalignment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>

            <span class="c1"># TODO some way to get this bbox easily from matplotlib stuff itself?</span>
            <span class="c1"># couldn&#39;t find it easily myself...</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">contour_bbox</span><span class="p">(</span><span class="n">contour_array</span><span class="p">)</span>

            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">text_x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># TODO subtract an amount in relation to fontsize? fixed kwarg alongside one</span>
            <span class="c1"># controlling whether to draw roi above contour?</span>
            <span class="n">text_y</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">label_to_bbox_dy</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_text_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_kws</span><span class="p">:</span>
                <span class="n">text_kws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="n">label_outline</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s1">&#39;path_effects&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_kws</span>
            <span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;path_effects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="c1"># (for huge ~20&quot; x ~3&quot; plot_roi figs initially made)</span>
                <span class="c1"># TODO update values for reasonable (e.g. fittable in page size) figs</span>
                <span class="c1"># -&gt; delete most of comment below</span>
                <span class="c1">#</span>
                <span class="c1"># 0.2 was too small linewidth, at least with other settings as</span>
                <span class="c1"># they are. 1.0 was possibly too big. might need to change other</span>
                <span class="c1"># settings if I can&#39;t find a good middle ground otherwise.</span>
                <span class="c1"># 1.0 probably still looks better than 0.5</span>
                <span class="c1">#</span>
                <span class="c1"># https://osxastrotricks.wordpress.com/2014/12/02/add-border-around-text-with-matplotlib/</span>
                <span class="c1"># see also:</span>
                <span class="c1"># https://matplotlib.org/stable/users/explain/artists/patheffects_guide.html</span>
                <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="n">label_outline_linewidth</span><span class="p">,</span>
                    <span class="n">foreground</span><span class="o">=</span><span class="n">label_outline_color</span>
                <span class="p">)</span>
            <span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">text_kws</span><span class="p">)</span>

        <span class="c1"># TODO delete</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        abox = ax.bbox</span>
<span class="sd">        print(f&#39;{[abox.xmin, abox.xmax, abox.ymin, abox.ymax]=}&#39;)</span>

<span class="sd">        pc = mpl_contour.collections[0]</span>

<span class="sd">        cbox = pc.get_clip_box()</span>
<span class="sd">        #[9.275000000000425, 208.35238095238137, 285.3263095238095, 484.4036904761905]</span>
<span class="sd">        print(f&#39;{[cbox.xmin, cbox.xmax, cbox.ymin, cbox.ymax]=}&#39;)</span>

<span class="sd">        #(9.275000000000425, 285.3263095238095, 199.07738095238093, 199.07738095238096)</span>
<span class="sd">        # TODO how does this differ from above? why not just re-ordered?</span>
<span class="sd">        print(f&#39;{cbox.bounds=}&#39;)</span>

<span class="sd">        tbox = pc.get_tightbbox()</span>
<span class="sd">        #Bbox([[9.275000000000425, 285.3263095238095], [208.35238095238137, 484.4036904761905]])</span>
<span class="sd">        print(f&#39;{tbox=}&#39;)</span>

<span class="sd">        plt.show()</span>
<span class="sd">        import ipdb; ipdb.set_trace()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#</span>

    <span class="c1"># TODO which of these is actually &gt; 1 in multiple comps case?</span>
    <span class="c1"># handle that one approp w/ err_on_multiple_comps!</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpl_contour</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="n">mpl_contour</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_paths</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># NOTE: this will be after drawing contour, but before drawing any label...</span>
        <span class="k">if</span> <span class="n">if_multiple</span> <span class="o">==</span> <span class="s1">&#39;err&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;multiple disconnected paths in one footprint&#39;</span><span class="p">)</span>

        <span class="c1"># TODO TODO still try plotting each in a separate color / printing vertices in</span>
        <span class="c1"># each, to try to get a sense of where these are coming from / how to fix.</span>
        <span class="c1"># main issue currently is just that name seems to get drawn off center for these</span>
        <span class="c1"># ROIs, despite overall ROI shape seeming to match up w/ what I have in ImageJ</span>
        <span class="c1"># in all examples checked so far.</span>
        <span class="k">elif</span> <span class="n">if_multiple</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">if_multiple</span> <span class="o">==</span> <span class="s1">&#39;take_largest&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

            <span class="n">largest_sum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">largest_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_sum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

                <span class="c1"># TODO maybe replace mpl stuff w/ cv2 drawContours? (or related...) (fn</span>
                <span class="c1"># now in here as roi.contour2mask)</span>
                <span class="c1"># TODO shouldn&#39;t these (if i want to keep this branch anyway...)</span>
                <span class="c1"># be using padded_footprint instead of footprint?</span>
                <span class="c1"># TODO TODO factor to something like a &quot;mplpath2mask&quot; fn</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">footprint</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">footprint</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="c1"># TODO TODO not sure why this seems to be transposed, but it</span>
                    <span class="c1"># does (make sure i&#39;m not doing something wrong?)</span>
                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">contains_point</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
                        <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Places where the mask is False are included in the sum.</span>
                <span class="n">path_sum</span> <span class="o">=</span> <span class="n">MaskedArray</span><span class="p">(</span><span class="n">footprint</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="c1"># TODO maybe check that sum of all path_sums == footprint.sum()?</span>
                <span class="c1"># seemed there were some paths w/ 0 sum... cnmf err?</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                print(&#39;mask_sum:&#39;, (~ mask).sum())</span>
<span class="sd">                print(&#39;path_sum:&#39;, path_sum)</span>
<span class="sd">                print(&#39;regularly masked sum:&#39;, footprint[(~ mask)].sum())</span>
<span class="sd">                plt.figure()</span>
<span class="sd">                plt.imshow(mask)</span>
<span class="sd">                plt.figure()</span>
<span class="sd">                plt.imshow(footprint)</span>
<span class="sd">                plt.show()</span>
<span class="sd">                import ipdb; ipdb.set_trace()</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="k">if</span> <span class="n">path_sum</span> <span class="o">&gt;</span> <span class="n">largest_sum</span><span class="p">:</span>
                    <span class="n">largest_sum</span> <span class="o">=</span> <span class="n">path_sum</span>
                    <span class="n">largest_idx</span> <span class="o">=</span> <span class="n">p</span>

                <span class="n">total_sum</span> <span class="o">+=</span> <span class="n">path_sum</span>

            <span class="n">footprint_sum</span> <span class="o">=</span> <span class="n">footprint</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># TODO float formatting / some explanation as to what this is</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;footprint_sum:&#39;</span><span class="p">,</span> <span class="n">footprint_sum</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;total_sum:&#39;</span><span class="p">,</span> <span class="n">total_sum</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;largest_sum:&#39;</span><span class="p">,</span> <span class="n">largest_sum</span><span class="p">)</span>
            <span class="c1"># TODO is this only failing when stuff is overlapping?</span>
            <span class="c1"># just merge in that case? (wouldn&#39;t even need to dilate or</span>
            <span class="c1"># anything...) (though i guess then the inequality would go the</span>
            <span class="c1"># other way... is it border pixels? just ~dilate by one?)</span>
            <span class="c1"># TODO fix + uncomment</span>
            <span class="c1">#assert np.isclose(total_sum, footprint_sum)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">largest_idx</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">if_multiple</span> <span class="o">==</span> <span class="s1">&#39;join&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># TODO TODO need to test that anything that used return value here is still correct,</span>
    <span class="c1"># now that i deleted old padding code, after it seemed to be just causing an offset</span>
    <span class="c1"># in plot_rois</span>

    <span class="n">contour</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">vertices</span>
    <span class="c1"># Correct index change caused by padding.</span>
    <span class="k">return</span> <span class="n">contour</span> <span class="o">-</span> <span class="mi">1</span></div>


<span class="c1"># TODO option to burn in D/V M/L A/P axis labels (or another fn to handle that?)?</span>
<span class="c1"># TODO add kwarg flag to include colorbar (always added now?) (delete comment?)</span>
<span class="c1"># TODO rename scale_per_plane to scale_per_image?</span>
<span class="c1"># TODO type hint image_list as list/ndarray (of ndarrays, in either case)?</span>
<span class="c1"># TODO type hint return</span>
<div class="viewcode-block" id="image_grid"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.image_grid">[docs]</a><span class="k">def</span> <span class="nf">image_grid</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">nrows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ncols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extra_figsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inches_per_pixel</span><span class="o">=</span><span class="mf">0.014</span><span class="p">,</span> <span class="n">imagegrid_rect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale_per_plane</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minmax_clip_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">DEFAULT_ANATOMICAL_CMAP</span><span class="p">,</span> <span class="n">cbar_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cbar_kws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># TODO also allow specifying either height_inches/width_inches instead of</span>
    <span class="c1"># inches_per_pixel (would only save specifying one component of figsize...)?</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        image_list: list/array of images, whose length is equal to the number of images</span>
<span class="sd">            (i.e. number of planes, for typical input of single-fly volumetric data,</span>
<span class="sd">            where input has been reduced across timepoints)</span>

<span class="sd">        ncols: how many columns for grid showing the background of each plane</span>
<span class="sd">            (one panel per plane)</span>

<span class="sd">        figsize: passed to `plt.subplots`. if passed, none of `width`, `height`,</span>
<span class="sd">            `extra_figsize` should be, and `inches_per_pixel` will be ignored.</span>
<span class="sd">            (width, height)</span>

<span class="sd">        width: figure width in inches. only pass either this or `height`. if you want to</span>
<span class="sd">            specify both, use `figsize` instead. this is to specify one and have the</span>
<span class="sd">            other calculated (from `nrows`, `ncols`, and `extra_figsize`).</span>
<span class="sd">            will ignore and recalulate `inches_per_pixel` to fit figure in this width.</span>

<span class="sd">        height: figure height in inches. see `width` documentation.</span>

<span class="sd">        extra_figsize: if calculating `figsize`, this can be used to add space for other</span>
<span class="sd">            elements besides the images (colorbars, titles, etc). (width, height)</span>

<span class="sd">        inches_per_pixel: used to calculate `figsize`, if `figsize` not passed</span>

<span class="sd">        imagegrid_rect: passed to `ImageGrid`, to determine size / position it will</span>
<span class="sd">            occupy in figure. defaults to something automatically determined.</span>
<span class="sd">            colorbar(s) and any labels/titles should (i think) extent past this.</span>

<span class="sd">            (left, bottom, width, height) tuple, where (0, 0) is bottom left, and</span>
<span class="sd">            everything should be in [0, 1]. width and height are fractions of figure</span>
<span class="sd">            sizes.</span>

<span class="sd">        scale_per_plane: if False, min/max of colorscale will be picked from min/max of</span>
<span class="sd">            all data (after excluding `minmax_clip_frac`, if it&#39;s greater than 0).</span>

<span class="sd">        minmax_clip_frac: clip this fraction of data from BOTH the lower/upper end, when</span>
<span class="sd">            deciding the limits of the colormap for the background images.</span>
<span class="sd">            `v[min|max]` must not be set if this is, and vice versa.</span>

<span class="sd">        cbar: set to `False` to disable colorbar(s)</span>

<span class="sd">        cbar_label: label for colorbar</span>

<span class="sd">        cbar_kws: passed to `add_colorbar`</span>

<span class="sd">        **kwargs: passed to `imshow`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">extra_figsize</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="c1"># TODO even want to support scale_per_plane=True? delete all related branches?</span>
    <span class="c1"># TODO want to check vmin/vmax not passed if scale_per_plane=True?</span>
    <span class="c1"># TODO make a decorator to convert assertion errors like these to ValueErrors?</span>
    <span class="c1"># (and maybe also have it modify the docstring to add something like &quot;raises</span>
    <span class="c1"># ValueError&quot;?)</span>
    <span class="c1"># TODO TODO and replace `0 &lt;=` w/ `0 &lt;`?</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">minmax_clip_frac</span> <span class="o">&lt;</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># TODO TODO also need to not conflict with any norms i might want to use</span>
        <span class="c1">#</span>
        <span class="c1"># (assuming if it&#39;s 0, it wasn&#39;t explicitly passed in. good enough for now.</span>
        <span class="c1"># this shouldn&#39;t be passed if vmin/vmax are, and vice versa)</span>
        <span class="c1"># TODO TODO replace w/ this being None (and replace `0 &lt;=` w/ `0 &lt;` above)?</span>
        <span class="k">assert</span> <span class="n">minmax_clip_frac</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">scale_per_plane</span>

    <span class="k">if</span> <span class="n">cbar_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cbar_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># TODO just disallow this, telling them to use cbar_label instead</span>
    <span class="k">elif</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">cbar_kws</span><span class="p">:</span>
        <span class="c1"># (since i change cbar_kws by popping below)</span>
        <span class="n">cbar_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cbar_kws</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">cbar_label</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">cbar_label</span> <span class="o">=</span> <span class="n">cbar_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>

    <span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">n_other_axis</span><span class="p">(</span><span class="n">n_first_axis</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_first_axis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">)))</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">elif</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">n_other_axis</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">n_other_axis</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extra_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">extra_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">extra_figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_width</span><span class="p">,</span> <span class="n">extra_height</span> <span class="o">=</span> <span class="n">extra_figsize</span>

        <span class="c1"># Assuming all images in image_list are the same shape</span>
        <span class="n">image_shape</span> <span class="o">=</span> <span class="n">image_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="c1"># TODO actually test w/ images where w != h. i might have them flipped.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># NOTE: ignoring any input inches_per_pixel</span>
            <span class="n">inches_per_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">extra_width</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># NOTE: ignoring any input inches_per_pixel</span>
            <span class="n">inches_per_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">extra_height</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">)</span>

        <span class="c1"># TODO try to account for (minor) small spaces between images?</span>
        <span class="c1"># &#39;compressed&#39; does minimize well enough (assuming just images in layout)</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">inches_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_width</span><span class="p">,</span>
            <span class="n">inches_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_height</span>
        <span class="p">)</span>
        <span class="c1"># TODO delete? /uncomment after resolving other things i&#39;m using _debug for</span>
        <span class="c1"># (+ removing `viz._debug = True` in my al_analysis.py)</span>
        <span class="c1">#if _debug:</span>
        <span class="c1">#    print(f&#39;{inches_per_pixel=}&#39;)</span>
        <span class="c1">#    print(f&#39;{(inches_per_pixel * (w * ncols))=}&#39;)</span>
        <span class="c1">#    print(f&#39;{(inches_per_pixel * (h * nrows))=}&#39;)</span>
        <span class="c1">#    print(f&#39;{(inches_per_pixel * (w * ncols) + extra_width)=}&#39;)</span>
        <span class="c1">#    print(f&#39;{(inches_per_pixel * (h * nrows) + extra_height)=}&#39;)</span>
        <span class="c1">#    print(f&#39;{figsize=}&#39;)</span>

        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">height</span><span class="p">)</span>

    <span class="c1"># NOTE: &#39;compressed&#39; layout ended up being key to getting decent (e.g. minimal)</span>
    <span class="c1"># spacing between the images if anything (suptitle, colorbar) was added to fig after</span>
    <span class="c1"># this call. from matplotlib docs:</span>
    <span class="c1"># &quot;&#39;compressed&#39;: uses the same algorithm as &#39;constrained&#39;, but removes extra space</span>
    <span class="c1"># between fixed-aspect-ratio Axes. Best for simple grids of axes.&quot;</span>
    <span class="c1">#fig, axs = plt.subplots(nrows=nrows, ncols=ncols, figsize=figsize, dpi=dpi,</span>
    <span class="c1">#    layout=&#39;compressed&#39;</span>
    <span class="c1">#)</span>

    <span class="c1"># TODO TODO fix: (handle some other way for 3.4.3 [or anything &lt;3.7.3]? or just</span>
    <span class="c1"># require &gt;=3.7.3 and fix the seaborn negative-input-to-errorbar issue which is why</span>
    <span class="c1"># i downgraded to 3.4.3? or is there a version between that works w/ both this and</span>
    <span class="c1"># the errorbar code?</span>
    <span class="c1"># (currently decided to revert to 3.7.3 because of this)</span>
    <span class="c1"># ...</span>
    <span class="c1">#   File &quot;/home/tom/src/hong2p/hong2p/viz.py&quot;, line 2256, in image_grid</span>
    <span class="c1">#     fig = plt.figure(figsize=figsize, dpi=dpi, layout=&#39;compressed&#39;)</span>
    <span class="c1">#   File &quot;/home/tom/src/al_analysis/venv/lib/python3.8/site-packages/matplotlib/pyplot.py&quot;, line 797, in figure</span>
    <span class="c1">#     manager = new_figure_manager(</span>
    <span class="c1">#   File &quot;/home/tom/src/al_analysis/venv/lib/python3.8/site-packages/matplotlib/pyplot.py&quot;, line 316, in new_figure_manager</span>
    <span class="c1">#     return _backend_mod.new_figure_manager(*args, **kwargs)</span>
    <span class="c1">#   File &quot;/home/tom/src/al_analysis/venv/lib/python3.8/site-packages/matplotlib/backend_bases.py&quot;, line 3544, in new_figure_manager</span>
    <span class="c1">#     fig = fig_cls(*args, **kwargs)</span>
    <span class="c1"># TypeError: __init__() got an unexpected keyword argument &#39;layout&#39;</span>
    <span class="c1">#</span>
    <span class="c1"># TODO still use &#39;compressed&#39;? maybe regular constrained?</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;compressed&#39;</span><span class="p">)</span>

    <span class="c1"># TODO TODO still have cbar=False disable these cbar (maybe still make and remove so</span>
    <span class="c1"># size changes the same??? so i can edit together plots w/ and w/o cbars more</span>
    <span class="c1"># easily)</span>
    <span class="c1">#</span>
    <span class="c1"># (gonna just set cbar_mode=None for now and leave my old cbar code to handle</span>
    <span class="c1"># it... sike)</span>
    <span class="c1">#cbar_mode=None</span>
    <span class="c1">#</span>
    <span class="c1"># TODO still need to call colorbar myself, it just makes colorbar axes, and by</span>
    <span class="c1"># default associates them w/ corresponding axes:</span>
    <span class="c1"># https://stackoverflow.com/questions/37917219</span>
    <span class="c1">#</span>
    <span class="c1"># makes one giant one (same height as all axes together)</span>
    <span class="c1">#cbar_mode=&#39;single&#39;</span>

    <span class="c1"># at least w/ other settings are they are now (making &lt;fly&gt;/ijroi/with_rois plots to</span>
    <span class="c1"># show ROIs and diag responses, where height=10.4 and nrows=1), size of image axes</span>
    <span class="c1"># are equal whether showing cbar or not (so no need to add -&gt; remove)</span>
    <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">cbar_mode</span> <span class="o">=</span> <span class="s1">&#39;each&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cbar_mode</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO experiment w/ cbar options here. may not need (as much of) my own cbar</span>
    <span class="c1"># handling (also have cbar_location, cbar_pad, cbar_size)</span>

    <span class="c1"># TODO TODO why do i seem to be getting:</span>
    <span class="c1"># Warning: There are no gridspecs with layoutgrids. Possibly did not call parent</span>
    <span class="c1"># GridSpec with the &quot;figure&quot; keyword</span>
    <span class="c1"># ...w/ new ImageGrid code (warning seems to come after this call, maybe in</span>
    <span class="c1"># plot_rois? or in savefig?)</span>

    <span class="c1"># TODO try using inches_per_pixel again, to calc rect (2nd arg here)</span>
    <span class="c1"># TODO or how else do i want to specify size here (or margin wrt figsize?)</span>
    <span class="c1"># treat all extra_figsize as the margin?</span>
    <span class="c1">#</span>
    <span class="c1"># TODO check + include in comment whether this area is ONLY for the images, or</span>
    <span class="c1"># whether also for cbars (must just be images, no?)</span>
    <span class="k">if</span> <span class="n">imagegrid_rect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># NOTE: can output these values and tweak from there</span>
        <span class="c1"># divider = grid.get_divider()</span>
        <span class="c1"># divider.get_position()</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="mi">111</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO ideally come up w/ a general way of calculating something roughly like</span>
        <span class="c1"># what i&#39;m passing in from al_analysis diag_example_plot_roi_kws</span>
        <span class="c1"># was never TOO bad with just rect=111 tho...</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">imagegrid_rect</span>

    <span class="c1"># TODO if i keep, use option to not make axes beyond what we actually have images</span>
    <span class="c1"># for (if actually in a grid, not relevant for single row/col stuff)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
        <span class="n">cbar_mode</span><span class="o">=</span><span class="n">cbar_mode</span>
    <span class="p">)</span>

    <span class="c1"># TODO this work same as old subplots axs.flat? test in cases w/ more than a single</span>
    <span class="c1"># row/col used.</span>
    <span class="c1"># TODO change other code to not expect array? just converting to not have to modify</span>
    <span class="c1"># the axs.flat stuff for now</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">axes_all</span><span class="p">)</span>

    <span class="c1"># TODO see: https://stackoverflow.com/questions/42850225 or related to find a</span>
    <span class="c1"># good solution for reliably eliminating all unwanted whitespace between subplots</span>
    <span class="c1"># (honestly i think it will ultimately come down to figsize, potentially more so</span>
    <span class="c1"># when using constrained layout, as i&#39;d now generally like to)</span>

    <span class="c1"># TODO TODO TODO either make it so minmax_clip_frac=0 doesn&#39;t set vmin/vmax, or</span>
    <span class="c1"># allow None kwarg there (or handle vmin/vmax w/ norms i&#39;d wanna use)</span>

    <span class="n">single_colorbar</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If we aren&#39;t scaling per plane, then we are scaling ACROSS ALL planes</span>
        <span class="c1"># (by default, just using the min/max across all)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_per_plane</span><span class="p">:</span>
            <span class="c1"># (across all axes by default, as if flattening array first)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="n">minmax_clip_frac</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">minmax_clip_frac</span><span class="p">)</span>
            <span class="c1"># TODO want to do any checking we are throwing away (only) a reasonable</span>
            <span class="c1"># amount of data? like not all of it at least?</span>

            <span class="c1"># TODO TODO also need to not conflict with any norms i might want to</span>
            <span class="c1"># use (here and anywhere else we compute vmin/vmax, which can&#39;t be passed</span>
            <span class="c1"># with anything other than str norm, which seems to preclude</span>
            <span class="c1"># centered/two-slope norms)</span>
            <span class="c1"># TODO delete</span>
            <span class="c1">#print(f&#39;from minmax_clip_frac: {vmin=} {vmax=}&#39;)</span>
            <span class="c1">#</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single_colorbar</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">image_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scale_per_plane</span><span class="p">:</span>
            <span class="c1"># TODO TODO also test this branch works w/ new add_norm_options stuff</span>
            <span class="c1"># (including if norm=CenteredNorm/similar)</span>
            <span class="c1"># TODO delete</span>
            <span class="c1">#print(f&#39;(curr plane) {vmin=} {vmax=}&#39;)</span>
            <span class="c1">#</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">minmax_clip_frac</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">minmax_clip_frac</span><span class="p">)</span>
            <span class="c1"># TODO TODO also don&#39;t fuck up non-str norms (test?)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scale_per_plane</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span>

    <span class="c1"># TODO add support for putting colorbars below images (try just one, either first /</span>
    <span class="c1"># last axes, and also try one per image [for use in plots where all odors at the</span>
    <span class="c1"># same depth have a fixed scale])</span>
    <span class="c1"># TODO and should it work in scale_per_plane=True case then, just drawing one under</span>
    <span class="c1"># each?</span>
    <span class="k">if</span> <span class="n">cbar</span> <span class="ow">and</span> <span class="n">single_colorbar</span><span class="p">:</span>
        <span class="c1"># TODO delete</span>
        <span class="c1"># from before i started letting ImageGrid create and position cbar axes</span>
        <span class="c1">#add_colorbar(fig, im, label=cbar_label, **cbar_kws)</span>
        <span class="c1">#add_colorbar(fig, im, label=cbar_label, match_axes_size=True, **cbar_kws)</span>

        <span class="n">single_cax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cax</span>

        <span class="c1"># TODO TODO try to keep, but only set if values actually go out of range?</span>
        <span class="c1"># TODO delete</span>
        <span class="c1">#print(&#39;viz.image_grid: delete extend=both (on add_colorbar call)?&#39;)</span>
        <span class="c1">#</span>
        <span class="n">add_colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">single_cax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">,</span>
            <span class="c1"># TODO may need cmap.set_[under|over]</span>

            <span class="c1"># TODO comment explaining purpose of this!</span>
            <span class="c1"># TODO move to al_analysis, and only in diverging cmap kwargs?</span>
            <span class="c1"># (or something more specific?) don&#39;t really care for anatomical version</span>
            <span class="c1">#</span>
            <span class="c1"># TODO delete. testing cmap/vmin/vmax/norm/clipping handling.</span>
            <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span>
            <span class="c1">#</span>

            <span class="o">**</span><span class="n">cbar_kws</span>
        <span class="p">)</span>

        <span class="c1"># TODO check all image axes data wrt limits of cbar (+clip status?) -&gt; warn</span>
        <span class="c1"># about clipping? may make more sense here than ~add_colorbar, which may not see</span>
        <span class="c1"># the rest of the data</span>

        <span class="n">n_matching_cax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">cax</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cax</span> <span class="ow">is</span> <span class="n">single_cax</span><span class="p">:</span>
                <span class="n">n_matching_cax</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># seems to be useful for telling if cbar has been drawn on.</span>
                <span class="c1"># https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.has_data.html</span>
                <span class="k">assert</span> <span class="n">cax</span><span class="o">.</span><span class="n">has_data</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">cax</span><span class="o">.</span><span class="n">has_data</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">cax</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">n_matching_cax</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># TODO if i keep using ImageGrid, could use it&#39;s kwargs to just not make these last</span>
    <span class="c1"># (unused) ones</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">):]:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span></div>


<div class="viewcode-block" id="micrometer_depth_title"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.micrometer_depth_title">[docs]</a><span class="k">def</span> <span class="nf">micrometer_depth_title</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span><span class="p">,</span> <span class="n">zstep_um</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">z_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
    <span class="n">as_ylabel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">as_overlay</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># TODO cleanup formatting of doc re: as_ylabel/as_overlay changes to which fn gets</span>
    <span class="c1"># args passed thru to it</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        as_ylabel: if True, use `ax.set_ylabel` instead of `ax.title`, to put this</span>
<span class="sd">            information on the left (may want to use if have a series of single column</span>
<span class="sd">            plots, rather than a series of rows). adds `rotation=0` and `labelpad=16`</span>
<span class="sd">            by default. mutually exclusive with `as_overlay`.</span>

<span class="sd">        as_overlay: draws on `ax` instead of labelling above / to the side. in top left</span>
<span class="sd">            corner by default. mutually exclusive with `as_ylabel`.</span>

<span class="sd">        fontsize: passed to `ax.set_title` (or `ax.set_ylabel`, if `as_ylabel=True`;</span>
<span class="sd">            `ax.text` if `as_overlay=True`)</span>

<span class="sd">        **kwargs: passed to `ax.set_title` (or `ax.set_ylabel`, if `as_ylabel=True`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curr_z</span> <span class="o">=</span> <span class="o">-</span><span class="n">zstep_um</span> <span class="o">*</span> <span class="n">z_index</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">as_ylabel</span> <span class="ow">or</span> <span class="n">as_overlay</span><span class="p">):</span>
        <span class="n">set_title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span>
        <span class="n">extra_default_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">as_ylabel</span><span class="p">:</span>
        <span class="n">set_title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span>
        <span class="c1"># w/o labelpad text overlaps w/ images. labelpad=20 worked w/ fontsize=8.</span>
        <span class="c1"># labelpad=16 works w/ fontsize=7 (and max title length from &quot;-70 um&quot;)</span>
        <span class="n">extra_default_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">as_overlay</span><span class="p">:</span>
        <span class="c1"># color=&#39;w&#39; works w/ black background (e.g. w/ cmap=&#39;gray&#39;), but would prefer</span>
        <span class="c1"># color=&#39;k&#39; (black) w/ white background (e.g. w/ cmap=&#39;vlag&#39;, or other diverging</span>
        <span class="c1"># where center is white). plot_rois will change default according to input image</span>
        <span class="c1"># + cmap.</span>
        <span class="n">extra_default_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># TODO TODO TODO make scalebar font consistent with this</span>
        <span class="c1"># (one way or the other. preferably by changing scalebar stuff to match this)</span>
        <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># these should be specified either by input kwargs or by extra_default_kws</span>
            <span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># TODO replace w/ `kwargs = {**extra_default_kws, **kwargs}`?</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extra_default_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># TODO check formatting of 0 looks good (or disable that here? currently some</span>
    <span class="c1"># code excludes this call on that plane, so not sure of formatting)</span>
    <span class="c1"># (it currently looks like &quot;-0uM&quot;)</span>
    <span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">curr_z</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> $</span><span class="se">\\</span><span class="s1">mu$m&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># TODO use is_cmap_diverging instead? is what i want here actually different?</span>
<span class="c1"># TODO also use in micrometer_depth_title</span>
<div class="viewcode-block" id="get_default_overlay_color"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.get_default_overlay_color">[docs]</a><span class="k">def</span> <span class="nf">get_default_overlay_color</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns &#39;w&#39; or &#39;k&#39; (white/black), depending on current image colors.</span>

<span class="sd">    Aims to provide the color that would be higher contrast with respect to the</span>
<span class="sd">    background.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: requires that imshow (/equiv) has been called already</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_images</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># TODO catch in add_scalebar -&gt; provide better error message including that we</span>
        <span class="c1"># can just pass in color explicitly</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;has imshow() [/ similar] been called on this Axes yet?&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># TODO just get directly from background?</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>

    <span class="c1"># TODO delete</span>
    <span class="c1"># for 192x192 frames, this seems to be about the section where depth title +</span>
    <span class="c1"># scalebar are currently drawn.</span>
    <span class="c1">#lowish_img_value = arr[:40, :].mean()</span>

    <span class="c1"># get warning &quot;&#39;partition&#39; will ignore the &#39;mask&#39; of the MaskedArray.&quot; if we don&#39;t</span>
    <span class="c1"># convert from MaskedArray w/ np.array(arr) first</span>
    <span class="n">lowish_img_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mi">15</span><span class="p">)</span>

    <span class="c1"># should be subclass of Normalize if not str</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">norm</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span>
    <span class="c1"># should map image value to [0.0, 1.0] (which should be input range of cmap)</span>
    <span class="n">cmap_input</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lowish_img_value</span><span class="p">)</span>
    <span class="n">lowish_value_color</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">cmap_input</span><span class="p">)</span>

    <span class="c1"># excluding alpha channel (which should be 1.0 anyway)</span>
    <span class="n">luminance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lowish_value_color</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">luminance</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="c1"># black</span>
        <span class="n">default_color_over_image</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default_color_over_image</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>

    <span class="k">return</span> <span class="n">default_color_over_image</span></div>


<div class="viewcode-block" id="add_scalebar"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.add_scalebar">[docs]</a><span class="k">def</span> <span class="nf">add_scalebar</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span><span class="p">,</span> <span class="n">pixelsize_um</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># TODO move default_kwargs to actual default kwarg values in fn def? why not?</span>
    <span class="c1">#</span>
    <span class="c1"># I did check (in 2023-05-10/1, where FOV width/height are 100.[6?] uM,</span>
    <span class="c1"># that w/ fixed_value=99 [instead of length_fraction], the bar is just</span>
    <span class="c1"># slightly shorter than width of image)</span>
    <span class="n">default_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="s1">&#39;um&#39;</span><span class="p">,</span>
        <span class="c1"># TODO restore? or just keep at hardcoded 10um (via fixed_value=10)?</span>
        <span class="c1">#length_fraction=0.25</span>
        <span class="n">fixed_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="c1"># OK for contexts of plot_rois? (got this value from 10uM ScaleBar&#39;s made in</span>
        <span class="c1"># al_analysis stuff not using plot_rois...)</span>
        <span class="n">width_fraction</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
        <span class="c1"># NOTE: tried font_properties=dict(family=&#39;DejaVu Sans&#39;), but didn&#39;t seem to</span>
        <span class="c1"># get same italic font as in titles (not sure if font changed at all?)</span>
        <span class="c1"># (can also set font size via size= in same font_properties dict)</span>
    <span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>

    <span class="c1"># color is for &quot;the scale bar, scale and label&quot;</span>
    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">get_default_overlay_color</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># TODO make font (see lowercase mu character) consistent with ax.text called</span>
    <span class="c1"># from micrometer_depth_titles</span>
    <span class="c1"># (one way or the other. preferably by changing this)</span>
    <span class="c1">#</span>
    <span class="c1"># for other ScaleBar options, see:</span>
    <span class="c1"># https://github.com/ppinard/matplotlib-scalebar</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">ScaleBar</span><span class="p">(</span><span class="n">pixelsize_um</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span></div>


<span class="c1"># TODO TODO option to only show name for focus_roi (like betty wanted)</span>
<span class="c1"># (and maybe offset so it&#39;s above actual response. option to configure this?)</span>
<span class="c1">#</span>
<span class="c1"># TODO also try just coloring focus_roi and not showing name for anything</span>
<span class="c1"># (tried it. OK, but now kinda wanting thicker lines on focus one?)</span>
<span class="c1">#</span>
<span class="c1"># TODO type alias for Dict[str, Any] (maybe KWArgs?)?</span>
<span class="c1"># TODO unit test (that at least it produces a figure without failing for</span>
<span class="c1"># correctly-formatted DataArray input)</span>
<span class="c1"># TODO support similarly-indexed DataArray for background (+ maybe remove ndarray code)</span>
<span class="c1"># TODO should background be optional (probably...)?</span>
<span class="c1"># TODO refactor scale_per_plane/minmax_clip_frac handling to just use defaults from</span>
<span class="c1"># image_grid?</span>
<span class="c1"># TODO see fig 4 in https://www.sciencedirect.com/science/article/pii/S096098222301285X</span>
<span class="c1"># for some ideas (about colorscale / use of color / other aesthetic choices)</span>
<span class="c1"># TODO TODO option for plotting dotted outline around whole AL (per plane, perhaps</span>
<span class="c1"># specified as sam&#39;s plane&lt;n&gt; ROIs) (like in paper above, tho seen before)</span>
<span class="c1"># TODO TODO also include A/P L/M axis arrows in plot (or option to)</span>
<span class="c1"># TODO maybe include (D&lt;-&gt;V in/near titles that have depths?)</span>
<span class="c1"># TODO TODO TODO move depth into top left of each image</span>
<span class="c1"># TODO type i can use to type hint colors (what does seaborn do?). use for</span>
<span class="c1"># color/focus_roi_color/palette/etc.</span>
<span class="c1"># TODO delete seed? only used before shuffling, and not sure i really want to shuffle at</span>
<span class="c1"># all...</span>
<div class="viewcode-block" id="plot_rois"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_rois">[docs]</a><span class="k">def</span> <span class="nf">plot_rois</span><span class="p">(</span><span class="n">rois</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">background</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
    <span class="n">certain_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">best_planes_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">show_names</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">focus_roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">focus_roi_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
    <span class="n">focus_roi_linewidth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">palette_desat</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
    <span class="n">scalebar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pixelsize_um</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scalebar_kws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">image_kws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zstep_um</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">depth_text_kws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title_kws</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">_pad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zero_outside_plane_outlines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plane_outline_line_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
    <span class="c1"># TODO doc whether palette can be a dict (str -&gt; color) (yea, right?) anything else?</span>
    <span class="c1"># TODO use color= kwarg in making &#39;ijroi/with_focusroi&#39; variant (/similar) in</span>
    <span class="c1"># al_analysis</span>
    <span class="c1">#</span>
    <span class="c1"># TODO add kwargs to position scalebar? kws param for scalebar?</span>
    <span class="c1"># just kws + something to pick between first/last axes to draw it on?</span>
    <span class="c1"># TODO rename &#39;depth_text_kws&#39; (+ maybe also &#39;micrometer_depth_title&#39;) to</span>
    <span class="c1"># &#39;zlabel_kws&#39; or something?</span>
    <span class="c1">#</span>
    <span class="c1"># TODO rename label_outline* kws in plot_closed_contours to name_outline* instead,</span>
    <span class="c1"># and then just handle here via kwargs (ideally also rename `label` there to `name`,</span>
    <span class="c1"># but may need to refactor some other stuff if so)</span>
    <span class="c1"># (handling via kwargs now anyway, but i don&#39;t love the &#39;label&#39; vs &#39;name&#39; in param</span>
    <span class="c1"># names)</span>
    <span class="c1"># TODO refactor default plane outline kwargs, so defaults can also be mentioned in</span>
    <span class="c1"># plane_outline_line_kws doc here</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        rois: with dims (&#39;roi&#39;, &#39;z&#39;, &#39;y&#39;, &#39;x&#39;). coords must have at least</span>
<span class="sd">            (&#39;roi_z&#39;, &#39;roi_name&#39;) on the &#39;roi&#39; dimension.</span>

<span class="sd">        background: must have shape equal to the (&lt;z&gt;, &lt;y&gt;, &lt;x&gt;) lengths of the</span>
<span class="sd">            corresponding entries in `rois.sizes`</span>

<span class="sd">        certain_only: whether to only show ROIs whose names indicate certainty about</span>
<span class="sd">            their ID (see `roi.is_ijroi_certain`)</span>

<span class="sd">        best_planes_only: whether to only show best plane for each volumetric ROI.</span>
<span class="sd">            If True, requires input also has &#39;is_best_plane&#39; on &#39;roi&#39; dimension.</span>

<span class="sd">        show_names: whether to plot ROI names in the center of each ROI.</span>
<span class="sd">            `True`|`False`|`focus`.</span>

<span class="sd">        color: for coloring ROI labels/outlines. use either this or `palette`.</span>
<span class="sd">            this is never desaturated, like `palette` can be via `palette_desat`.</span>

<span class="sd">        palette: for coloring ROI labels/outlines. use either this or `color`.</span>

<span class="sd">        focus_roi_color: color to use when the ROI name matching `focus_roi` (if</span>
<span class="sd">            passed). set to `None` to color these ROIs no differently from others,</span>
<span class="sd">            where they will then also be desaturated by `palette_desat` (if set).</span>

<span class="sd">        palette_desat: desaturate each color in passed / generated `palette` color by</span>
<span class="sd">            this amount, except for any ROIs who name is that of `focus_roi` (if passed.</span>
<span class="sd">            see also `focus_roi_color` docs). if `focus_roi` not passed, still</span>
<span class="sd">            desaturate everything by this amount, for consistency. will not desaturate</span>
<span class="sd">            if color is specified via `color` kwarg instead of `palette`.</span>

<span class="sd">        scalebar: if True, will draw scalebar on first plane</span>
<span class="sd">            (must also pass `pixelsize_um`)</span>

<span class="sd">        pixelsize_um: for use drawing scalebar</span>

<span class="sd">        scalebar_kws: passed to `matplotlib_scalebar.scalebar.ScaleBar`</span>

<span class="sd">        zstep_um: if passed, axes titles will be added to indicate depth of each plane.</span>
<span class="sd">            no depth titles will be drawn if this is `None`.</span>

<span class="sd">        depth_text_kws: passed to `micrometer_depth_title` (if `zstep_um` is provided).</span>

<span class="sd">        title: will set as `suptitle` if passed</span>

<span class="sd">        title_kws: passed to `suptitle`. ignored if `title` not passed.</span>

<span class="sd">        image_kws: passed to `image_grid`, for plotting background(s)</span>

<span class="sd">        linewidth: linewidth for ROI outline</span>

<span class="sd">        zero_outside_plane_outlines: if True, and will zero the background outside ROIs</span>
<span class="sd">            matching `roi.is_ijroi_plane_outline` (assumed there is at most one per</span>
<span class="sd">            plane).</span>

<span class="sd">        plane_outline_line_kws: passed to `plot_closed_contours` for each ROI matching</span>
<span class="sd">            `roi.is_ijroi_plane_outline`. defaults specified internally (different from</span>
<span class="sd">            for regular ROIs).</span>

<span class="sd">        **kwargs: passed thru to `plot_closed_contours`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_plane_outline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">hong_roi</span><span class="o">.</span><span class="n">is_ijroi_plane_outline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rois</span><span class="o">.</span><span class="n">roi_name</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">plane_outlines</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="n">is_plane_outline</span><span class="p">)</span>
    <span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span> <span class="o">~</span> <span class="n">is_plane_outline</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">certain_only</span><span class="p">:</span>
        <span class="c1"># TODO replace w/ select_certain_rois (after adapting to work w/ DataArray</span>
        <span class="c1"># input)</span>
        <span class="n">certain_rois</span> <span class="o">=</span> <span class="p">[</span><span class="n">hong_roi</span><span class="o">.</span><span class="n">is_ijroi_certain</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rois</span><span class="o">.</span><span class="n">roi_name</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="n">certain_rois</span><span class="p">)</span>
        <span class="c1">#</span>

    <span class="c1"># TODO also add options to just plot these diff (maybe brighter color / thicker</span>
    <span class="c1"># lines / only one with name shown / solid [/diff style] line?)</span>
    <span class="k">if</span> <span class="n">best_planes_only</span><span class="p">:</span>
        <span class="c1"># TODO catch error if is_best_plane not there -&gt; better error message</span>
        <span class="c1"># (about it being required if best_planes_only=True)</span>
        <span class="c1">#</span>
        <span class="c1"># didn&#39;t seem to matter whether I added .values to the end of sel arg</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="n">rois</span><span class="o">.</span><span class="n">is_best_plane</span><span class="p">)</span>

    <span class="c1"># TODO check rois and background have compatible shape?</span>
    <span class="c1"># leave to plot_closed_contours? it does some of that, right?</span>

    <span class="c1"># TODO warn/err if rois are empty here (after subsetting above)?</span>
    <span class="c1"># TODO warn/err (probably just warn) if focus_roi is not None and not in</span>
    <span class="c1"># rois.roi_name.values</span>
    <span class="c1"># TODO warn (def can&#39;t err) if focus_roi is passed and not in input ROIs?</span>

    <span class="k">assert</span> <span class="n">show_names</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;focus&#39;</span><span class="p">)</span>

    <span class="c1"># this is what plot_closed_contours takes, and may have used it in some inputs, but</span>
    <span class="c1"># those cases should now use color= instead</span>
    <span class="k">assert</span> <span class="s1">&#39;colors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span>

    <span class="k">if</span> <span class="n">palette</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># I think I generally like the way this looks better if it&#39;s a bit desaturated</span>
        <span class="c1">#</span>
        <span class="c1"># NOTE: intentionally making a hls palette w/ 10 colors before passing this to</span>
        <span class="c1"># another color_palette call below. hls doesn&#39;t wrap, but I liked it OK wrapped</span>
        <span class="c1"># at 10. some other cmaps might automatically wrap at 6-10 colors.</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s1">&#39;hls&#39;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># (already have colors=[&lt;color&gt;], but color=&lt;color&gt; would be simpler...)</span>
    <span class="n">roi_name2color</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">palette</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">roi_names</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">roi_name</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="c1"># TODO if we subset rois above, need to change this? not actually using this</span>
            <span class="c1"># branch now i don&#39;t think...</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">roi_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">palette</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c1"># Assuming all keys are proper colors.</span>
            <span class="n">roi_name2color</span> <span class="o">=</span> <span class="n">palette</span>

        <span class="c1"># this branch covers things like lists of colors (including sns.color_palette</span>
        <span class="c1"># output, which is actually a custom class, but seems to present like a list of</span>
        <span class="c1"># colors)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">roi_names</span><span class="p">))</span>

            <span class="c1"># TODO warn if # roi names is less than n_colors in input?</span>

            <span class="c1"># TODO warn if # rois &gt; 10 (i.e. we are cycling colors)? unless some flag is</span>
            <span class="c1"># set to suppress?</span>
            <span class="c1">#</span>
            <span class="c1"># If palette is a sequence (of colors), this call should leave it unchanged</span>
            <span class="c1"># (unless n_colors changes, where it should cycle).</span>
            <span class="c1">#</span>
            <span class="c1"># If input is another output of color_palette (or a shorter sequence of</span>
            <span class="c1"># colors), this will wrap it such that each ROI gets a color</span>
            <span class="c1"># (though not unique if # ROIs &gt; # colors).</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">roi_names</span><span class="p">))</span>

            <span class="c1"># just to show this output would not trigger the branch above</span>
            <span class="c1"># (that&#39;s for dict input)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi_names</span><span class="p">)</span>

            <span class="c1"># wanted a seeded random order w/o changing global seeds.</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">roi_names</span><span class="p">)</span>
            <span class="n">roi_name2color</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">roi_names</span><span class="p">,</span> <span class="n">palette</span><span class="p">))</span>

    <span class="k">del</span> <span class="n">palette</span>

    <span class="k">if</span> <span class="n">roi_name2color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="c1"># want to desaturate whether focus_rois is passed in or not, to keep colors</span>
        <span class="c1"># consistent (and i just liked the desaturated hls more than default).</span>
        <span class="c1">#</span>
        <span class="c1"># intentionally not doing this desat if input is color= (and not palette=, or</span>
        <span class="c1"># default palette generated if neither is passed)</span>
        <span class="k">if</span> <span class="n">palette_desat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">palette_desat</span> <span class="o">&lt;=</span> <span class="mi">1</span>
            <span class="n">roi_name2color</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># TODO just use desat arg to color_palette now?</span>
                <span class="c1"># (assuming focus roi color will always be passed in or else it will be</span>
                <span class="c1"># desat along with everything else)</span>
                <span class="n">n</span><span class="p">:</span> <span class="n">c</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">focus_roi</span> <span class="k">else</span> <span class="n">sns</span><span class="o">.</span><span class="n">desaturate</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">palette_desat</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">roi_name2color</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

    <span class="c1"># TODO option to [locally?] histogram equalize the image (or something else to</span>
    <span class="c1"># increase contrast + prevent hot pixels from screwing up range in a plane)</span>
    <span class="c1"># TODO option to &quot;equalize&quot; background image (see old code in plot_traces</span>
    <span class="c1"># show_footprints path)?</span>

    <span class="n">z_size</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

    <span class="c1"># TODO actually use (+ remove explicit kwargs here when possible)</span>
    <span class="n">image_grid_kwarg_names</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;nrows&#39;</span><span class="p">,</span> <span class="s1">&#39;ncols&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_per_plane&#39;</span><span class="p">,</span> <span class="s1">&#39;minmax_clip_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;vmin&#39;</span><span class="p">,</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;cbar&#39;</span><span class="p">,</span> <span class="s1">&#39;cbar_label&#39;</span><span class="p">,</span> <span class="s1">&#39;cbar_kws&#39;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">image_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># (so we don&#39;t modify input when adding keys from kwargs below)</span>
        <span class="n">image_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">image_kws</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">image_grid_kwarg_names</span><span class="p">:</span>
        <span class="c1"># (to let image_grid defaults come thru)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">image_kws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>


    <span class="n">z_with_outlines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">plane_outlines</span><span class="o">.</span><span class="n">roi_z</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_with_outlines</span><span class="p">)</span> <span class="o">==</span> <span class="n">plane_outlines</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">zero_outside_plane_outlines</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_with_outlines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">z_with_outlines</span><span class="p">):</span>
            <span class="c1"># should be fully False in the planes other than that where z==roi_z</span>
            <span class="n">outline_vol</span> <span class="o">=</span> <span class="n">plane_outlines</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">roi_z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>

            <span class="c1"># the .squeeze() is to collapse a length-1 &#39;roi&#39; dimension. may not need.</span>
            <span class="n">plane_outline</span> <span class="o">=</span> <span class="n">outline_vol</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">plane_outline</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">outline_vol</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># TODO TODO this type of assignment into background work?</span>
            <span class="c1">#</span>
            <span class="c1"># may not need the .values</span>
            <span class="n">background</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">background</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">*</span> <span class="n">plane_outline</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># TODO also support background being xarray, transposing z,y,x into place, if so</span>
    <span class="c1"># (or at least [/ in ndarray case], assert existing shape matches rois (z,y,x)</span>
    <span class="c1"># shape?)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">image_grid</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="o">**</span><span class="n">image_kws</span><span class="p">)</span>

    <span class="n">default_color_over_image</span> <span class="o">=</span> <span class="n">get_default_overlay_color</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">scalebar</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">pixelsize_um</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">scalebar_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scalebar_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># TODO add kwarg to select which?</span>
        <span class="c1"># TODO try ax=axs[-1] by default? (honestly probably less likely to hit</span>
        <span class="c1"># stuff in top plane (i.e. axs[0]). VL2p might be there-ish in bottom...)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">add_scalebar</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">pixelsize_um</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_color_over_image</span><span class="p">,</span> <span class="o">**</span><span class="n">scalebar_kws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">focus_roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">focus_roi_linewidth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">focus_roi_linewidth</span> <span class="o">=</span> <span class="n">linewidth</span>

    <span class="n">default_plane_outline_line_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
        <span class="c1"># TODO translate here OR don&#39;t in general kwarg linestyle-&gt;*s case,</span>
        <span class="c1"># for consistency (or move all translation into plot_closed*...)</span>
        <span class="c1"># TODO TODO make thicker on plots like certain_rois_on_avg.pdf</span>
        <span class="c1"># (via plane_outline_line_kws) or resize the entirety of those plots?</span>
        <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">plane_outline_line_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plane_outline_line_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plane_outline_line_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">plane_outline_line_kws</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_plane_outline_line_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plane_outline_line_kws</span><span class="p">:</span>
            <span class="n">plane_outline_line_kws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="c1"># TODO take any defaults from general **kwargs (the ones that other ROIs use)?</span>

    <span class="c1"># TODO replace above w/ rhs if assertion works</span>
    <span class="c1"># (and try to make similar replacement elsewhere!)</span>
    <span class="k">assert</span> <span class="n">plane_outline_line_kws</span> <span class="o">==</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">default_plane_outline_line_kws</span><span class="p">,</span> <span class="o">**</span><span class="n">plane_outline_line_kws</span>
    <span class="p">}</span>

    <span class="c1"># Moving &#39;roi&#39; from end to start.</span>
    <span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="n">err_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># TODO refactor to &quot;micrometer_depth_titleS&quot;, that loops over axes and does for each</span>
    <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">zstep_um</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">depth_text_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">depth_text_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">depth_text_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">depth_text_kws</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">depth_text_kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;as_overlay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">depth_text_kws</span><span class="p">):</span>

                <span class="n">depth_text_kws</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_color_over_image</span>

            <span class="c1"># TODO rename this fn to have title-&gt;text (since may want to burn in)</span>
            <span class="c1"># (or do outside this fn?)</span>
            <span class="n">micrometer_depth_title</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">zstep_um</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">depth_text_kws</span><span class="p">)</span>

        <span class="c1"># TODO fix! (what is issue? any times where we get KeyError when we</span>
        <span class="c1"># actually had a plane outline ROI for that plane? delete comment?)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plane_outline</span> <span class="o">=</span> <span class="n">plane_outlines</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">roi_z</span><span class="o">=</span><span class="n">z</span><span class="p">)[</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="c1"># TODO TODO refactor to not have this inside try block. it&#39;s itself like to</span>
            <span class="c1"># raise errors...</span>
            <span class="c1">#</span>
            <span class="c1"># just naively assuming these ROIs won&#39;t trigger same exceptions as</span>
            <span class="c1"># plot_closed_contours call below. that&#39;s probably not true in general, and</span>
            <span class="c1"># will just need to copy try/except structure from there.</span>
            <span class="n">plot_closed_contours</span><span class="p">(</span><span class="n">plane_outline</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">_pad</span><span class="o">=</span><span class="n">_pad</span><span class="p">,</span>
                <span class="o">**</span><span class="n">plane_outline_line_kws</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1">#import ipdb; ipdb.set_trace()</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rois_in_curr_z</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">roi_z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># TODO what if not all coordinates associated w/ this dimension are on</span>
        <span class="c1"># the index? if i make a solution to also handle that, put in hong2p.xarray</span>
        <span class="n">index_names</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s1">&#39;roi&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">names</span>

        <span class="c1"># Since the .sel operation above removes this coordinate.</span>
        <span class="n">index_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">index_names</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;roi_z&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois_in_curr_z</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>

            <span class="n">index_vals</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_vals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_names</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">index_names</span><span class="p">,</span> <span class="n">index_vals</span><span class="p">))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="s1">&#39;roi_name&#39;</span><span class="p">]</span>

            <span class="k">del</span> <span class="n">index</span><span class="p">,</span> <span class="n">index_vals</span>

            <span class="n">lw</span> <span class="o">=</span> <span class="n">linewidth</span>

            <span class="c1"># TODO move assertion above (/delete)</span>
            <span class="k">assert</span> <span class="n">roi_name2color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># NOTE: must be a single-element list if trying to specify one color with</span>
            <span class="c1"># any type other than a string (from matplotlib Axes.contour docs)&#39;</span>
            <span class="k">if</span> <span class="n">roi_name2color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_color</span> <span class="o">=</span> <span class="n">roi_name2color</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_color</span> <span class="o">=</span> <span class="n">color</span>

            <span class="k">if</span> <span class="n">show_names</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">show_name</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">show_names</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;focus&#39;</span><span class="p">):</span>
                <span class="n">show_name</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">focus_roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="n">focus_roi</span><span class="p">:</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="n">focus_roi_linewidth</span>

                <span class="k">if</span> <span class="n">focus_roi_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_color</span> <span class="o">=</span> <span class="n">focus_roi_color</span>

                <span class="k">if</span> <span class="n">show_names</span> <span class="o">==</span> <span class="s1">&#39;focus&#39;</span><span class="p">:</span>
                    <span class="n">show_name</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># since we make palette by default currently, we should always have color</span>
            <span class="c1"># defined</span>
            <span class="k">assert</span> <span class="n">_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># TODO TODO option to offset name (to draw just above ROI)</span>
                <span class="c1"># (can i specify &#39;above&#39; rather than some specific offset? use ROI bbox</span>
                <span class="c1"># in plot_closed_contours?)</span>

                <span class="c1"># TODO probably err, not warn, if this gets unknown kwargs</span>
                <span class="c1"># (it&#39;s currently seaborn doing the warning, right?)</span>
                <span class="n">plot_closed_contours</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span> <span class="k">if</span> <span class="n">show_name</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">_pad</span><span class="o">=</span><span class="n">_pad</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">_color</span><span class="p">],</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># +1 to index as in ImageJ</span>
                <span class="n">curr_err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> (z=</span><span class="si">{</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">): </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">err_msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="n">curr_err_msg</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">curr_err_msg</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="p">(</span><span class="n">z_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="c1"># TODO factor into image_grid, to handle the layout there?</span>
    <span class="c1"># TODO same for colorbar?</span>
    <span class="c1"># (image_grid is currently picking figsize based on image dims, but this doesn&#39;t</span>
    <span class="c1"># account for colorbar / suptitle / anything else)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO some other way to anchor suptitle (or text in general, maybe), to axes</span>
        <span class="c1"># positions? current way kinda hacky... (and requires title to be added ~last)</span>

        <span class="c1"># NOTE: we need this before loop dealing with axes positions below (at least if</span>
        <span class="c1"># layout is some type of constrained layout), because this will determine axes</span>
        <span class="c1"># positions (which i don&#39;t think should change left/right after adding suptitle)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="c1"># don&#39;t seem to need fig.set_layout_engine(&#39;none&#39;) before placing title</span>
        <span class="c1"># (to disable constrained layout)</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
            <span class="c1"># get_images: &quot;return a list of AxesImages contained by the Axes.&quot;</span>
            <span class="c1"># using to separate Axes with images from the colorbar axes</span>
            <span class="c1"># (which may also have been added in image_grid)</span>
            <span class="n">n_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_images</span><span class="p">())</span>

            <span class="k">assert</span> <span class="n">n_images</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_images</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">pos</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">xmin</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">xmax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">xmax</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">xmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">title_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">title_kws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<span class="c1"># TODO should i actually compute correlations in here too? check input, and</span>
<span class="c1"># compute if input wasn&#39;t correlations (/ symmetric?)?</span>
<span class="c1"># if so, probably return them as well.</span>
<div class="viewcode-block" id="plot_odor_corrs"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_odor_corrs">[docs]</a><span class="k">def</span> <span class="nf">plot_odor_corrs</span><span class="p">(</span><span class="n">corr_df</span><span class="p">,</span> <span class="n">odor_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">odors_in_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">trial_stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">title_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a symmetric DataFrame with odor x odor correlations and plots it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO replace ordering stuff w/ new fns for that in olf.py (or maybe just delete</span>
    <span class="c1"># all of plot_odor_corrs if not using...)</span>

    <span class="c1"># TODO test this fn w/ possible missing data case.</span>
    <span class="c1"># bring guis support for that in here?</span>
    <span class="k">if</span> <span class="n">odors_in_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">odor_order</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">odor_order</span><span class="p">:</span>
        <span class="c1"># &#39;name2&#39; is just olf.NO_ODOR for a lot of my data</span>
        <span class="c1"># (the non-pair stuff)</span>
        <span class="n">name_prefix</span> <span class="o">=</span> <span class="s1">&#39;name1&#39;</span>

        <span class="c1"># TODO probably refactor the two duped things below</span>
        <span class="n">odor_name_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name_prefix</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">odor_name_rows</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;expected the name of exactly one index level to &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;start with </span><span class="si">{</span><span class="n">name_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="n">odor_name_row</span> <span class="o">=</span> <span class="n">odor_name_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">odor_name_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name_prefix</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">odor_name_cols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;expected the name of exactly one column level to &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;start with </span><span class="si">{</span><span class="n">name_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="n">odor_name_col</span> <span class="o">=</span> <span class="n">odor_name_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="c1"># Necessary to avoid this error:</span>
            <span class="c1"># KeyError: &#39;Requested level...does not match index name (None)&#39;</span>
            <span class="n">odor_name_row</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">odor_name_col</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">corr_df</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">odors_in_order</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">odor_name_row</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">odors_in_order</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">odor_name_col</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">odors_in_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="s1">&#39;group_ticklabels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;group_ticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">corr_df</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Odor&#39;</span> <span class="k">if</span> <span class="n">odor_order</span> <span class="k">else</span> <span class="s1">&#39;Presentation&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; order&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">title_suffix</span>

    <span class="k">if</span> <span class="s1">&#39;ticklabels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ticklabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">format_mixture</span>

    <span class="k">if</span> <span class="s1">&#39;cbar_label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># TODO factor out latex for delta f / f stuff (+ maybe use in analysis that uses</span>
        <span class="c1"># this pkg: kc_natural_mixes, al_analysis)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cbar_label&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">trial_stat</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; response </span><span class="si">{</span><span class="n">dff_latex</span><span class="si">}</span><span class="s1"> correlation&#39;</span>

    <span class="k">return</span> <span class="n">matshow</span><span class="p">(</span><span class="n">corr_df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># TODO get x / y from whether they were declared share&lt;x/y&gt; in facetgrid</span>
<span class="c1"># creation?</span>
<span class="c1"># TODO TODO rename to something like &quot;hide_all_but_first_axes_label&quot; -&gt; accept fig input</span>
<span class="c1"># TODO also support hiding all but first xticklabels/similar? or make similar fns for</span>
<span class="c1"># that?</span>
<div class="viewcode-block" id="fix_facetgrid_axis_labels"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.fix_facetgrid_axis_labels">[docs]</a><span class="k">def</span> <span class="nf">fix_facetgrid_axis_labels</span><span class="p">(</span><span class="n">facet_grid</span><span class="p">,</span> <span class="n">shared_in_center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Modifies a FacetGrid to not duplicate X and Y axis text labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># regarding the choice of shared_in_center: WWMDD?</span>
    <span class="k">if</span> <span class="n">shared_in_center</span><span class="p">:</span>
        <span class="c1"># TODO maybe add a axes over / under the FacetGrid axes, with the same</span>
        <span class="c1"># shape, and label that one (i think i did this in my gui or one of the</span>
        <span class="c1"># plotting fns. maybe plot_traces?)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">facet_grid</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="c1"># why did i get a deprecation warning for this ax.is_first_col() in 3.4.3</span>
            <span class="c1"># (in my local recreation of remy_suite2p) but not in 3.5.1 (suite2p) which</span>
            <span class="c1"># i was testing with earlier?</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_subplotspec</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">is_first_col</span><span class="p">()</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">is_last_row</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">y</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_facetgrid_legend"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.set_facetgrid_legend">[docs]</a><span class="k">def</span> <span class="nf">set_facetgrid_legend</span><span class="p">(</span><span class="n">facet_grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In cases where different axes have different subsets of the hue levels,</span>
<span class="sd">    the legend may not contain the artists for the union of hue levels across</span>
<span class="sd">    all axes. This sets a legend from the hue artists across all axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#from matplotlib.collections import PathCollection</span>
    <span class="n">legend_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">facet_grid</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">):</span>
            <span class="c1">#if type(h) is PathCollection:</span>
            <span class="c1"># From inspecting facet_grid._legend_data in cases where some labels</span>
            <span class="c1"># pointed to empty lines (the phenotype in the case where things</span>
            <span class="c1"># weren&#39;t behaving as I wanted), the empty lines had this empty</span>
            <span class="c1"># facecolor.</span>
            <span class="n">facecolor</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">facecolor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1">#else:</span>
            <span class="c1">#    print(type(h))</span>
            <span class="c1">#    import ipdb; ipdb.set_trace()</span>

            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_data</span><span class="p">:</span>
                <span class="c1"># TODO maybe assert a wide variety of properties of the</span>
                <span class="c1"># matplotlib.collections.PathCollection objects are the same</span>
                <span class="c1"># (line width, dash, etc)</span>
                <span class="n">past_facecolor</span> <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">()</span>
                <span class="c1"># TODO TODO TODO fix! this is failing again 2020-08-25</span>
                <span class="c1"># (after re-installing requirements.txt, when running</span>
                <span class="c1"># kc_mix_analysis.py w/ no just -j arg)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">past_facecolor</span><span class="p">),</span> \
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">facecolor</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">past_facecolor</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">legend_data</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>

    <span class="n">facet_grid</span><span class="o">.</span><span class="n">add_legend</span><span class="p">(</span><span class="n">legend_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># TODO generalize / move to project specific repo</span>
<div class="viewcode-block" id="plot_traces"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_traces">[docs]</a><span class="k">def</span> <span class="nf">plot_traces</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">footprints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;odors&#39;</span><span class="p">,</span> <span class="n">scale_within</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_calls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">smoothed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_footprints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_footprints_alone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_cell_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_footprint_with_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gridspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># TODO TODO be clear on requirements of df and cell_ids in docstring</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    n (int): (default=20) Number of cells to plot traces for if cell_ids not</span>
<span class="sd">        passed as second positional argument.</span>
<span class="sd">    random (bool): (default=False) Whether the `n` cell ids should be selected</span>
<span class="sd">        randomly. If False, the first `n` cells are used.</span>
<span class="sd">    order_by (str): &#39;odors&#39; or &#39;presentation_order&#39;</span>
<span class="sd">    scale_within (str): &#39;none&#39;, &#39;cell&#39;, or &#39;trial&#39;</span>
<span class="sd">    gridspec (None or matplotlib.gridspec.*): region of a parent figure</span>
<span class="sd">        to draw this plot on.</span>
<span class="sd">    linewidth (float): 0.25 seemed ok on CNMF data, but too small w/ clean</span>
<span class="sd">    traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">tifffile</span>
    <span class="kn">import</span> <span class="nn">cv2</span>
    <span class="c1"># TODO maybe use cv2 and get rid of this dep?</span>
    <span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">color</span>

    <span class="c1"># TODO make text size and the spacing of everything more invariant to figure</span>
    <span class="c1"># size. i think the default size of this figure ended up being bigger when i</span>
    <span class="c1"># was using it in kc_analysis than it is now in the gui, so it isn&#39;t display</span>
    <span class="c1"># well in the gui, but fixing it here might break it in the kc_analysis case</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Entering plot_traces...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># TODO flag to also subset to responders first?</span>
        <span class="n">all_cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cells</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
            <span class="c1"># TODO maybe flag to disable seed?</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">all_cells</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">all_cells</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must call with either df or df and cells&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="c1"># or maybe just download (just the required!) footprints from sql?</span>
        <span class="k">if</span> <span class="n">footprints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must pass footprints kwarg if show_footprints&#39;</span><span class="p">)</span>
        <span class="c1"># decide whether this should be in the preconditions or just done here</span>
        <span class="c1"># (any harm to just do here anyway?)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    footprints = footprints.set_index(recording_cols + [&#39;cell&#39;])</span>

    <span class="c1"># TODO TODO TODO fix odor labels as in matrix (this already done?)</span>
    <span class="c1"># (either rotate or use abbreviations so they don&#39;t overlap!)</span>

    <span class="c1"># TODO check order_by and scale_within are correct</span>
    <span class="k">assert</span> <span class="n">raw</span> <span class="ow">or</span> <span class="n">smoothed</span>

    <span class="c1"># TODO maybe automatically show_cells if show_footprints is true,</span>
    <span class="c1"># otherwise don&#39;t?</span>
    <span class="c1"># TODO TODO maybe indicate somehow the multiple response criteria</span>
    <span class="c1"># when it is a list (add border &amp; color each half accordingly?)</span>

    <span class="n">extra_cols</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># TODO which of these cases do i want to support here?</span>
    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show_footprints_alone</span><span class="p">:</span>
            <span class="n">extra_cols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_cols</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">show_footprints_alone</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># TODO possibility of other column for avg + roi overlays</span>
    <span class="c1"># possible to make it larger, or should i use a layout other than</span>
    <span class="c1"># gridspec? just give it more grid elements?</span>
    <span class="c1"># TODO for combinatorial combinations of flags enabling cols on</span>
    <span class="c1"># right, maybe set index for each of those flags up here</span>

    <span class="c1"># TODO could also just could # trials w/ drop_duplicates, for more</span>
    <span class="c1"># generality</span>
    <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">n_expected_repeats</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_repeats</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;name1&#39;</span><span class="p">,</span><span class="s1">&#39;name2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">gridspec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This seems to hang... not sure if it&#39;s usable w/ some changes.</span>
        <span class="c1">#fig = plt.figure(constrained_layout=True)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">made_fig</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">get_topmost_subplotspec</span><span class="p">()</span><span class="o">.</span><span class="n">get_gridspec</span><span class="p">()</span><span class="o">.</span><span class="n">figure</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">made_fig</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="n">trace_gs_slice</span> <span class="o">=</span> <span class="n">gs</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trace_gs_slice</span> <span class="o">=</span> <span class="n">gs</span><span class="p">[:,:]</span>

    <span class="c1"># For common X/Y labels</span>
    <span class="n">bax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">trace_gs_slice</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># hide tick and tick label of the big axes</span>
    <span class="n">bax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">bax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">trace_gs</span> <span class="o">=</span> <span class="n">trace_gs_slice</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span>
        <span class="n">n_trials</span> <span class="o">+</span> <span class="n">extra_cols</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.06</span><span class="p">)</span>

    <span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trace_gs</span><span class="o">.</span><span class="n">_nrows</span><span class="p">):</span>
        <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">tj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trace_gs</span><span class="o">.</span><span class="n">_ncols</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">trace_gs</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span><span class="n">tj</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>

    <span class="c1"># TODO want all of these behind show_footprints?</span>
    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="c1"># TODO use 2/3 for widgets?</span>
        <span class="c1"># TODO or just text saying which keys to press? (if only</span>
        <span class="c1"># selection mechanism is going to be hover, mouse clicks</span>
        <span class="c1"># wouldn&#39;t make sense...)</span>

        <span class="n">avg_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
        <span class="c1"># TODO TODO maybe show trial movie beneath this?</span>
        <span class="c1"># (also on hover/click like (trial,cell) data)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#pad = 40</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="c1"># was also using default fontsize here in kc_analysis use case</span>
        <span class="c1"># increment pad by 5 for each newline in title?</span>
        <span class="n">bax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

    <span class="n">bax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cell&#39;</span><span class="p">)</span>

    <span class="c1"># This pad is to make it not overlap w/ time label on example plot.</span>
    <span class="c1"># Was left to default value for kc_analysis.</span>
    <span class="c1"># TODO negative labelpad work? might get drawn over by axes?</span>
    <span class="n">labelpad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
    <span class="k">if</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;odors&#39;</span><span class="p">:</span>
        <span class="n">bax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trials ordered by odor&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;presentation_order&#39;</span><span class="p">:</span>
        <span class="n">bax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trials in presentation order&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">)</span>

    <span class="n">ordering</span> <span class="o">=</span> <span class="n">pair_ordering</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    display_start_time = -3.0</span>
<span class="sd">    display_stop_time = 10</span>
<span class="sd">    display_window = df[</span>
<span class="sd">        (comparison_df.from_onset &gt;= display_start_time) &amp;</span>
<span class="sd">        (comparison_df.from_onset &lt;= display_stop_time)]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">display_window</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">smoothing_window_secs</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="n">thor</span><span class="o">.</span><span class="n">fps_from_thor</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">smoothing_window_secs</span> <span class="o">*</span> <span class="n">fps</span><span class="p">))</span>

    <span class="n">group_cols</span> <span class="o">=</span> <span class="n">trial_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>

    <span class="n">xmargin</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">display_window</span><span class="o">.</span><span class="n">from_onset</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">xmargin</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">display_window</span><span class="o">.</span><span class="n">from_onset</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">xmargin</span>

    <span class="n">response_rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">nonresponse_rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">response_call_alpha</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cell2contour</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">cell2rect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">cell2text_and_rect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">seen_ij</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plotting cell </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)))</span>

        <span class="n">cell_data</span> <span class="o">=</span> <span class="n">display_window</span><span class="p">[</span><span class="n">display_window</span><span class="o">.</span><span class="n">cell</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">]</span>
        <span class="n">cell_trials</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
            <span class="p">[</span><span class="s1">&#39;from_onset&#39;</span><span class="p">,</span><span class="s1">&#39;df_over_f&#39;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">prep_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">cell_data</span><span class="o">.</span><span class="n">prep_date</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">date_dir</span> <span class="o">=</span> <span class="n">prep_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_fmt_str</span><span class="p">)</span>
        <span class="n">fly_num</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">fly_num</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">thorimage_id</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">thorimage_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#assert len(cell_trials) == axs.shape[1]</span>

        <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">avg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># only uncomment to support dff images and other stuff like that</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                try:</span>
<span class="sd">                    # TODO either put in docstring that datetime.datetime is</span>
<span class="sd">                    # required, or cast input date as appropriate</span>
<span class="sd">                    # (does pandas date type support strftime?)</span>
<span class="sd">                    # or just pass date_dir?</span>
<span class="sd">                    # TODO TODO should not use nr if going to end up using the</span>
<span class="sd">                    # rig avg... but maybe lean towards computing the avg in</span>
<span class="sd">                    # that case rather than deferring to rigid?</span>
<span class="sd">                    tif = motion_corrected_tiff_filename(</span>
<span class="sd">                        prep_date, fly_num, thorimage_id</span>
<span class="sd">                    )</span>
<span class="sd">                except IOError as e:</span>
<span class="sd">                    if verbose:</span>
<span class="sd">                        print(e)</span>
<span class="sd">                    continue</span>

<span class="sd">                # TODO maybe show progress bar / notify on this step</span>
<span class="sd">                if verbose:</span>
<span class="sd">                    print(&#39;Loading full movie from {} ...&#39;.format(tif),</span>
<span class="sd">                        end=&#39;&#39;, flush=True</span>
<span class="sd">                    )</span>
<span class="sd">                movie = tifffile.imread(tif)</span>
<span class="sd">                if verbose:</span>
<span class="sd">                    print(&#39; done.&#39;)</span>
<span class="sd">                &#39;&#39;&#39;</span>

                <span class="c1"># TODO modify motion_corrected_tiff_filename to work in this</span>
                <span class="c1"># case too?</span>
                <span class="n">tif_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">analysis_output_root</span><span class="p">(),</span> <span class="n">date_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fly_num</span><span class="p">),</span>
                    <span class="s1">&#39;tif_stacks&#39;</span>
                <span class="p">)</span>
                <span class="n">avg_nr_tif</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">,</span> <span class="s1">&#39;AVG&#39;</span><span class="p">,</span> <span class="s1">&#39;nonrigid&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;AVG</span><span class="si">{}</span><span class="s1">_nr.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thorimage_id</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">avg_rig_tif</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">,</span> <span class="s1">&#39;AVG&#39;</span><span class="p">,</span> <span class="s1">&#39;rigid&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;AVG</span><span class="si">{}</span><span class="s1">_rig.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thorimage_id</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">avg_tif</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">avg_nr_tif</span><span class="p">):</span>
                    <span class="n">avg_tif</span> <span class="o">=</span> <span class="n">avg_nr_tif</span>
                <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">avg_rig_tif</span><span class="p">):</span>
                    <span class="n">avg_tif</span> <span class="o">=</span> <span class="n">avg_rig_tif</span>

                <span class="k">if</span> <span class="n">avg_tif</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">((</span><span class="s1">&#39;No average motion corrected TIFs &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;found in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tif_dir</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">avg</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">avg_tif</span><span class="p">)</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                avg = cv2.normalize(avg, None, alpha=0, beta=1,</span>
<span class="sd">                    norm_type=cv2.NORM_MINMAX, dtype=cv2.CV_32F</span>
<span class="sd">                )</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="c1"># TODO find a way to histogram equalize w/o converting</span>
                <span class="c1"># to 8 bit?</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                    <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_8UC1</span>
                <span class="p">)</span>
                <span class="n">better_constrast</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>

                <span class="n">rgb_avg</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">gray2rgb</span><span class="p">(</span><span class="n">better_constrast</span><span class="p">)</span>

            <span class="n">cell_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">prep_date</span><span class="p">,</span> <span class="n">fly_num</span><span class="p">,</span> <span class="n">thorimage_id</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">)</span>
            <span class="n">footprint_row</span> <span class="o">=</span> <span class="n">footprints</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_row</span><span class="p">]</span>

            <span class="c1"># TODO TODO TODO probably need to transpose how footprint is handled</span>
            <span class="c1"># downstream (would prefer not to transpose footprint though)</span>
            <span class="c1"># (as i had to switch x_coords and y_coords in db as they were</span>
            <span class="c1"># initially entered swapped)</span>
            <span class="n">footprint</span> <span class="o">=</span> <span class="n">hong_roi</span><span class="o">.</span><span class="n">db_row2footprint</span><span class="p">(</span><span class="n">footprint_row</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">avg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="c1"># TODO maybe some percentile / fixed size about maximum</span>
            <span class="c1"># density?</span>
            <span class="n">cropped_footprint</span><span class="p">,</span> <span class="p">((</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">))</span> <span class="o">=</span> \
                <span class="n">hong_roi</span><span class="o">.</span><span class="n">crop_to_nonzero</span><span class="p">(</span><span class="n">footprint</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

            <span class="n">cell2rect</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

            <span class="n">cropped_avg</span> <span class="o">=</span> <span class="n">better_constrast</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">show_footprint_with_mask</span><span class="p">:</span>
                <span class="c1"># TODO figure out how to suppress clipping warning in the case</span>
                <span class="c1"># when it&#39;s just because of float imprecision (e.g. 1.0000001</span>
                <span class="c1"># being clipped to 1) maybe just normalize to [0 + epsilon, 1 -</span>
                <span class="c1"># epsilon]?</span>
                <span class="c1"># TODO TODO or just set one channel to be this</span>
                <span class="c1"># footprint?  scale first?</span>
                <span class="n">cropped_footprint_rgb</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">gray2rgb</span><span class="p">(</span><span class="n">cropped_footprint</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">cropped_footprint_rgb</span><span class="p">[:,:,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># TODO plot w/ value == 1 to test?</span>

                <span class="n">cropped_footprint_hsv</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">rgb2hsv</span><span class="p">(</span><span class="n">cropped_footprint_rgb</span><span class="p">)</span>

                <span class="n">cropped_avg_hsv</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">rgb2hsv</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">gray2rgb</span><span class="p">(</span><span class="n">cropped_avg</span><span class="p">))</span>

                <span class="c1"># TODO hue already seems to be constant at 0.0 (red?)</span>
                <span class="c1"># so maybe just directly set to red to avoid confusion?</span>
                <span class="n">cropped_avg_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_footprint_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span>
                <span class="n">cropped_avg_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_footprint_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span>

                <span class="n">composite</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">hsv2rgb</span><span class="p">(</span><span class="n">cropped_avg_hsv</span><span class="p">)</span>

                <span class="c1"># TODO TODO not sure this is preserving hue/sat range to</span>
                <span class="c1"># indicate how strong part of filter is</span>
                <span class="c1"># TODO figure out / find some way that would</span>
                <span class="c1"># TODO TODO maybe don&#39;t normalize within each ROI? might</span>
                <span class="c1"># screw up stuff relative to histogram equalized</span>
                <span class="c1"># version...</span>
                <span class="c1"># TODO TODO TODO still normalize w/in crop in contour</span>
                <span class="c1"># case?</span>
                <span class="n">composite</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">composite</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_32F</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO could also use something more than this</span>
                <span class="c1"># TODO TODO fix bug here. see 20190402_bug1.txt</span>
                <span class="c1"># TODO TODO where are all zero footprints coming from?</span>
                <span class="n">cropped_footprint_nonzero</span> <span class="o">=</span> <span class="n">cropped_footprint</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cropped_footprint_nonzero</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">level</span> <span class="o">=</span> <span class="n">cropped_footprint</span><span class="p">[</span><span class="n">cropped_footprint_nonzero</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">show_footprints_alone</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">f_ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">f_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cropped_footprint</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">DEFAULT_ANATOMICAL_CMAP</span><span class="p">)</span>
                <span class="n">f_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">show_footprint_with_mask</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">composite</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cropped_avg</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">DEFAULT_ANATOMICAL_CMAP</span><span class="p">)</span>
                <span class="c1"># TODO TODO also show any other contours in this rectangular ROI</span>
                <span class="c1"># in a diff color! (copy how gui does this)</span>
                <span class="n">cell2contour</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_closed_contours</span><span class="p">(</span><span class="n">cropped_footprint</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
                    <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span>
                <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">y_min</span><span class="p">,</span> <span class="n">x_min</span><span class="p">),</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
            <span class="p">)</span>
            <span class="n">cell2text_and_rect</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">cell_trial</span> <span class="ow">in</span> <span class="n">cell_trials</span><span class="p">:</span>
            <span class="c1">#(prep_date, fly_num, thorimage_id,</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">repeat_num</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>

            <span class="c1"># TODO TODO also support a &#39;fixed&#39; order that B wanted</span>
            <span class="c1"># (which should also include missing stuff[, again in gray,]</span>
            <span class="c1"># ideally)</span>
            <span class="k">if</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;odors&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">n_repeats</span> <span class="o">*</span> <span class="n">ordering</span><span class="p">[(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">)]</span> <span class="o">+</span> <span class="n">repeat_num</span>

            <span class="k">elif</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;presentation_order&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">order</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;supported orderings are &#39;odors&#39; and &quot;</span><span class="o">+</span>
                    <span class="s2">&quot;&#39;presentation_order&#39;&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;trial&#39;</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">assert</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_ij</span>
            <span class="n">seen_ij</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># So that events that get the axes can translate to cell /</span>
            <span class="c1"># trial information.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">cell_id</span> <span class="o">=</span> <span class="n">cell_id</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">trial_info</span> <span class="o">=</span> <span class="n">n</span>

            <span class="c1"># X and Y axis major tick label fontsizes.</span>
            <span class="c1"># Was left to default for kc_analysis.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

            <span class="n">trial_times</span> <span class="o">=</span> <span class="n">cell_trial</span><span class="p">[</span><span class="s1">&#39;from_onset&#39;</span><span class="p">]</span>

            <span class="c1"># TODO TODO why is *first* ea trial the one not shown, and</span>
            <span class="c1"># apparently the middle pfo trial</span>
            <span class="c1"># (was it not actually ordered by &#39;order&#39;/frame_num outside of</span>
            <span class="c1"># odor order???)</span>
            <span class="c1"># TODO TODO TODO why did this not seem to work? (or only for</span>
            <span class="c1"># 1/3.  the middle one. iaa.)</span>
            <span class="c1"># (and actually title is still hidden for ea and pfo trials</span>
            <span class="c1"># mentioned above, but numbers / ticks / box still there)</span>
            <span class="c1"># (above notes only apply to odor order case. presentation order</span>
            <span class="c1"># worked)</span>
            <span class="c1"># TODO and why is gray title over correct axes in odor order case,</span>
            <span class="c1"># but axes not displaying data are in wrong place?</span>
            <span class="c1"># TODO is cell_trial messed up?</span>

            <span class="c1"># Supports at least the case when there are missing odor</span>
            <span class="c1"># presentations at the end of the ~block.</span>
            <span class="n">missing_this_presentation</span> <span class="o">=</span> \
                <span class="n">trial_times</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">trial_times</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># TODO group in odors case as w/ matshow?</span>
                <span class="k">if</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;odors&#39;</span><span class="p">:</span>
                    <span class="n">trial_title</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">format_mixture</span><span class="p">({</span>
                        <span class="s1">&#39;name1&#39;</span><span class="p">:</span> <span class="n">o1</span><span class="p">,</span>
                        <span class="s1">&#39;name2&#39;</span><span class="p">:</span> <span class="n">o2</span><span class="p">,</span>
                    <span class="p">})</span>
                <span class="k">elif</span> <span class="n">order_by</span> <span class="o">==</span> <span class="s1">&#39;presentation_order&#39;</span><span class="p">:</span>
                    <span class="n">trial_title</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">format_mixture</span><span class="p">({</span>
                        <span class="s1">&#39;name1&#39;</span><span class="p">:</span> <span class="n">o1</span><span class="p">,</span>
                        <span class="s1">&#39;name2&#39;</span><span class="p">:</span> <span class="n">o2</span>
                    <span class="p">})</span>

                <span class="k">if</span> <span class="n">missing_this_presentation</span><span class="p">:</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">trial_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">tc</span><span class="p">)</span>
                <span class="c1"># TODO may also need to do tight_layout here...</span>
                <span class="c1"># it apply to these kinds of titles?</span>

            <span class="k">if</span> <span class="n">missing_this_presentation</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">trial_dff</span> <span class="o">=</span> <span class="n">cell_trial</span><span class="p">[</span><span class="s1">&#39;df_over_f&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">trial_dff</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trial_times</span><span class="p">,</span> <span class="n">trial_dff</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">smoothed</span><span class="p">:</span>
                <span class="c1"># TODO kwarg(s) to control smoothing?</span>
                <span class="n">sdff</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">trial_dff</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ymax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">sdff</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">sdff</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sdff</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sdff</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

                <span class="c1"># TODO TODO have plot_traces take kwargs to be passed to</span>
                <span class="c1"># plotting fn + delete separate linewidth</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trial_times</span><span class="p">,</span> <span class="n">sdff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

            <span class="c1"># TODO also / separately subsample?</span>

            <span class="k">if</span> <span class="n">response_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">was_a_response</span> <span class="o">=</span> \
                    <span class="n">response_calls</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">repeat_num</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">was_a_response</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">response_rgb</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">response_call_alpha</span><span class="p">,))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">nonresponse_rgb</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">response_call_alpha</span><span class="p">,))</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># want these centered on example plot or across all?</span>

                <span class="c1"># I had not specified fontsize for kc_analysis case, so whatever</span>
                <span class="c1"># the default value was probably worked OK there.</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Seconds from odor onset&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                    <span class="n">scaletext</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
                    <span class="n">scaletext</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Scaled within each cell&#39;</span>
                <span class="k">elif</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;trial&#39;</span><span class="p">:</span>
                    <span class="n">scaletext</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Scaled within each trial&#39;</span>

                <span class="c1"># TODO just change to &quot;% maximum w/in &lt;x&gt;&quot; or something?</span>
                <span class="c1"># Was 70 for kc_analysis case. That&#39;s much too high here.</span>
                <span class="c1">#labelpad = 70</span>
                <span class="n">labelpad</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="c1"># TODO factor out latex for delta f / f stuff</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\frac{\Delta F}</span><span class="si">{F}</span><span class="s1">$&#39;</span> <span class="o">+</span> <span class="n">scaletext</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span>
                <span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">show_cell_ids</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Indexes as they would be from one. For comparison</span>
                    <span class="c1"># w/ Remy&#39;s MATLAB analysis.</span>
                    <span class="c1"># This and default fontsize worked for kc_analysis case,</span>
                    <span class="c1"># not for GUI.</span>
                    <span class="c1">#labelpad = 18</span>
                    <span class="n">labelpad</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                    <span class="c1"># TODO put a label somewhere on the plot indicating</span>
                    <span class="c1"># these are cell IDs</span>

                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

        <span class="c1"># TODO change units in this case on ylabel?</span>
        <span class="c1"># (to reflect how it was scaled)</span>
        <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">r</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scale_within</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_footprints</span><span class="p">:</span>
        <span class="n">fly_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, fly </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">date_dir</span><span class="p">,</span> <span class="n">fly_num</span><span class="p">,</span> <span class="n">thorimage_id</span><span class="p">)</span>

        <span class="c1"># title like &#39;Recording average fluorescence&#39;?</span>
        <span class="c1">#avg_ax.set_title(fly_title)</span>
        <span class="n">avg_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb_avg</span><span class="p">)</span>
        <span class="n">avg_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="n">cell2rect_artists</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="c1"># TODO TODO fix bug that required this (zero nonzero pixel</span>
            <span class="c1"># in cropped footprint thing...)</span>
            <span class="k">if</span> <span class="n">cell_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cell2text_and_rect</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span> <span class="o">=</span> <span class="n">cell2text_and_rect</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span>

            <span class="n">box</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_bbox</span><span class="p">()</span>
            <span class="c1"># TODO appropriate font properties? placement still good?</span>
            <span class="c1"># This seemed to work be for (larger?) figures in kc_analysis,</span>
            <span class="c1"># too large + too close to boxes in gui (w/ ~8&quot;x5&quot; gridspec,dpi 100)</span>
            <span class="c1"># TODO set in relation to actual fig size (+ dpi?)</span>
            <span class="c1">#boxlabel_fontsize = 9</span>
            <span class="n">boxlabel_fontsize</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">text_artist</span> <span class="o">=</span> <span class="n">avg_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">ymin</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">boxlabel_fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span>
            <span class="p">)</span>
            <span class="c1"># TODO jitter somehow (w/ arrow pointing to box?) to ensure no</span>
            <span class="c1"># overlap? (this would be ideal, but probably hard to implement)</span>
            <span class="n">avg_ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

            <span class="n">cell2rect_artists</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">text_artist</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_trials</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">made_fig</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="showsync"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.showsync">[docs]</a><span class="k">def</span> <span class="nf">showsync</span><span class="p">(</span><span class="n">thorsync_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shows ThorSync .h5 data interactively, using `pyqtgraph`.</span>

<span class="sd">    Args:</span>
<span class="sd">        thorsync_dir: path to a directory created by ThorSync</span>
<span class="sd">        kwargs: passed through to `thor.load_thorsync_hdf5`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span>

    <span class="c1"># TODO TODO make it possible to click to toggle display of lines like in thorsync</span>
    <span class="c1"># itself</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">mkQApp</span><span class="p">()</span>

    <span class="n">before</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading HDF5...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">thor</span><span class="o">.</span><span class="n">load_thorsync_hdf5</span><span class="p">(</span><span class="n">thorsync_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">took_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">before</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;done (</span><span class="si">{</span><span class="n">took_s</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s)&#39;</span><span class="p">)</span>

    <span class="c1"># TODO set title to last 3 parts of path if parent two directories can be parsed as</span>
    <span class="c1"># (date, fly_num) (or if just under raw_data_root maybe?)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">thorsync_dir</span><span class="p">)</span>

    <span class="c1"># plot_widget if of type pyqtgraph.widgets.PlotWidget.PlotWidget</span>
    <span class="c1"># not really sure how &#39;all&#39; and &#39;pairs&#39; differ... (&#39;pairs&#39; skip some?)</span>
    <span class="c1"># TODO wanted to set clipToView=True and some other stuff here, but downsampling=100</span>
    <span class="c1"># didn&#39;t seem to work at all (unlike call below), so i&#39;m not sure anythere here</span>
    <span class="c1"># will.</span>
    <span class="n">plot_widget</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setLabels</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="s1">&#39;Seconds&#39;</span><span class="p">)</span>

    <span class="c1"># Passing `autoDownsample=True` to either the `plot` call above or those in the loop</span>
    <span class="c1"># below caused the startup time to increase beyond what is acceptable. Was also slow</span>
    <span class="c1"># after loading. Not sure why it only seems to work here.</span>
    <span class="c1">#plot_widget.setDownsampling(100)</span>
    <span class="c1"># TODO TODO could downsampling cause problems? how? maybe add cli flag to disable</span>
    <span class="c1"># it?</span>
    <span class="c1"># TODO TODO in `auto` case, is automatically selected factor changed when zooming?</span>
    <span class="c1"># (or would i (could i even?) need to link settting it to change in scale or</span>
    <span class="c1"># something?)</span>
    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setDownsampling</span><span class="p">(</span><span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Much snappier with this. Doesn&#39;t try to draw data out of bounds of view box.</span>
    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setClipToView</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># TODO set initial view box and / or build in margin such that legend is out of way</span>
    <span class="c1"># of traces immediately</span>

    <span class="n">plot_widget</span><span class="o">.</span><span class="n">addLegend</span><span class="p">()</span>

    <span class="n">time_col</span> <span class="o">=</span> <span class="n">thor</span><span class="o">.</span><span class="n">time_col</span>

    <span class="n">x_min</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">time_col</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="c1"># TODO maybe add a margin around this, but only if it can be made clear where the</span>
    <span class="c1"># region the data actually exists in is (not just black everywhere...)</span>
    <span class="n">plot_widget</span><span class="o">.</span><span class="n">setLimits</span><span class="p">(</span><span class="n">xMin</span><span class="o">=</span><span class="n">x_min</span><span class="p">,</span> <span class="n">xMax</span><span class="o">=</span><span class="n">x_max</span><span class="p">,</span> <span class="n">yMin</span><span class="o">=</span><span class="n">y_min</span><span class="p">,</span> <span class="n">yMax</span><span class="o">=</span><span class="n">y_max</span><span class="p">)</span>

    <span class="n">plot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">time_col</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;frame_counter&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not plotting frame_counter&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="c1"># Otherwise this produces an in error in pyqtgraph internals</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">))</span>

        <span class="c1"># TODO maybe store hardcoded map for colors for these?</span>
        <span class="c1"># not sure how consistent column order is as loaded from hdf5...</span>
        <span class="n">plot_widget</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">time_col</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">)))</span>

    <span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>


<span class="c1"># TODO maybe one fn that puts in matrix format and another in table</span>
<span class="c1"># (since matrix may be sparse...)</span>
<span class="c1"># TODO delete / move to project specific repo / generalize</span>
<span class="c1"># (currently only used in no-longer-used natural_odors/kc_analysis.py)</span>
<div class="viewcode-block" id="plot_pair_n"><a class="viewcode-back" href="../../apidoc/hong2p.viz.html#hong2p.viz.plot_pair_n">[docs]</a><span class="k">def</span> <span class="nf">plot_pair_n</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots a matrix of odor1 X odor2 w/ counts of flies as entries.</span>

<span class="sd">    Args:</span>
<span class="sd">    df (pd.DataFrame): DataFrame with columns:</span>
<span class="sd">        - prep_date</span>
<span class="sd">        - fly_num</span>
<span class="sd">        - thorimage_id</span>
<span class="sd">        - name1</span>
<span class="sd">        - name2</span>
<span class="sd">        Data already collected w/ odor pairs.</span>

<span class="sd">    odor_panel (pd.DataFrame): (optional) DataFrame with columns:</span>
<span class="sd">        - odor_1</span>
<span class="sd">        - odor_2</span>
<span class="sd">        - reason (maybe make this optional?)</span>
<span class="sd">        The odor pairs experiments are supposed to collect data for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">imgkit</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

    <span class="n">odor_panel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">odor_panel</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incorrect number of arguments&#39;</span><span class="p">)</span>
    <span class="c1"># TODO maybe make df optional and read from database if it&#39;s not passed?</span>
    <span class="c1"># TODO a flag to show all stuff marked attempt analysis in gsheet?</span>

    <span class="c1"># TODO borrow more of this / call this in part of kc_analysis that made that</span>
    <span class="c1"># table w/ these counts for repeats?</span>

    <span class="c1"># TODO also handle olf.NO_ODOR</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">name1</span> <span class="o">==</span> <span class="s1">&#39;paraffin&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">name2</span> <span class="o">==</span> <span class="s1">&#39;paraffin&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>

    <span class="c1"># TODO possible to do at least a partial check w/ n_accepted_blocks sum?</span>
    <span class="c1"># (would have to do outside of this fn. presentations here doesn&#39;t have it.</span>
    <span class="c1"># whatever latest_analysis returns might.)</span>

    <span class="n">replicates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;prep_date&#39;</span><span class="p">,</span><span class="s1">&#39;fly_num&#39;</span><span class="p">,</span><span class="s1">&#39;recording_from&#39;</span><span class="p">,</span><span class="s1">&#39;name1&#39;</span><span class="p">,</span><span class="s1">&#39;name2&#39;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># TODO do i actually want margins? (would currently count single odors twice</span>
    <span class="c1"># if in multiple comparison... may at least not want that?)</span>
    <span class="c1"># hide margins for now.</span>
    <span class="n">pair_n</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">replicates</span><span class="o">.</span><span class="n">name1</span><span class="p">,</span> <span class="n">replicates</span><span class="o">.</span><span class="n">name2</span><span class="p">)</span> <span class="c1">#, margins=True)</span>

    <span class="c1"># Making the rectangular matrix pair_n square</span>
    <span class="c1"># (same indexes on row and column axes)</span>

    <span class="k">if</span> <span class="n">odor_panel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This is basically equivalent to the logic in the branch below,</span>
        <span class="c1"># although the index is not defined separately here.</span>
        <span class="n">full_pair_n</span> <span class="o">=</span> <span class="n">pair_n</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">pair_n</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO [change odor&lt;n&gt; to / handle] name&lt;n&gt;, to be consistent w/ above</span>
        <span class="c1"># TODO TODO TODO also make this triangular / symmetric</span>
        <span class="n">odor_panel</span> <span class="o">=</span> <span class="n">odor_panel</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;odor_1&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;odor_2&#39;</span><span class="p">,</span>
            <span class="n">aggfunc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;reason&#39;</span><span class="p">)</span>

        <span class="n">full_panel_index</span> <span class="o">=</span> <span class="n">odor_panel</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">odor_panel</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">full_data_index</span> <span class="o">=</span> <span class="n">pair_n</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">pair_n</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">full_data_index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">full_panel_index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="c1"># TODO also check no pairs occur in data that are not in panel</span>
        <span class="c1"># TODO isin-like check for tuples (or other combinations of rows)?</span>
        <span class="c1"># just iterate over both after drop_duplicates?</span>

        <span class="n">full_pair_n</span> <span class="o">=</span> <span class="n">pair_n</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">full_panel_index</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">full_panel_index</span><span class="p">)</span>
        <span class="c1"># TODO maybe making symmetric is a matter of setting 0 to nan here?</span>
        <span class="c1"># and maybe setting back to nan at the end if still 0?</span>
        <span class="n">full_pair_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1"># TODO full_pair_n.fillna(0, inplace=True)?</span>

    <span class="c1"># TODO TODO delete this hack once i find a nicer way to make the</span>
    <span class="c1"># output of crosstab symmetric</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">elif</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">full_pair_n</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
    <span class="c1"># TODO also delete this hack. this assumes that anything set to 0</span>
    <span class="c1"># is not actually a pair in the panel (which should be true right now</span>
    <span class="c1"># but will not always be)</span>
    <span class="n">full_pair_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#</span>

    <span class="c1"># TODO TODO TODO make crosstab output actually symmetric, not just square</span>
    <span class="c1"># (or is it always one diagonal that&#39;s filled in? if so, really just need</span>
    <span class="c1"># that)</span>
    <span class="k">assert</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">full_pair_n</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># TODO TODO TODO how to indicate which of the pairs we are actually</span>
    <span class="c1"># interested in? grey out the others? white the others? (just set to nan?)</span>
    <span class="c1"># (maybe only use to grey / white out if passed in?)</span>
    <span class="c1"># (+ margins for now)</span>

    <span class="c1"># TODO TODO TODO color code text labels by pair selection reason + key</span>
    <span class="c1"># TODO what to do when one thing falls under two reasons though...?</span>
    <span class="c1"># just like a key (or things alongside ticklabels) that has each color</span>
    <span class="c1"># separately? just symbols in text, if that&#39;s easier?</span>

    <span class="c1"># TODO TODO display actual counts in squares in matshow</span>
    <span class="c1"># maybe make colorbar have discrete steps?</span>

    <span class="n">full_pair_n</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">light_palette</span><span class="p">(</span><span class="s1">&#39;seagreen&#39;</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># TODO TODO if i&#39;m going to continue using styler + imgkit</span>
    <span class="c1"># at least figure out how to get the cmap to actually work</span>
    <span class="c1"># need some css or something?</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">full_pair_n</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">background_gradient</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">imgkit</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;natural_odors_pair_n.png&#39;</span><span class="p">)</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Tom O&#39;Connell.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>